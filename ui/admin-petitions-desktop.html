<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeakUp! - Admin Petitions</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* Admin specific styles */
    .admin-header {
      background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      color: white;
      padding: 20px 0;
      margin-bottom: 32px;
    }
    
    .admin-badge {
      background: #38bdf8;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 12px;
    }
    
    .petition-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .petition-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .petition-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .petition-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
      flex: 1;
    }
    
    .petition-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-approved {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-published {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .petition-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
    }
    
    .meta-item {
      display: flex;
      flex-direction: column;
    }
    
    .meta-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .meta-value {
      font-size: 14px;
      color: #1f2937;
      font-weight: 500;
    }
    
    .petition-content {
      margin-bottom: 20px;
    }
    
    .content-section {
      margin-bottom: 16px;
    }
    
    .content-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .content-text {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #3b82f6;
    }
    
    .petition-files {
      margin-bottom: 20px;
    }
    
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    
    .file-item {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .file-item:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    
    .file-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .file-name {
      font-size: 12px;
      color: #374151;
      word-break: break-all;
    }
    
    .admin-actions {
      display: flex;
      gap: 12px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn-approve {
      background: #059669;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-approve:hover {
      background: #047857;
    }
    
    .btn-reject {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-reject:hover {
      background: #b91c1c;
    }
    
    .btn-view {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-view:hover {
      background: #2563eb;
    }
    
    .moderation-notes {
      margin-top: 16px;
    }
    
    .notes-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      resize: vertical;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .filters {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .filter-row {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .filter-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .filter-select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* File viewer modal styles */
    .file-viewer-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .file-viewer-content {
      background: white;
      border-radius: 12px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      position: relative;
    }
    
    .file-viewer-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9fafb;
    }
    
    .file-viewer-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
    }
    
    .file-viewer-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 4px;
    }
    
    .file-viewer-close:hover {
      color: #374151;
    }
    
    .file-viewer-body {
      padding: 20px;
      text-align: center;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .file-preview {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .file-download-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s ease;
    }
    
    .file-download-btn:hover {
      background: #2563eb;
    }
    
    .file-info {
      margin-top: 16px;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 6px;
      font-size: 14px;
      color: #4b5563;
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      color: white !important;
      font-weight: 500;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: #059669;
    }
    
    .notification.error {
      background: #dc2626;
    }
    
    .notification.warning {
      background: #d97706;
    }
  </style>
</head>
<body class="desktop-page">
  <div class="container">
    <!-- Header -->
    <header class="admin-header">
      <div class="container">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <img src="assets/logo/logo speak up white.png" alt="SpeakUp!" style="height: 40px; margin-right: 16px;">
            <h1 style="margin: 0; font-size: 24px;">Admin Panel</h1>
            <span class="admin-badge">ADMIN</span>
          </div>
          <nav class="flex items-center gap-6">
            <a href="desktop.html" class="text-white hover:text-gray-200" style="color: white !important;">üè† Home</a>
            <a href="admin-verified-badge-desktop.html" class="text-white hover:text-gray-200" style="color: white !important;">üèÜ Verified Badge</a>
            <a href="#" onclick="logout()" class="text-white hover:text-gray-200" style="color: white !important;">üö™ Logout</a>
          </nav>
        </div>
      </div>
    </header>

    <!-- Back Navigation -->
    <div class="container" style="margin-bottom: 24px;">
      <div class="flex items-center gap-4">
        <a href="desktop.html" class="btn ghost" style="display: inline-flex; align-items: center; gap: 8px;">
          <span>‚Üê</span>
          <span>Kembali ke Home</span>
        </a>
        <span style="color: #6b7280; font-size: 14px;">|</span>
        <span style="color: #6b7280; font-size: 14px;">Admin Panel - Moderasi Petisi</span>
      </div>
    </div>

    <!-- Main Content -->
    <main>
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalPetitions">-</div>
          <div class="stat-label">Total Petisi</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingPetitions">-</div>
          <div class="stat-label">Menunggu Review</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="approvedPetitions">-</div>
          <div class="stat-label">Disetujui</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="rejectedPetitions">-</div>
          <div class="stat-label">Ditolak</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label">Status</label>
            <select id="statusFilter" class="filter-select" title="Filter berdasarkan status">
              <option value="">Semua Status</option>
              <option value="pending">Pending</option>
              <option value="published">Published (Approved)</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Kategori</label>
            <select id="categoryFilter" class="filter-select" title="Filter berdasarkan kategori">
              <option value="">Semua Kategori</option>
              <option value="bullying">Bullying</option>
              <option value="workplace">Workplace</option>
              <option value="education">Education</option>
              <option value="health">Health</option>
              <option value="environment">Environment</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Tanggal</label>
            <select id="dateFilter" class="filter-select" title="Filter berdasarkan tanggal">
              <option value="">Semua Tanggal</option>
              <option value="today">Hari Ini</option>
              <option value="week">Minggu Ini</option>
              <option value="month">Bulan Ini</option>
            </select>
          </div>
          <button onclick="applyFilters()" class="btn primary">Terapkan Filter</button>
          <button onclick="clearFilters()" class="btn ghost">Reset</button>
          <button onclick="refreshData()" class="btn primary" style="background: #059669;">üîÑ Refresh Data</button>
          <button onclick="testDatabaseConnection()" class="btn ghost">üîç Test DB</button>
          <button onclick="showAllPetitions()" class="btn ghost">üìã Show All</button>
          <button onclick="viewPublishedPetitions()" class="btn primary" style="background: #3b82f6;">üåê View Public</button>
        </div>
      </div>

      <!-- Petitions List -->
      <div id="petitionsList">
        <div class="loading">
          <div>Memuat petisi...</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Moderation Modal -->
  <div id="moderationModal" class="modal" style="display: none;">
    <div class="box" style="max-width: 600px;">
      <h3 id="moderationTitle">Moderasi Petisi</h3>
      <div id="moderationContent"></div>
      <div class="moderation-notes">
        <label style="font-weight: 500; color: #374151; margin-bottom: 8px; display: block;">Catatan Moderasi</label>
        <textarea id="moderationNotes" class="notes-textarea" placeholder="Masukkan catatan untuk user..."></textarea>
      </div>
      <div class="actions-row" style="margin-top: 20px;">
        <button onclick="approvePetition()" class="btn-approve">‚úÖ Setujui</button>
        <button onclick="rejectPetition()" class="btn-reject">‚ùå Tolak</button>
        <button onclick="closeModerationModal()" class="btn ghost">Batal</button>
      </div>
    </div>
  </div>

  <script>
    let currentPetitionId = null;
    let allPetitions = [];

    // Check admin access
    async function checkAdminAccess() {
      try {
        const isLoggedIn = localStorage.getItem('speakup_logged_in');
        if (!isLoggedIn) {
          alert('Anda harus login terlebih dahulu.');
          window.location.href = './desktop.html';
          return false;
        }

        // Check if user is admin
        const supabase = window.getSupabase();
        if (!supabase) {
          alert('Supabase tidak tersedia.');
          return false;
        }

        const { data: { user }, error: userError } = await supabase.auth.getUser();
        console.log('Admin user check:', { user, userError });
        if (userError || !user) {
          alert('User tidak terautentikasi.');
          return false;
        }

        // Check admin role in profiles table
        console.log('Checking admin role for user:', user.id);
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        console.log('Profile check result:', { profile, profileError });
        if (profileError || !profile || profile.role !== 'admin') {
          console.log('Admin access denied:', { profileError, profile });
          alert('Akses ditolak. Hanya admin yang dapat mengakses halaman ini.');
          window.location.href = './desktop.html';
          return false;
        }
        
        console.log('Admin access granted for user:', user.id);

        return true;
      } catch (error) {
        console.error('Error checking admin access:', error);
        alert('Error checking admin access: ' + error.message);
        return false;
      }
    }

    // Load petitions
    async function loadPetitions() {
      try {
        const supabase = window.getSupabase();
        if (!supabase) {
          throw new Error('Supabase tidak tersedia');
        }

        console.log('Loading petitions from database...');
        const { data, error } = await supabase
          .from('petitions')
          .select(`
            id,
            title,
            description,
            category,
            target,
            solution,
            signature_target,
            status,
            moderation_notes,
            full_name,
            nik,
            phone,
            email,
            ktp_url,
            evidence_photos,
            evidence_video_url,
            documents_url,
            additional_info,
            digital_signature,
            created_at,
            updated_at,
            moderated_at
          `)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Database query error:', error);
          throw error;
        }

        console.log('Raw petitions data from database:', data);
        console.log('Number of petitions found:', data ? data.length : 0);
        
        allPetitions = data || [];
        
        // Log each petition for debugging
        allPetitions.forEach((petition, index) => {
          console.log(`Petition ${index + 1}:`, {
            id: petition.id,
            title: petition.title,
            status: petition.status,
            created_at: petition.created_at
          });
        });
        
        updateStats();
        renderPetitions(allPetitions);
      } catch (error) {
        console.error('Error loading petitions:', error);
        document.getElementById('petitionsList').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Error memuat petisi: ${error.message}</div>
          </div>
        `;
      }
    }

    // Update statistics
    function updateStats() {
      const total = allPetitions.length;
      const pending = allPetitions.filter(p => p.status === 'pending').length;
      const published = allPetitions.filter(p => p.status === 'published').length;
      const rejected = allPetitions.filter(p => p.status === 'rejected').length;

      document.getElementById('totalPetitions').textContent = total;
      document.getElementById('pendingPetitions').textContent = pending;
      document.getElementById('approvedPetitions').textContent = published; // Show published count as "approved"
      document.getElementById('rejectedPetitions').textContent = rejected;
    }

    // Render petitions
    function renderPetitions(petitions) {
      const container = document.getElementById('petitionsList');
      
      if (petitions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <div>Tidak ada petisi yang ditemukan</div>
          </div>
        `;
        return;
      }

      container.innerHTML = petitions.map(petition => `
        <div class="petition-card">
          <div class="petition-header">
            <h3 class="petition-title">${petition.title}</h3>
            <span class="petition-status status-${petition.status}">${petition.status === 'published' ? 'APPROVED' : petition.status.toUpperCase()}</span>
          </div>
          
          <div class="petition-meta">
            <div class="meta-item">
              <span class="meta-label">Pembuat</span>
              <span class="meta-value">${petition.full_name}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Kategori</span>
              <span class="meta-value">${petition.category}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Target</span>
              <span class="meta-value">${petition.target}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Dibuat</span>
              <span class="meta-value">${new Date(petition.created_at).toLocaleDateString('id-ID')}</span>
            </div>
          </div>

          <div class="petition-content">
            <div class="content-section">
              <div class="content-label">Deskripsi</div>
              <div class="content-text">${petition.description}</div>
            </div>
            <div class="content-section">
              <div class="content-label">Solusi yang Diharapkan</div>
              <div class="content-text">${petition.solution}</div>
            </div>
          </div>

          ${petition.ktp_url || petition.evidence_photos || petition.evidence_video_url || petition.documents_url ? `
            <div class="petition-files">
              <div class="content-label">File Pendukung</div>
              <div class="file-grid">
                ${petition.ktp_url ? `
                  <div class="file-item" onclick="viewFile('${petition.ktp_url}', 'KTP', 'image')" style="cursor: pointer;">
                    <div class="file-icon">üÜî</div>
                    <div class="file-name">KTP</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                  </div>
                ` : ''}
                ${petition.evidence_photos ? petition.evidence_photos.map((photo, index) => `
                  <div class="file-item" onclick="viewFile('${photo}', 'Foto Bukti ${index + 1}', 'image')" style="cursor: pointer;">
                    <div class="file-icon">üì∑</div>
                    <div class="file-name">Foto Bukti ${index + 1}</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                  </div>
                `).join('') : ''}
                ${petition.evidence_video_url ? `
                  <div class="file-item" onclick="viewFile('${petition.evidence_video_url}', 'Video Bukti', 'video')" style="cursor: pointer;">
                    <div class="file-icon">üé•</div>
                    <div class="file-name">Video Bukti</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                  </div>
                ` : ''}
                ${petition.documents_url ? petition.documents_url.map((doc, index) => `
                  <div class="file-item" onclick="viewFile('${doc}', 'Dokumen ${index + 1}', 'document')" style="cursor: pointer;">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-name">Dokumen ${index + 1}</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                  </div>
                `).join('') : ''}
              </div>
            </div>
          ` : ''}

          ${petition.moderation_notes ? `
            <div class="content-section">
              <div class="content-label">Catatan Moderasi</div>
              <div class="content-text">${petition.moderation_notes}</div>
            </div>
          ` : ''}

          <div class="admin-actions">
            <button onclick="viewPetition('${petition.id}')" class="btn-view">üëÅÔ∏è Lihat Detail</button>
            ${petition.status === 'pending' ? `
              <button onclick="openModerationModal('${petition.id}', 'approve')" class="btn-approve">‚úÖ Setujui</button>
              <button onclick="openModerationModal('${petition.id}', 'reject')" class="btn-reject">‚ùå Tolak</button>
              <button onclick="quickApprove('${petition.id}')" class="btn-approve" style="background: #059669; font-size: 12px;">‚ö° Quick Approve</button>
              <button onclick="quickReject('${petition.id}')" class="btn-reject" style="background: #dc2626; font-size: 12px;">‚ö° Quick Reject</button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // Open moderation modal
    function openModerationModal(petitionId, action) {
      console.log('Opening moderation modal for petition:', petitionId, 'action:', action);
      
      try {
        currentPetitionId = petitionId;
        const petition = allPetitions.find(p => p.id === petitionId);
        
        if (!petition) {
          console.error('Petition not found:', petitionId);
          showNotification('‚ùå Petisi tidak ditemukan dalam data lokal', 'error');
          return;
        }

        // Check if modal elements exist
        const modal = document.getElementById('moderationModal');
        const title = document.getElementById('moderationTitle');
        const content = document.getElementById('moderationContent');
        const notes = document.getElementById('moderationNotes');

        if (!modal || !title || !content || !notes) {
          console.error('Modal elements not found');
          showNotification('‚ùå Error: Modal elements tidak ditemukan', 'error');
          return;
        }

        title.textContent = action === 'approve' ? 'Setujui Petisi' : 'Tolak Petisi';
        
        content.innerHTML = `
          <div class="content-section">
            <div class="content-label">Judul Petisi</div>
            <div class="content-text">${petition.title}</div>
          </div>
          <div class="content-section">
            <div class="content-label">Pembuat</div>
            <div class="content-text">${petition.full_name} (${petition.email})</div>
          </div>
        `;

        notes.value = '';
        modal.classList.add('open');
        
        console.log('Modal opened successfully');
        
      } catch (error) {
        console.error('Error opening moderation modal:', error);
        showNotification('‚ùå Error membuka modal: ' + error.message, 'error');
        
        // Fallback: direct action without modal
        if (confirm(`Apakah Anda yakin ingin ${action === 'approve' ? 'menyetujui' : 'menolak'} petisi ini?`)) {
          if (action === 'approve') {
            approvePetitionDirect(petitionId);
          } else {
            const reason = prompt('Masukkan alasan penolakan:');
            if (reason) {
              rejectPetitionDirect(petitionId, reason);
            }
          }
        }
      }
    }

    // Close moderation modal
    function closeModerationModal() {
      document.getElementById('moderationModal').classList.remove('open');
      currentPetitionId = null;
    }

    // Direct approve petition (fallback)
    async function approvePetitionDirect(petitionId, notes = '') {
      console.log('Direct approve petition:', petitionId);
      await processPetitionAction(petitionId, 'approved', notes);
    }

    // Direct reject petition (fallback)
    async function rejectPetitionDirect(petitionId, notes) {
      console.log('Direct reject petition:', petitionId);
      if (!notes) {
        showNotification('‚ùå Alasan penolakan diperlukan', 'error');
        return;
      }
      await processPetitionAction(petitionId, 'rejected', notes);
    }

    // Quick approve without modal
    async function quickApprove(petitionId) {
      const petition = allPetitions.find(p => p.id === petitionId);
      if (!petition) {
        showNotification('‚ùå Petisi tidak ditemukan', 'error');
        return;
      }

      if (confirm(`Apakah Anda yakin ingin menyetujui petisi "${petition.title}"?`)) {
        showNotification('‚ö° Quick approve dimulai...', 'warning');
        await processPetitionAction(petitionId, 'approved', 'Disetujui melalui quick approve');
      }
    }

    // Quick reject without modal
    async function quickReject(petitionId) {
      const petition = allPetitions.find(p => p.id === petitionId);
      if (!petition) {
        showNotification('‚ùå Petisi tidak ditemukan', 'error');
        return;
      }

      const reason = prompt(`Masukkan alasan penolakan untuk petisi "${petition.title}":`);
      if (reason && reason.trim()) {
        showNotification('‚ö° Quick reject dimulai...', 'warning');
        await processPetitionAction(petitionId, 'rejected', reason.trim());
      } else if (reason !== null) {
        showNotification('‚ùå Alasan penolakan tidak boleh kosong', 'error');
      }
    }

    // Common function to process petition actions
    async function processPetitionAction(petitionId, status, notes) {
      try {
        const supabase = window.getSupabase();
        if (!supabase) {
          throw new Error('Supabase tidak tersedia');
        }

        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          throw new Error('User tidak terautentikasi');
        }

        console.log(`Processing petition ${petitionId} to status: ${status}`);

        // Map status for approval - change 'approved' to 'published' for public visibility
        const mappedStatus = status === 'approved' ? 'published' : status;
        
        const updateData = {
          status: mappedStatus,
          moderation_notes: notes || null,
          published_at: status === 'approved' ? new Date().toISOString() : null
        };

        // Also update moderation log if needed
        try {
          const { data: { user: currentUser } } = await supabase.auth.getUser();
          if (currentUser) {
            // Insert moderation log
            await supabase
              .from('petition_moderation_log')
              .insert({
                petition_id: petitionId,
                moderator_id: currentUser.id,
                action: status,
                notes: notes || null,
                created_at: new Date().toISOString()
              });
          }
        } catch (logError) {
          console.warn('Failed to log moderation action:', logError);
          // Don't fail the main operation if logging fails
        }

        // Retry mechanism
        let retryCount = 0;
        const maxRetries = 3;
        let data, error;
        
        while (retryCount < maxRetries) {
          try {
            console.log(`Attempting to update petition (attempt ${retryCount + 1}/${maxRetries})`);
            const result = await supabase
              .from('petitions')
              .update(updateData)
              .eq('id', petitionId)
              .select();
            
            data = result.data;
            error = result.error;
            
            if (!error) {
              console.log(`Petition ${status} successful on attempt`, retryCount + 1);
              break;
            }
            
            if (error.message.includes('connection') || error.message.includes('network') || error.message.includes('establish connection')) {
              retryCount++;
              console.log(`Connection error, retrying in ${retryCount} seconds...`);
              await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
            } else {
              console.log('Non-connection error, not retrying:', error.message);
              break;
            }
          } catch (retryError) {
            console.error(`Retry attempt ${retryCount + 1} failed:`, retryError);
            retryCount++;
            if (retryCount >= maxRetries) {
              throw retryError;
            }
            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
          }
        }

        if (error) {
          throw error;
        }

        console.log(`Petition ${status} successfully:`, data);
        
        const actionText = status === 'approved' ? 'disetujui' : 'ditolak';
        showNotification(`‚úÖ Petisi berhasil ${actionText}!`, 'success');
        
        // Reload data
        setTimeout(() => {
          loadPetitions();
        }, 500);

      } catch (error) {
        console.error(`Error ${status} petition:`, error);
        
        if (handleConnectionError(error, `petition ${status}`)) {
          return;
        }
        
        const actionText = status === 'approved' ? 'menyetujui' : 'menolak';
        showNotification(`‚ùå Error ${actionText} petisi: ${error.message}`, 'error');
      }
    }

    // Approve petition
    async function approvePetition() {
      console.log('approvePetition called, currentPetitionId:', currentPetitionId);
      if (!currentPetitionId) {
        console.error('No current petition ID');
        showNotification('Error: Tidak ada petisi yang dipilih', 'error');
        return;
      }

      const notes = document.getElementById('moderationNotes').value.trim();
      
      // Show loading state
      const approveBtn = document.querySelector('.btn-approve');
      const originalText = approveBtn ? approveBtn.textContent : '‚úÖ Setujui';
      if (approveBtn) {
        approveBtn.textContent = '‚è≥ Memproses...';
        approveBtn.disabled = true;
      }
      
      try {
        await processPetitionAction(currentPetitionId, 'approved', notes);
        closeModerationModal();
      } catch (error) {
        console.error('Error in approvePetition:', error);
        showNotification('‚ùå Error menyetujui petisi: ' + error.message, 'error');
      } finally {
        // Reset button state
        if (approveBtn) {
          approveBtn.textContent = originalText;
          approveBtn.disabled = false;
        }
      }
    }

    // Reject petition
    async function rejectPetition() {
      if (!currentPetitionId) {
        console.error('No current petition ID');
        showNotification('‚ùå Error: Tidak ada petisi yang dipilih', 'error');
        return;
      }

      const notes = document.getElementById('moderationNotes').value.trim();
      if (!notes) {
        showNotification('‚ùå Harap masukkan alasan penolakan', 'error');
        return;
      }

      // Show loading state
      const rejectBtn = document.querySelector('.btn-reject');
      const originalText = rejectBtn ? rejectBtn.textContent : '‚ùå Tolak';
      if (rejectBtn) {
        rejectBtn.textContent = '‚è≥ Memproses...';
        rejectBtn.disabled = true;
      }

      try {
        await processPetitionAction(currentPetitionId, 'rejected', notes);
        closeModerationModal();
      } catch (error) {
        console.error('Error in rejectPetition:', error);
        showNotification('‚ùå Error menolak petisi: ' + error.message, 'error');
      } finally {
        // Reset button state
        if (rejectBtn) {
          rejectBtn.textContent = originalText;
          rejectBtn.disabled = false;
        }
      }
    }

    // View petition details
    function viewPetition(petitionId) {
      const petition = allPetitions.find(p => p.id === petitionId);
      if (!petition) return;

      // Create detailed view modal
      const modal = document.createElement('div');
      modal.className = 'modal open';
      modal.innerHTML = `
        <div class="box" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
          <h3>Detail Petisi: ${petition.title}</h3>
          <div class="petition-content">
            <div class="content-section">
              <div class="content-label">Deskripsi Lengkap</div>
              <div class="content-text">${petition.description}</div>
            </div>
            <div class="content-section">
              <div class="content-label">Solusi yang Diharapkan</div>
              <div class="content-text">${petition.solution}</div>
            </div>
            <div class="content-section">
              <div class="content-label">Informasi Pembuat</div>
              <div class="content-text">
                <strong>Nama:</strong> ${petition.full_name}<br>
                <strong>Email:</strong> ${petition.email}<br>
                <strong>Phone:</strong> ${petition.phone}<br>
                <strong>NIK:</strong> ${petition.nik}
              </div>
            </div>
            ${petition.additional_info ? `
              <div class="content-section">
                <div class="content-label">Informasi Tambahan</div>
                <div class="content-text">${petition.additional_info}</div>
              </div>
            ` : ''}
            ${petition.ktp_url || petition.evidence_photos || petition.evidence_video_url || petition.documents_url ? `
              <div class="content-section">
                <div class="content-label">File Pendukung</div>
                <div class="file-grid">
                  ${petition.ktp_url ? `
                    <div class="file-item" onclick="viewFile('${petition.ktp_url}', 'KTP', 'image')" style="cursor: pointer;">
                      <div class="file-icon">üÜî</div>
                      <div class="file-name">KTP</div>
                      <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                    </div>
                  ` : ''}
                  ${petition.evidence_photos ? petition.evidence_photos.map((photo, index) => `
                    <div class="file-item" onclick="viewFile('${photo}', 'Foto Bukti ${index + 1}', 'image')" style="cursor: pointer;">
                      <div class="file-icon">üì∑</div>
                      <div class="file-name">Foto Bukti ${index + 1}</div>
                      <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                    </div>
                  `).join('') : ''}
                  ${petition.evidence_video_url ? `
                    <div class="file-item" onclick="viewFile('${petition.evidence_video_url}', 'Video Bukti', 'video')" style="cursor: pointer;">
                      <div class="file-icon">üé•</div>
                      <div class="file-name">Video Bukti</div>
                      <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                    </div>
                  ` : ''}
                  ${petition.documents_url ? petition.documents_url.map((doc, index) => `
                    <div class="file-item" onclick="viewFile('${doc}', 'Dokumen ${index + 1}', 'document')" style="cursor: pointer;">
                      <div class="file-icon">üìÑ</div>
                      <div class="file-name">Dokumen ${index + 1}</div>
                      <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Klik untuk melihat</div>
                    </div>
                  `).join('') : ''}
                </div>
              </div>
            ` : ''}
            ${petition.moderation_notes ? `
              <div class="content-section">
                <div class="content-label">Catatan Moderasi</div>
                <div class="content-text">${petition.moderation_notes}</div>
              </div>
            ` : ''}
          </div>
          <div class="actions-row">
            <button onclick="this.closest('.modal').remove()" class="btn ghost">Tutup</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Apply filters
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;

      let filtered = [...allPetitions];

      if (statusFilter) {
        // Map 'published' filter to show both 'published' and 'approved' statuses for backward compatibility
        if (statusFilter === 'published') {
          filtered = filtered.filter(p => p.status === 'published' || p.status === 'approved');
        } else {
          filtered = filtered.filter(p => p.status === statusFilter);
        }
      }

      if (categoryFilter) {
        filtered = filtered.filter(p => p.category === categoryFilter);
      }

      if (dateFilter) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

        filtered = filtered.filter(p => {
          const createdDate = new Date(p.created_at);
          switch (dateFilter) {
            case 'today':
              return createdDate >= today;
            case 'week':
              return createdDate >= weekAgo;
            case 'month':
              return createdDate >= monthAgo;
            default:
              return true;
          }
        });
      }

      renderPetitions(filtered);
    }

    // Clear filters
    function clearFilters() {
      document.getElementById('statusFilter').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('dateFilter').value = '';
      renderPetitions(allPetitions);
    }

    // Refresh data function
    async function refreshData() {
      console.log('Manual refresh triggered');
      showNotification('üîÑ Memuat ulang data...', 'warning');
      
      try {
        await loadPetitions();
        showNotification('‚úÖ Data berhasil dimuat ulang!', 'success');
      } catch (error) {
        console.error('Error refreshing data:', error);
        showNotification('‚ùå Error memuat ulang data: ' + error.message, 'error');
      }
    }

    // Test database connection
    async function testDatabaseConnection() {
      console.log('Testing database connection...');
      showNotification('üîç Testing koneksi database...', 'warning');
      
      try {
        const supabase = window.getSupabase();
        if (!supabase) {
          throw new Error('Supabase client tidak tersedia');
        }

        // Test basic connection - get total count
        const { count, error: countError } = await supabase
          .from('petitions')
          .select('*', { count: 'exact', head: true });

        if (countError) {
          console.error('Count query error:', countError);
          throw countError;
        }

        console.log('Total petitions in database:', count);

        // Test specific petition by ID - use proper format
        const testId = '4732fa09-b073-4062-af4a-2e048c2b58eb';
        console.log('Searching for petition with ID:', testId);
        
        const { data: testData, error: testError } = await supabase
          .from('petitions')
          .select('id, title, status, created_at, full_name')
          .eq('id', testId)
          .maybeSingle(); // Use maybeSingle instead of single to avoid error if not found

        console.log('Database connection test results:', {
          totalPetitions: count,
          testPetition: testData,
          testError: testError
        });

        if (testError) {
          showNotification(`‚ùå Error mencari petisi: ${testError.message}`, 'error');
        } else if (testData) {
          showNotification(`‚úÖ Koneksi OK! Petisi ditemukan: ${testData.title} (Status: ${testData.status})`, 'success');
        } else {
          showNotification(`‚ö†Ô∏è Koneksi OK! Total ${count} petisi di database, tapi petisi ${testId} tidak ditemukan`, 'warning');
        }

      } catch (error) {
        console.error('Database connection test failed:', error);
        showNotification('‚ùå Test koneksi gagal: ' + error.message, 'error');
      }
    }

    // Show all petitions with detailed information
    async function showAllPetitions() {
      console.log('Fetching all petitions with detailed info...');
      showNotification('üìã Mengambil semua petisi...', 'warning');
      
      try {
        const supabase = window.getSupabase();
        if (!supabase) {
          throw new Error('Supabase client tidak tersedia');
        }

        // Get all petitions with all fields
        const { data, error } = await supabase
          .from('petitions')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          throw error;
        }

        console.log('All petitions in database:', data);
        
        // Group by status
        const statusGroups = {
          pending: data.filter(p => p.status === 'pending'),
          approved: data.filter(p => p.status === 'approved'),
          rejected: data.filter(p => p.status === 'rejected'),
          published: data.filter(p => p.status === 'published'),
          other: data.filter(p => !['pending', 'approved', 'rejected', 'published'].includes(p.status))
        };

        console.log('Petitions grouped by status:', statusGroups);

        // Show detailed info
        let message = `üìä Total: ${data.length} petisi\n`;
        message += `‚è≥ Pending: ${statusGroups.pending.length}\n`;
        message += `‚úÖ Approved: ${statusGroups.approved.length}\n`;
        message += `‚ùå Rejected: ${statusGroups.rejected.length}\n`;
        message += `üì¢ Published: ${statusGroups.published.length}\n`;
        message += `‚ùì Other: ${statusGroups.other.length}`;

        if (statusGroups.other.length > 0) {
          message += `\n\nStatus lain: ${statusGroups.other.map(p => p.status).join(', ')}`;
        }

        // Show in modal
        const modal = document.createElement('div');
        modal.className = 'modal open';
        modal.innerHTML = `
          <div class="box" style="max-width: 600px;">
            <h3>üìä Semua Petisi di Database</h3>
            <div style="white-space: pre-line; font-family: monospace; background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 16px 0;">
              ${message}
            </div>
            <div style="max-height: 300px; overflow-y: auto; margin: 16px 0;">
              ${data.map((petition, index) => `
                <div style="border: 1px solid #e5e7eb; padding: 12px; margin: 8px 0; border-radius: 6px;">
                  <strong>${index + 1}. ${petition.title}</strong><br>
                  <small>ID: ${petition.id}</small><br>
                  <small>Status: <span style="color: ${petition.status === 'pending' ? '#d97706' : petition.status === 'approved' ? '#059669' : '#dc2626'}">${petition.status}</span></small><br>
                  <small>Created: ${new Date(petition.created_at).toLocaleString('id-ID')}</small><br>
                  <small>Creator: ${petition.full_name}</small>
                </div>
              `).join('')}
            </div>
            <div class="actions-row">
              <button onclick="this.closest('.modal').remove()" class="btn ghost">Tutup</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        showNotification('‚úÖ Data semua petisi berhasil dimuat!', 'success');

      } catch (error) {
        console.error('Error fetching all petitions:', error);
        showNotification('‚ùå Error mengambil data: ' + error.message, 'error');
      }
    }

    // View published petitions in public page
    function viewPublishedPetitions() {
      // Open public petitions page in new tab
      window.open('./petitions-desktop.html', '_blank');
    }

    // View file function
    function viewFile(fileUrl, fileName, fileType) {
      if (!fileUrl) {
        alert('File tidak tersedia');
        return;
      }

      // Create file viewer modal
      const modal = document.createElement('div');
      modal.className = 'file-viewer-modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="file-viewer-content">
          <div class="file-viewer-header">
            <h3 class="file-viewer-title">${fileName}</h3>
            <button class="file-viewer-close" onclick="this.closest('.file-viewer-modal').remove()">√ó</button>
          </div>
          <div class="file-viewer-body">
            ${getFilePreview(fileUrl, fileType)}
            <div class="file-info">
              <strong>URL File:</strong> ${fileUrl}<br>
              <strong>Tipe File:</strong> ${fileType}
            </div>
            <button class="file-download-btn" onclick="downloadFile('${fileUrl}', '${fileName}')">
              üì• Download File
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // Get file preview based on type
    function getFilePreview(fileUrl, fileType) {
      switch (fileType) {
        case 'image':
          return `<img src="${fileUrl}" alt="Preview" class="file-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                   <div style="display: none; padding: 40px; color: #6b7280;">
                     <div style="font-size: 48px; margin-bottom: 16px;">üñºÔ∏è</div>
                     <div>Gambar tidak dapat dimuat</div>
                     <div style="font-size: 12px; margin-top: 8px;">URL: ${fileUrl}</div>
                   </div>`;
        case 'video':
          return `<video controls class="file-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                     <source src="${fileUrl}" type="video/mp4">
                     <source src="${fileUrl}" type="video/webm">
                     <source src="${fileUrl}" type="video/ogg">
                     Browser Anda tidak mendukung video.
                   </video>
                   <div style="display: none; padding: 40px; color: #6b7280;">
                     <div style="font-size: 48px; margin-bottom: 16px;">üé•</div>
                     <div>Video tidak dapat dimuat</div>
                     <div style="font-size: 12px; margin-top: 8px;">URL: ${fileUrl}</div>
                   </div>`;
        case 'document':
        default:
          return `<div style="padding: 40px; color: #6b7280;">
                     <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                     <div>Dokumen tidak dapat dipreview</div>
                     <div style="font-size: 12px; margin-top: 8px;">URL: ${fileUrl}</div>
                     <div style="margin-top: 16px;">
                       <a href="${fileUrl}" target="_blank" class="file-download-btn" style="text-decoration: none; display: inline-block;">
                         üîó Buka di Tab Baru
                       </a>
                     </div>
                   </div>`;
      }
    }

    // Download file function
    function downloadFile(fileUrl, fileName) {
      try {
        // Create a temporary link element
        const link = document.createElement('a');
        link.href = fileUrl;
        link.download = fileName || 'file';
        link.target = '_blank';
        
        // Append to body, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('Download initiated for:', fileUrl);
      } catch (error) {
        console.error('Error downloading file:', error);
        // Fallback: open in new tab
        window.open(fileUrl, '_blank');
      }
    }

    // Show notification function
    function showNotification(message, type = 'success') {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notif => notif.remove());
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Show notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      // Hide notification after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, 3000);
    }

    // Global error handler for connection issues
    function handleConnectionError(error, operation) {
      console.error(`Connection error during ${operation}:`, error);
      
      if (error.message.includes('establish connection') || 
          error.message.includes('Receiving end does not exist')) {
        
        showNotification('‚ö†Ô∏è Masalah koneksi terdeteksi. Mencoba solusi alternatif...', 'warning');
        
        // Try to refresh Supabase connection
        setTimeout(async () => {
          try {
            const supabase = window.getSupabase();
            if (supabase) {
              // Test connection
              const { data, error: testError } = await supabase
                .from('petitions')
                .select('id')
                .limit(1);
              
              if (!testError) {
                showNotification('‚úÖ Koneksi berhasil dipulihkan! Silakan coba lagi.', 'success');
              } else {
                showNotification('‚ùå Masih ada masalah koneksi. Silakan refresh halaman.', 'error');
              }
            }
          } catch (refreshError) {
            console.error('Error refreshing connection:', refreshError);
            showNotification('‚ùå Gagal memulihkan koneksi. Silakan refresh halaman.', 'error');
          }
        }, 2000);
        
        return true; // Error handled
      }
      
      return false; // Error not handled
    }

    // Logout function
    function logout() {
      localStorage.removeItem('speakup_logged_in');
      localStorage.removeItem('speakup_user_data');
      window.location.href = './desktop.html';
    }

    // Global error handler for unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      
      if (event.reason && event.reason.message) {
        if (handleConnectionError(event.reason, 'unhandled promise rejection')) {
          event.preventDefault(); // Prevent default error handling
        }
      }
    });

    // Initialize page
    async function init() {
      const hasAccess = await checkAdminAccess();
      if (hasAccess) {
        await loadPetitions();
      }
    }

    // Start when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <script src="assets/js/app.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config/supabase-config.js"></script>
  <script src="config/supabase-client.js"></script>
</body>
</html>