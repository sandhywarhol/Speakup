<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeakUp! - Request Verified Badge</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .verified-badge-preview {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .badge-icon {
      font-size: 16px;
    }
    
    .form-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-label {
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }
    
    .form-input, .form-textarea, .form-select {
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      background: #f9fafb;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .file-upload-area:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    
    .file-upload-area.dragover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    
    .file-upload-icon {
      font-size: 32px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    
    .file-upload-text {
      color: #6b7280;
      font-size: 14px;
    }
    
    .file-list {
      margin-top: 16px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .file-icon {
      font-size: 20px;
    }
    
    .file-details {
      display: flex;
      flex-direction: column;
    }
    
    .file-name {
      font-weight: 500;
      color: #1f2937;
      font-size: 14px;
    }
    
    .file-size {
      color: #6b7280;
      font-size: 12px;
    }
    
    .file-remove {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .file-remove:hover {
      background: #fecaca;
    }
    
    .btn-submit {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
    }
    
    .btn-submit:hover {
      background: #2563eb;
    }
    
    .btn-submit:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .info-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }
    
    .info-box h3 {
      color: #0369a1;
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    
    .info-box p {
      color: #0c4a6e;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .requirements-list {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }
    
    .requirements-list h3 {
      color: #92400e;
      margin: 0 0 12px 0;
      font-size: 16px;
    }
    
    .requirements-list ul {
      margin: 0;
      padding-left: 20px;
      color: #92400e;
    }
    
    .requirements-list li {
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>
<body class="desktop-page">
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <img src="assets/logo/logo speak up blue.png" alt="SpeakUp!" style="height: 40px; margin-right: 16px;">
            <h1 style="margin: 0; font-size: 24px;">Request Verified Badge</h1>
          </div>
          <nav class="flex items-center gap-6">
            <a href="desktop.html" class="text-gray-600 hover:text-gray-800">üè† Home</a>
            <a href="profile-desktop.html" class="text-gray-600 hover:text-gray-800">üë§ Profile</a>
          </nav>
        </div>
      </div>
    </header>

    <!-- Back Navigation -->
    <div class="container" style="margin-bottom: 24px;">
      <div class="flex items-center gap-4">
        <a href="desktop.html" class="btn ghost" style="display: inline-flex; align-items: center; gap: 8px;">
          <span>‚Üê</span>
          <span>Kembali ke Home</span>
        </a>
        <span style="color: #6b7280; font-size: 14px;">|</span>
        <span style="color: #6b7280; font-size: 14px;">Request Verified Badge</span>
      </div>
    </div>

    <!-- Main Content -->
    <main style="max-width: 800px; margin: 0 auto; padding: 32px 0;">
      <!-- Verified Badge Preview -->
      <div style="text-align: center; margin-bottom: 32px;">
        <div class="verified-badge-preview">
          <span class="badge-icon">‚úì</span>
          <span>Verified Badge</span>
        </div>
        <p style="color: #6b7280; font-size: 14px; margin: 8px 0 0 0;">
          Tampilkan kepercayaan dan kredibilitas Anda di komunitas SpeakUp!
        </p>
      </div>

      <!-- Info Box -->
      <div class="info-box">
        <h3>üèÜ Apa itu Verified Badge?</h3>
        <p>
          Verified Badge adalah tanda khusus yang menunjukkan bahwa identitas dan kredibilitas Anda telah diverifikasi oleh tim SpeakUp!. 
          Badge ini membantu membangun kepercayaan dalam komunitas dan menunjukkan bahwa Anda adalah orang yang dapat dipercaya.
        </p>
      </div>

      <!-- Requirements -->
      <div class="requirements-list">
        <h3>üìã Persyaratan untuk Verified Badge</h3>
        <ul>
          <li>Akun yang aktif dan terdaftar di SpeakUp!</li>
          <li>Identitas yang dapat diverifikasi (KTP, SIM, atau dokumen resmi lainnya)</li>
          <li>Profesi atau keahlian yang jelas dan dapat dibuktikan</li>
          <li>Riwayat positif di platform (tidak ada pelanggaran)</li>
          <li>Dokumen pendukung yang relevan (CV, sertifikat, dll.)</li>
        </ul>
      </div>

      <!-- Request Form -->
      <form id="verifiedBadgeForm" class="form-section">
        <h2 style="margin: 0 0 24px 0; color: #1f2937;">Form Permintaan Verified Badge</h2>
        
        <!-- Personal Information -->
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="full_name">Nama Lengkap *</label>
            <input type="text" name="full_name" id="full_name" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="email">Email *</label>
            <input type="email" name="email" id="email" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Nomor Telepon</label>
            <input type="tel" name="phone" class="form-input" placeholder="08123456789">
          </div>
          <div class="form-group">
            <label class="form-label">Profesi *</label>
            <input type="text" name="profession" class="form-input" required placeholder="Contoh: Software Engineer, Dokter, Guru">
          </div>
          <div class="form-group">
            <label class="form-label">Organisasi/Perusahaan</label>
            <input type="text" name="organization" class="form-input" placeholder="Contoh: PT. Tech Company, RS. Sehat">
          </div>
        </div>

        <!-- Verification Reason -->
        <div class="form-group" style="margin-top: 24px;">
          <label class="form-label">Alasan Meminta Verified Badge *</label>
          <textarea name="verification_reason" class="form-textarea" required placeholder="Jelaskan mengapa Anda membutuhkan verified badge dan bagaimana hal ini akan membantu komunitas SpeakUp!..."></textarea>
        </div>

        <!-- Supporting Documents -->
        <div style="margin-top: 24px;">
          <label class="form-label">Dokumen Pendukung</label>
          <p style="color: #6b7280; font-size: 14px; margin: 4px 0 16px 0;">
            Upload dokumen yang mendukung permintaan Anda (CV, sertifikat, KTP, dll.)
          </p>
          
          <div class="file-upload-area" id="fileUploadArea">
            <div class="file-upload-icon">üìÅ</div>
            <div class="file-upload-text">
              <strong>Klik untuk upload</strong> atau drag & drop file di sini
            </div>
            <div style="color: #9ca3af; font-size: 12px; margin-top: 8px;">
              PDF, DOC, DOCX, JPG, PNG (Max 10MB per file)
            </div>
          </div>
          
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" title="Upload dokumen pendukung">
          
          <div class="file-list" id="fileList"></div>
        </div>

        <!-- Submit Button -->
        <div style="margin-top: 32px; text-align: center;">
          <button type="submit" class="btn-submit" id="submitButton">
            Kirim Permintaan Verified Badge
          </button>
        </div>
      </form>
    </main>
  </div>

  <script>
    let uploadedFiles = [];

    // Check if user is logged in
    async function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem('speakup_logged_in');
      if (!isLoggedIn) {
        alert('Anda harus login terlebih dahulu untuk mengajukan verified badge.');
        window.location.href = './desktop.html';
        return false;
      }
      return true;
    }

    // File upload handling
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');

    fileUploadArea.addEventListener('click', () => fileInput.click());
    fileUploadArea.addEventListener('dragover', handleDragOver);
    fileUploadArea.addEventListener('dragleave', handleDragLeave);
    fileUploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);

    function handleDragOver(e) {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      processFiles(files);
    }

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      processFiles(files);
    }

    function processFiles(files) {
      files.forEach(file => {
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          alert(`File ${file.name} terlalu besar. Maksimal 10MB per file.`);
          return;
        }

        // Check file type
        const allowedTypes = [
          'application/pdf',
          'application/msword',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'image/jpeg',
          'image/png'
        ];

        if (!allowedTypes.includes(file.type)) {
          alert(`File ${file.name} tidak didukung. Hanya PDF, DOC, DOCX, JPG, PNG yang diperbolehkan.`);
          return;
        }

        // Add to uploaded files
        uploadedFiles.push(file);
        renderFileList();
      });
    }

    function renderFileList() {
      fileList.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-item">
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div class="file-details">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
          <button type="button" class="file-remove" onclick="removeFile(${index})">
            Hapus
          </button>
        </div>
      `).join('');
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      renderFileList();
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission
    document.getElementById('verifiedBadgeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!await checkLoginStatus()) return;

      const submitButton = document.getElementById('submitButton');
      const originalText = submitButton.textContent;
      
      try {
        submitButton.disabled = true;
        submitButton.textContent = 'Mengirim Permintaan...';

        const formData = new FormData(this);
        
        // Validate required fields
        const requiredFields = ['full_name', 'email', 'profession', 'verification_reason'];
        const missingFields = requiredFields.filter(field => !formData.get(field));
        
        if (missingFields.length > 0) {
          alert('Mohon lengkapi semua field yang wajib diisi.');
          return;
        }

        // Prepare supporting documents data
        const supportingDocuments = uploadedFiles.map(file => ({
          name: file.name,
          size: file.size,
          type: file.type
        }));

        // Get Supabase client
        const supabase = window.getSupabase();
        if (!supabase) {
          throw new Error('Supabase tidak tersedia');
        }

        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          throw new Error('User tidak terautentikasi');
        }

        // Prepare request data
        const requestData = {
          user_id: user.id,
          full_name: formData.get('full_name'),
          email: formData.get('email'),
          phone: formData.get('phone') || null,
          profession: formData.get('profession'),
          organization: formData.get('organization') || null,
          verification_reason: formData.get('verification_reason'),
          supporting_documents: supportingDocuments.length > 0 ? supportingDocuments : null
        };

        console.log('Submitting verified badge request:', requestData);

        // Insert request to database
        const { data, error } = await supabase
          .from('verified_badge_requests')
          .insert(requestData)
          .select()
          .single();

        if (error) {
          throw error;
        }

        // Upload files if any
        if (uploadedFiles.length > 0) {
          console.log('Uploading supporting documents...');
          for (let i = 0; i < uploadedFiles.length; i++) {
            const file = uploadedFiles[i];
            const fileExt = file.name.split('.').pop();
            const fileName = `${data.id}-${i}-${Date.now()}.${fileExt}`;
            const filePath = `verified-badge/${data.id}/${fileName}`;

            const { error: uploadError } = await supabase.storage
              .from('petitions')
              .upload(filePath, file);

            if (uploadError) {
              console.warn('Failed to upload file:', file.name, uploadError);
            } else {
              console.log('File uploaded successfully:', file.name);
            }
          }
        }

        // Show success message
        alert('Permintaan verified badge berhasil dikirim! Tim kami akan mereview permintaan Anda dalam 1-3 hari kerja. Anda akan mendapat notifikasi via email.');
        
        // Redirect to profile page
        window.location.href = './profile-desktop.html';

      } catch (error) {
        console.error('Error submitting verified badge request:', error);
        alert('Gagal mengirim permintaan verified badge: ' + error.message);
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      await checkLoginStatus();
    });
  </script>

  <script src="assets/js/app.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config/supabase-config.js"></script>
  <script src="config/supabase-client.js"></script>
</body>
</html>
