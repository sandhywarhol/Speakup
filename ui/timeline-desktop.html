<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline</title>
    <link rel="icon" type="image/png" href="assets/logo/logo apps.png?v=2">
    <link rel="shortcut icon" type="image/png" href="assets/logo/logo apps.png?v=2">
    <link rel="stylesheet" href="assets/css/style.css">
  <style>
        /* Lock to light/bright theme for desktop page */
        :root {
            --bg: #ffffff; /* putih penuh */
            --panel: #ffffff;
            --text: #374151;
            --muted: #64748b;
            --accent: #38bdf8;
            --border: #e5e7eb;
        }

        /* Force white background for all elements - override external CSS */
        html, body, main, .desktop-container, .desktop-nav, .card, .tabs .tab, .modal .box, .grid, .header, .btn, .badge, .pill {
            background: #ffffff !important;
        }
        
        /* Override specific CSS rules from style.css */
        body.desktop-page, 
        body.desktop-page html, 
        body.desktop-page body,
        .desktop-page .desktop-nav,
        .desktop-page .desktop-nav .nav-item.active,
        .desktop-page .desktop-nav .nav-item.plus-btn,
        .desktop-page .btn.primary,
        .desktop-page .btn.plus-btn {
            background: #ffffff !important;
        }

        /* Desktop neutralization: remove blue backgrounds, keep titles blue */
        .desktop-nav .logo { 
            color: #111827 !important; 
            font-weight: 800; 
            letter-spacing: 0.5px; 
        }
        /* Make all text (non-headings) dark grey */
        body.desktop-page, 
        body.desktop-page *:not(h1):not(h2):not(h3):not(h4):not(h5):not(h6),
        .desktop-page p,
        .desktop-page .content,
        .desktop-page .feature p,
        .desktop-page .hero p,
        .desktop-page .footer,
        .desktop-page .pill,
        .desktop-page .meta,
        .desktop-page .badge,
        .desktop-page .setting-item .label,
        .desktop-page .setting-item .pill {
            color: #374151 !important;
        }
        .desktop-nav .nav-item.active { background: #ffffff !important; color: #374151 !important; border: 1px solid #e5e7eb !important; }
        .desktop-nav .nav-item:hover { background: #ffffff !important; }
        .desktop-nav .nav-item.plus-btn { background: #ffffff !important; color: #374151 !important; border: 1px solid #e5e7eb !important; }
        .btn.primary { background: #ffffff !important; color: #374151 !important; border: 1px solid #e5e7eb !important; }
        .btn { background: #ffffff !important; color: #374151 !important; border-color: #e5e7eb !important; }
        .badge, .badge.success, .badge.warn, .badge.danger { background: #ffffff !important; color: #374151 !important; border: 1px solid #e5e7eb !important; }
        .tabs .tab.active { color: #374151 !important; background: #ffffff !important; border-color: #e5e7eb !important; }
        .card { background: #ffffff !important; }
        .grid, .header, .bottom-nav, .modal .box { background: #ffffff; }
        /* Prevent oversized media from covering controls */
        .modal .box { max-height: 80vh; overflow-y: auto; }
        .image-preview video, .image-preview img { max-width: 100%; height: auto; display: block; }
        .image-preview video { max-height: 300px; }
        .post-media img, .post-media video { max-width: 100%; height: auto; display: block; }
        .post-media video { max-height: 420px; }

        /* Verified Badge Animation */
        @keyframes pulse {
          0% {
            transform: scale(1);
            opacity: 1;
          }
          50% {
            transform: scale(1.1);
            opacity: 0.7;
          }
          100% {
            transform: scale(1);
            opacity: 1;
          }
        }

        /* Desktop layout (tanpa frame ponsel) */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #ffffff !important; /* putih penuh */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

    /* Timeline specific styles */
        .container { 
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
        .post { 
      background: white;
      border-radius: 12px;
      padding: 20px;
            margin-bottom: 16px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            margin-right: 12px; 
        }
        .avatar.anonymous { background: #6b7280; }
        .avatar.verified { background: #38bdf8; }
        .avatar.custom { background: #10b981; }
        .avatar.verified-profile { 
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
            border: 2px solid #38bdf8;
        }
        .avatar.custom-profile { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid #10b981;
        }
    .post-content {
            color: #374151; 
      line-height: 1.6;
            margin-bottom: 12px; 
        }
        .post-meta { 
            font-size: 14px; 
            color: #64748b; 
        }
    .post-actions {
      display: flex;
      gap: 16px;
            margin-top: 12px; 
      padding-top: 12px;
            border-top: 1px solid #e5e7eb; 
    }
    .action-btn {
      background: none;
      border: none;
            color: #64748b; 
      cursor: pointer;
            padding: 4px 8px; 
            border-radius: 4px; 
    }
    .action-btn:hover {
      background: #f3f4f6;
    }
    .action-btn .count {
      margin-left: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Active states for buttons */
    .action-btn.like-btn.liked,
    .action-btn.like-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.like-btn.liked svg,
    .action-btn.like-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    .action-btn.save-btn.saved,
    .action-btn.save-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.save-btn.saved svg,
    .action-btn.save-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    .action-btn.follow-btn.followed,
    .action-btn.follow-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.follow-btn.followed svg,
    .action-btn.follow-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    .action-btn.repost-btn.reposted,
    .action-btn.repost-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.repost-btn.reposted svg,
    .action-btn.repost-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    /* Comment Modal Styles */
    .comment-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    .comment-modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .comment-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .comment-modal-header h3 {
      margin: 0;
      color: #374151;
      font-size: 18px;
      font-weight: 600;
    }

    .comment-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #64748b;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .comment-modal-close:hover {
      background-color: #f3f4f6;
      color: #374151;
    }

    .comment-modal-body {
      padding: 24px;
    }

    .comment-input-container {
      position: relative;
      z-index: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #commentText {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
      margin: 0;
    }

    #commentText:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }

    .comment-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .emoji-btn {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-btn:hover {
      background-color: #f3f4f6;
      color: #374151;
    }

    .comment-submit-btn {
      background-color: #38bdf8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .comment-submit-btn:hover {
      background-color: #0ea5e9;
    }

    .comment-submit-btn:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .emoji-picker {
      position: absolute;
      top: -120px;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #38bdf8;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      height: 120px;
      width: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      margin: 0;
      /* Ensure same width as textarea */
      min-width: 0;
      max-width: 100%;
      /* Match textarea width exactly */
      left: 0;
      right: 0;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
    }

    .emoji {
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      text-align: center;
      transition: background-color 0.2s ease;
    }

    .emoji:hover {
      background-color: #f3f4f6;
    }

    .no-posts-message {
      text-align: center;
      color: #64748b;
      padding: 20px;
    }

    .hidden {
      display: none;
    }


    .post-username {
      font-weight: 600;
      color: #374151;
    }

    .post-category {
      font-size: 12px;
      color: #38bdf8;
      background-color: #dbeafe;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
      margin-top: 2px;
      display: inline-block;
    }

    .post-profession {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }

    .post-time {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }

    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
    }

    .verified-profession {
      font-size: 12px;
      color: #64748b;
      font-weight: normal;
    }

    .custom-profession {
      font-size: 12px;
      color: #64748b;
      font-weight: normal;
      margin-top: 2px;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .comment-modal-content {
        margin: 10% auto;
        width: 95%;
      }
      
      .emoji-grid {
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
      }
      
      .emoji {
        font-size: 18px;
        padding: 2px;
      }
      
      .emoji-picker {
        height: 100px;
        top: -100px;
        padding: 12px;
      }
    }
  </style>
</head>
<body class="desktop-page">
    <!-- Desktop Top Navigation -->
    <nav class="desktop-nav" aria-label="Navigasi desktop">
        <div class="desktop-nav-inner">
            <div class="nav-left">
                <div class="logo">SpeakUp!</div>
                <a href="./desktop.html" class="nav-item" title="Home">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    <span>Home</span>
                </a>
                <button class="nav-item plus-btn dashboard-only" data-open-create title="Speak!">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    <span>Speak!</span>
                </button>
                <a href="./timeline-desktop.html" class="nav-item active dashboard-only" title="Timeline">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                    <span>Timeline</span>
                </a>
                <a href="./petitions-desktop.html" class="nav-item dashboard-only" title="Aspirasi">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span>Aspirasi</span>
                </a>
            </div>
            <div class="nav-right">
                <a href="./settings-desktop.html" class="nav-item dashboard-only" title="Settings">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    <span>Settings</span>
                </a>
                <a href="./profile-desktop.html" class="nav-item dashboard-only" title="Profile">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                    <span>Profile</span>
                </a>
                <a href="./sign-desktop.html" class="nav-item" id="signButton" title="Login">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h8.586l-3.293-3.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 11-1.414-1.414L12.586 11H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span>Login</span>
                </a>
    </div>
    </div>
  </nav>

    <div class="container">
        <h1>Timeline</h1>
        <div id="posts-container">
            <!-- Posts will be loaded here -->
      </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="comment-modal">
        <div class="comment-modal-content">
            <div class="comment-modal-header">
                <h3>Komentar</h3>
                <button class="comment-modal-close" onclick="closeCommentModal()">&times;</button>
            </div>
            <div class="comment-modal-body">
                <!-- Daftar komentar (scrollable) -->
                <div id="modalComments" style="max-height:240px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-bottom:12px;background:#f9fafb;"></div>
                <div class="comment-input-container">
                    <textarea id="commentText" placeholder="Tulis komentar Anda..." rows="3"></textarea>
                    <div class="comment-actions">
                        <button class="emoji-btn" onclick="toggleCommentEmojiPicker()" title="Tambah Emoji" type="button">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <button class="comment-submit-btn" onclick="submitComment()">Kirim</button>
                    </div>
                    <div id="commentEmojiPicker" class="emoji-picker">
                    <div class="emoji-grid">
                        <!-- Wajah dan Emosi -->
                        <span class="emoji" onclick="insertCommentEmoji('😀')">😀</span>
                        <span class="emoji" onclick="insertCommentEmoji('😃')">😃</span>
                        <span class="emoji" onclick="insertCommentEmoji('😄')">😄</span>
                        <span class="emoji" onclick="insertCommentEmoji('😁')">😁</span>
                        <span class="emoji" onclick="insertCommentEmoji('😆')">😆</span>
                        <span class="emoji" onclick="insertCommentEmoji('😅')">😅</span>
                        <span class="emoji" onclick="insertCommentEmoji('😂')">😂</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤣')">🤣</span>
                        <span class="emoji" onclick="insertCommentEmoji('😊')">😊</span>
                        <span class="emoji" onclick="insertCommentEmoji('😇')">😇</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🙂')">🙂</span>
                        <span class="emoji" onclick="insertCommentEmoji('🙃')">🙃</span>
                        <span class="emoji" onclick="insertCommentEmoji('😉')">😉</span>
                        <span class="emoji" onclick="insertCommentEmoji('😌')">😌</span>
                        <span class="emoji" onclick="insertCommentEmoji('😍')">😍</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥰')">🥰</span>
                        <span class="emoji" onclick="insertCommentEmoji('😘')">😘</span>
                        <span class="emoji" onclick="insertCommentEmoji('😗')">😗</span>
                        <span class="emoji" onclick="insertCommentEmoji('😙')">😙</span>
                        <span class="emoji" onclick="insertCommentEmoji('😚')">😚</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('😋')">😋</span>
                        <span class="emoji" onclick="insertCommentEmoji('😛')">😛</span>
                        <span class="emoji" onclick="insertCommentEmoji('😝')">😝</span>
                        <span class="emoji" onclick="insertCommentEmoji('😜')">😜</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤪')">🤪</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤨')">🤨</span>
                        <span class="emoji" onclick="insertCommentEmoji('🧐')">🧐</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤓')">🤓</span>
                        <span class="emoji" onclick="insertCommentEmoji('😎')">😎</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤩')">🤩</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🥳')">🥳</span>
                        <span class="emoji" onclick="insertCommentEmoji('😏')">😏</span>
                        <span class="emoji" onclick="insertCommentEmoji('😒')">😒</span>
                        <span class="emoji" onclick="insertCommentEmoji('😞')">😞</span>
                        <span class="emoji" onclick="insertCommentEmoji('😔')">😔</span>
                        <span class="emoji" onclick="insertCommentEmoji('😟')">😟</span>
                        <span class="emoji" onclick="insertCommentEmoji('😕')">😕</span>
                        <span class="emoji" onclick="insertCommentEmoji('🙁')">🙁</span>
                        <span class="emoji" onclick="insertCommentEmoji('☹️')">☹️</span>
                        <span class="emoji" onclick="insertCommentEmoji('😣')">😣</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('😖')">😖</span>
                        <span class="emoji" onclick="insertCommentEmoji('😫')">😫</span>
                        <span class="emoji" onclick="insertCommentEmoji('😩')">😩</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥺')">🥺</span>
                        <span class="emoji" onclick="insertCommentEmoji('😢')">😢</span>
                        <span class="emoji" onclick="insertCommentEmoji('😭')">😭</span>
                        <span class="emoji" onclick="insertCommentEmoji('😤')">😤</span>
                        <span class="emoji" onclick="insertCommentEmoji('😠')">😠</span>
                        <span class="emoji" onclick="insertCommentEmoji('😡')">😡</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤬')">🤬</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🤯')">🤯</span>
                        <span class="emoji" onclick="insertCommentEmoji('😳')">😳</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥵')">🥵</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥶')">🥶</span>
                        <span class="emoji" onclick="insertCommentEmoji('😱')">😱</span>
                        <span class="emoji" onclick="insertCommentEmoji('😨')">😨</span>
                        <span class="emoji" onclick="insertCommentEmoji('😰')">😰</span>
                        <span class="emoji" onclick="insertCommentEmoji('😥')">😥</span>
                        <span class="emoji" onclick="insertCommentEmoji('😓')">😓</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤗')">🤗</span>
                        
                        <!-- Gesture dan Tangan -->
                        <span class="emoji" onclick="insertCommentEmoji('🤔')">🤔</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤭')">🤭</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤫')">🤫</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤥')">🤥</span>
                        <span class="emoji" onclick="insertCommentEmoji('😶')">😶</span>
                        <span class="emoji" onclick="insertCommentEmoji('😐')">😐</span>
                        <span class="emoji" onclick="insertCommentEmoji('😑')">😑</span>
                        <span class="emoji" onclick="insertCommentEmoji('😬')">😬</span>
                        <span class="emoji" onclick="insertCommentEmoji('🙄')">🙄</span>
                        <span class="emoji" onclick="insertCommentEmoji('😯')">😯</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('😦')">😦</span>
                        <span class="emoji" onclick="insertCommentEmoji('😧')">😧</span>
                        <span class="emoji" onclick="insertCommentEmoji('😮')">😮</span>
                        <span class="emoji" onclick="insertCommentEmoji('😲')">😲</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥱')">🥱</span>
                        <span class="emoji" onclick="insertCommentEmoji('😴')">😴</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤤')">🤤</span>
                        <span class="emoji" onclick="insertCommentEmoji('😪')">😪</span>
                        <span class="emoji" onclick="insertCommentEmoji('😵')">😵</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤐')">🤐</span>
                        
                        <!-- Tangan dan Gesture -->
                        <span class="emoji" onclick="insertCommentEmoji('👍')">👍</span>
                        <span class="emoji" onclick="insertCommentEmoji('👎')">👎</span>
                        <span class="emoji" onclick="insertCommentEmoji('👌')">👌</span>
                        <span class="emoji" onclick="insertCommentEmoji('✌️')">✌️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤞')">🤞</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤟')">🤟</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤘')">🤘</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤙')">🤙</span>
                        <span class="emoji" onclick="insertCommentEmoji('👈')">👈</span>
                        <span class="emoji" onclick="insertCommentEmoji('👉')">👉</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('👆')">👆</span>
                        <span class="emoji" onclick="insertCommentEmoji('🖕')">🖕</span>
                        <span class="emoji" onclick="insertCommentEmoji('👇')">👇</span>
                        <span class="emoji" onclick="insertCommentEmoji('☝️')">☝️</span>
                        <span class="emoji" onclick="insertCommentEmoji('👋')">👋</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤚')">🤚</span>
                        <span class="emoji" onclick="insertCommentEmoji('🖐️')">🖐️</span>
                        <span class="emoji" onclick="insertCommentEmoji('✋')">✋</span>
                        <span class="emoji" onclick="insertCommentEmoji('🖖')">🖖</span>
                        <span class="emoji" onclick="insertCommentEmoji('👏')">👏</span>
                        
                        <!-- Simbol dan Objek -->
                        <span class="emoji" onclick="insertCommentEmoji('❤️')">❤️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🧡')">🧡</span>
                        <span class="emoji" onclick="insertCommentEmoji('💛')">💛</span>
                        <span class="emoji" onclick="insertCommentEmoji('💚')">💚</span>
                        <span class="emoji" onclick="insertCommentEmoji('💙')">💙</span>
                        <span class="emoji" onclick="insertCommentEmoji('💜')">💜</span>
                        <span class="emoji" onclick="insertCommentEmoji('🖤')">🖤</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤍')">🤍</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤎')">🤎</span>
                        <span class="emoji" onclick="insertCommentEmoji('💔')">💔</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('💕')">💕</span>
                        <span class="emoji" onclick="insertCommentEmoji('💞')">💞</span>
                        <span class="emoji" onclick="insertCommentEmoji('💓')">💓</span>
                        <span class="emoji" onclick="insertCommentEmoji('💗')">💗</span>
                        <span class="emoji" onclick="insertCommentEmoji('💖')">💖</span>
                        <span class="emoji" onclick="insertCommentEmoji('💘')">💘</span>
                        <span class="emoji" onclick="insertCommentEmoji('💝')">💝</span>
                        <span class="emoji" onclick="insertCommentEmoji('💟')">💟</span>
                        <span class="emoji" onclick="insertCommentEmoji('☮️')">☮️</span>
                        <span class="emoji" onclick="insertCommentEmoji('✝️')">✝️</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('☪️')">☪️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🕉️')">🕉️</span>
                        <span class="emoji" onclick="insertCommentEmoji('☸️')">☸️</span>
                        <span class="emoji" onclick="insertCommentEmoji('✡️')">✡️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🔯')">🔯</span>
                        <span class="emoji" onclick="insertCommentEmoji('🕎')">🕎</span>
                        <span class="emoji" onclick="insertCommentEmoji('☯️')">☯️</span>
                        <span class="emoji" onclick="insertCommentEmoji('☦️')">☦️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🛐')">🛐</span>
                        <span class="emoji" onclick="insertCommentEmoji('⛎')">⛎</span>
                        
                        <!-- Simbol Populer -->
                        <span class="emoji" onclick="insertCommentEmoji('♈')">♈</span>
                        <span class="emoji" onclick="insertCommentEmoji('♉')">♉</span>
                        <span class="emoji" onclick="insertCommentEmoji('♊')">♊</span>
                        <span class="emoji" onclick="insertCommentEmoji('♋')">♋</span>
                        <span class="emoji" onclick="insertCommentEmoji('♌')">♌</span>
                        <span class="emoji" onclick="insertCommentEmoji('♍')">♍</span>
                        <span class="emoji" onclick="insertCommentEmoji('♎')">♎</span>
                        <span class="emoji" onclick="insertCommentEmoji('♏')">♏</span>
                        <span class="emoji" onclick="insertCommentEmoji('♐')">♐</span>
                        <span class="emoji" onclick="insertCommentEmoji('♑')">♑</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('♒')">♒</span>
                        <span class="emoji" onclick="insertCommentEmoji('♓')">♓</span>
                        <span class="emoji" onclick="insertCommentEmoji('🆔')">🆔</span>
                        <span class="emoji" onclick="insertCommentEmoji('⚛️')">⚛️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🉑')">🉑</span>
                        <span class="emoji" onclick="insertCommentEmoji('☢️')">☢️</span>
                        <span class="emoji" onclick="insertCommentEmoji('☣️')">☣️</span>
                        <span class="emoji" onclick="insertCommentEmoji('📴')">📴</span>
                        <span class="emoji" onclick="insertCommentEmoji('📳')">📳</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈶')">🈶</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🈚')">🈚</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈸')">🈸</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈺')">🈺</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈷️')">🈷️</span>
                        <span class="emoji" onclick="insertCommentEmoji('✴️')">✴️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🆚')">🆚</span>
                        <span class="emoji" onclick="insertCommentEmoji('💮')">💮</span>
                        <span class="emoji" onclick="insertCommentEmoji('🉐')">🉐</span>
                        <span class="emoji" onclick="insertCommentEmoji('㊙️')">㊙️</span>
                        <span class="emoji" onclick="insertCommentEmoji('㊗️')">㊗️</span>
                        
                        <!-- Simbol Populer Lainnya -->
                        <span class="emoji" onclick="insertCommentEmoji('🈴')">🈴</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈵')">🈵</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈹')">🈹</span>
                        <span class="emoji" onclick="insertCommentEmoji('🈲')">🈲</span>
                        <span class="emoji" onclick="insertCommentEmoji('🅰️')">🅰️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🅱️')">🅱️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🆎')">🆎</span>
                        <span class="emoji" onclick="insertCommentEmoji('🅾️')">🅾️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🆑')">🆑</span>
                        <span class="emoji" onclick="insertCommentEmoji('🅾️')">🅾️</span>
                        
                        <!-- Simbol Populer -->
                        <span class="emoji" onclick="insertCommentEmoji('🔥')">🔥</span>
                        <span class="emoji" onclick="insertCommentEmoji('💯')">💯</span>
                        <span class="emoji" onclick="insertCommentEmoji('✨')">✨</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎉')">🎉</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎊')">🎊</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎈')">🎈</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎁')">🎁</span>
                        <span class="emoji" onclick="insertCommentEmoji('🏆')">🏆</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥇')">🥇</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥈')">🥈</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🥉')">🥉</span>
                        <span class="emoji" onclick="insertCommentEmoji('🏅')">🏅</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎖️')">🎖️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🏵️')">🏵️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎗️')">🎗️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎫')">🎫</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎟️')">🎟️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎪')">🎪</span>
                        <span class="emoji" onclick="insertCommentEmoji('🤹')">🤹</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎭')">🎭</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🩰')">🩰</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎨')">🎨</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎬')">🎬</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎤')">🎤</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎧')">🎧</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎼')">🎼</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎵')">🎵</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎶')">🎶</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎹')">🎹</span>
                        <span class="emoji" onclick="insertCommentEmoji('🥁')">🥁</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('🎷')">🎷</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎺')">🎺</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎸')">🎸</span>
                        <span class="emoji" onclick="insertCommentEmoji('🪕')">🪕</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎻')">🎻</span>
                        <span class="emoji" onclick="insertCommentEmoji('🪘')">🪘</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎲')">🎲</span>
                        <span class="emoji" onclick="insertCommentEmoji('♠️')">♠️</span>
                        <span class="emoji" onclick="insertCommentEmoji('♥️')">♥️</span>
                        <span class="emoji" onclick="insertCommentEmoji('♦️')">♦️</span>
                        
                        <span class="emoji" onclick="insertCommentEmoji('♣️')">♣️</span>
                        <span class="emoji" onclick="insertCommentEmoji('♟️')">♟️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🃏')">🃏</span>
                        <span class="emoji" onclick="insertCommentEmoji('🀄')">🀄</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎴')">🎴</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎯')">🎯</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎳')">🎳</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎮')">🎮</span>
                        <span class="emoji" onclick="insertCommentEmoji('🕹️')">🕹️</span>
                        <span class="emoji" onclick="insertCommentEmoji('🎰')">🎰</span>
                    </div>
                    </div>
                </div>
            </div>
      </div>
    </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config/supabase-config.js"></script>
  <script src="config/supabase-bootstrap.js"></script>
  <script>
        let supabase;
        
        // Initialize Supabase with proper waiting mechanism
        async function initializeSupabase() {
            try {
                // Wait for Supabase to be ready
                let attempts = 0;
                const maxAttempts = 50; // 2.5 seconds max wait
                
                while (attempts < maxAttempts) {
                    if (window.getSupabase && window.getSupabase()) {
                        supabase = window.getSupabase();
                        console.log('Supabase initialized successfully via getSupabase()');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 50));
                    attempts++;
                }
                
                if (!supabase) {
                    throw new Error('Supabase tidak dapat dimuat. Silakan refresh halaman.');
                }
                
                // Test connection
                await testSupabaseConnection();
                
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                showConnectionError('Gagal menginisialisasi database. Silakan refresh halaman.');
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeSupabase);
        
        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('posts').select('count').limit(1);
                if (error) {
                    console.error('Supabase connection test failed:', error);
                    showConnectionError('Koneksi ke database gagal. Periksa koneksi internet Anda.');
                } else {
                    console.log('Supabase connection test successful');
                }
            } catch (error) {
                console.error('Supabase connection test error:', error);
                showConnectionError('Tidak dapat terhubung ke database. Periksa koneksi internet Anda.');
            }
        }
        
        // Show connection error message
        function showConnectionError(message) {
            const container = document.getElementById('posts-container');
            if (container) {
                container.innerHTML = `
                    <div class="connection-error-message" style="
                        text-align: center; 
                        padding: 40px 20px; 
                        background: #fef2f2; 
                        border: 1px solid #fecaca; 
                        border-radius: 12px; 
                        margin: 20px 0;
                        color: #dc2626;
                    ">
                        <h3>⚠️ Masalah Koneksi</h3>
                        <p>${message}</p>
                        <button onclick="window.location.reload()" class="btn primary" style="margin-top: 10px;">
                            🔄 Coba Lagi
                        </button>
                    </div>
                `;
            }
        }
        
        // Load posts with improved error handling
        async function loadPosts() {
            try {
                console.log('Loading posts...');
        
                // Check if Supabase is initialized
                if (!supabase) {
                    console.error('Supabase not initialized');
                    showConnectionError('Database tidak tersedia. Silakan refresh halaman.');
                    return;
                }
        
                // Check authentication status with timeout
                const authPromise = supabase.auth.getUser();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Authentication timeout')), 10000)
                );
                
                const { data: { user }, error: authError } = await Promise.race([
                    authPromise, 
                    timeoutPromise
                ]);
                
          console.log('Current user:', user);
          console.log('Auth error:', authError);
          
          // If no user, show login message
          if (!user) {
            console.warn('No authenticated user - showing login message');
            const container = document.getElementById('posts-container');
            container.innerHTML = `
                        <div class="no-posts-message" style="
                            text-align: center; 
                            padding: 40px 20px; 
                            background: #f0f9ff; 
                            border: 1px solid #bae6fd; 
                            border-radius: 12px; 
                            margin: 20px 0;
                            color: #0369a1;
                        ">
                <h3>🔒 Silakan Login</h3>
                <p>Anda perlu login untuk melihat timeline.</p>
                <p><a href="./sign-desktop.html" class="btn primary">Login Sekarang</a></p>
              </div>
            `;
            return;
          }
        
                // Load posts with timeout and better debugging
                console.log('🔍 Starting to load posts from database...');
                const postsPromise = supabase
          .from('posts')
                    .select(`
                        id,
                        content,
                        category,
                        identity,
                        want_solution,
                        image_url,
                        video_url,
                        is_pinned,
                        created_at,
                        updated_at,
                        user_id
                    `)
          .order('created_at', { ascending: false });
                    
                const postsTimeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Posts loading timeout')), 15000)
                );
                
                const { data: posts, error } = await Promise.race([
                    postsPromise,
                    postsTimeoutPromise
                ]);
                
                // Debug: Log posts data
                console.log('Posts loaded:', posts);
                if (posts && posts.length > 0) {
                    console.log('First post:', posts[0]);
                    console.log('Posts count:', posts.length);
                }
                
                console.log('📊 Query result:', { posts, error });
                console.log('📈 Posts count:', posts ? posts.length : 'undefined');
                console.log('🔍 First post sample:', posts && posts.length > 0 ? posts[0] : 'No posts');
          
        if (error) {
          console.error('Error loading posts:', error);
          console.error('Error details:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          
          // Show user-friendly message based on error type
          const container = document.getElementById('posts-container');
          let errorMessage = '';
          
          if (error.code === 'PGRST301' || error.message.includes('permission denied')) {
            errorMessage = `
              <div class="no-posts-message">
                <h3>🔒 Akses Ditolak</h3>
                <p>Anda perlu login untuk melihat timeline.</p>
                <p><a href="./sign-desktop.html" class="btn primary">Login Sekarang</a></p>
              </div>
            `;
          } else if (error.message.includes('relation "posts" does not exist')) {
            errorMessage = `
              <div class="no-posts-message">
                <h3>📊 Database belum dikonfigurasi</h3>
                <p>Silakan jalankan script database setup di Supabase Dashboard terlebih dahulu.</p>
                <p>File: <code>ui/posts-setup.sql</code></p>
              </div>
            `;
          } else {
            errorMessage = `
              <div class="no-posts-message">
                <h3>❌ Error Loading Timeline</h3>
                <p>Terjadi kesalahan: ${error.message}</p>
                <p>Silakan refresh halaman atau coba lagi nanti.</p>
              </div>
            `;
          }
          
          container.innerHTML = errorMessage;
          return;
        }
        
        console.log('✅ Posts loaded successfully:', posts);
        console.log('📝 About to call displayPosts with', posts ? posts.length : 0, 'posts');
        
        if (posts && posts.length > 0) {
            console.log('🎯 Calling displayPosts...');
        displayPosts(posts);
        } else {
            console.log('📭 No posts found, showing empty message');
            const container = document.getElementById('posts-container');
            if (container) {
                container.innerHTML = `
                    <div class="no-posts-message" style="
                        text-align: center; 
                        padding: 40px 20px; 
                        background: #f0f9ff; 
                        border: 1px solid #bae6fd; 
                        border-radius: 12px; 
                        margin: 20px 0;
                        color: #0369a1;
                    ">
                        <h3>📝 Belum Ada Postingan</h3>
                        <p>Jadilah yang pertama untuk berbagi cerita atau pengalaman!</p>
                        <button onclick="document.querySelector('[data-open-create]').click()" class="btn primary">
                            ✍️ Buat Postingan Pertama
                        </button>
                    </div>
                `;
            }
        }
        
      } catch (error) {
        console.error('Error in loadPosts:', error);
        
        // Handle specific error types
        let errorMessage = 'Terjadi kesalahan saat memuat timeline.';
        let errorType = 'general';
        
        if (error.message.includes('Network disconnected') || 
            error.message.includes('Network') || 
            error.message.includes('fetch')) {
            errorMessage = 'Koneksi jaringan terputus. Periksa koneksi internet Anda.';
            errorType = 'network';
        } else if (error.message.includes('timeout')) {
            errorMessage = 'Koneksi timeout. Server mungkin lambat, coba lagi.';
            errorType = 'timeout';
        } else if (error.message.includes('auth') || error.message.includes('Authentication')) {
            errorMessage = 'Masalah autentikasi. Silakan login ulang.';
            errorType = 'auth';
        }
        
        const container = document.getElementById('posts-container');
        container.innerHTML = `
            <div class="error-message" style="
                text-align: center; 
                padding: 40px 20px; 
                background: #fef2f2; 
                border: 1px solid #fecaca; 
                border-radius: 12px; 
                margin: 20px 0;
                color: #dc2626;
            ">
                <h3>⚠️ ${errorType === 'network' ? 'Masalah Koneksi' : 'Error Loading Timeline'}</h3>
                <p>${errorMessage}</p>
                <p><small>Detail: ${error.message}</small></p>
                <button onclick="loadPosts()" class="btn primary" style="margin-top: 10px;">
                    🔄 Coba Lagi
                </button>
                <button onclick="window.location.reload()" class="btn" style="margin-top: 10px; margin-left: 10px;">
                    🔄 Refresh Halaman
                </button>
            </div>
        `;
      }
    }
    
        // Display posts with better debugging
        async function displayPosts(posts) {
            console.log('🎨 displayPosts called with:', posts);
            const container = document.getElementById('posts-container');
            
            if (!container) {
                console.error('❌ posts-container not found!');
                return;
            }
            
            console.log('📦 Container found, clearing content...');
            container.innerHTML = '';
      
      if (!posts || posts.length === 0) {
                console.log('📭 No posts to display');
                container.innerHTML = `
                    <div class="no-posts-message" style="
                        text-align: center; 
                        padding: 40px 20px; 
                        background: #f0f9ff; 
                        border: 1px solid #bae6fd; 
                        border-radius: 12px; 
                        margin: 20px 0;
                        color: #0369a1;
                    ">
                        <h3>📝 Belum Ada Postingan</h3>
                        <p>Jadilah yang pertama untuk berbagi cerita atau pengalaman!</p>
                        <button onclick="document.querySelector('[data-open-create]').click()" class="btn primary">
                            ✍️ Buat Postingan Pertama
                        </button>
                    </div>
                `;
        return;
      }
            
            console.log(`🔄 Processing ${posts.length} posts...`);
      
            // Process posts sequentially to avoid overwhelming the database
            for (let i = 0; i < posts.length; i++) {
                const post = posts[i];
                console.log(`📝 Creating post element ${i + 1}/${posts.length}:`, post.id);
                
                try {
                const postElement = await createPostElement(post);
                container.appendChild(postElement);
                    console.log(`✅ Post ${i + 1} added to container`);
                } catch (error) {
                    console.error(`❌ Error creating post element ${i + 1}:`, error);
            }
            }
            
            console.log('🎉 All posts displayed successfully');
        }
        
        // Create post element
        async function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.id = `post-${post.id}`;
            postDiv.setAttribute('data-post-id', post.id);
      
      const timeAgo = getTimeAgo(new Date(post.created_at));
            const { avatarHtml, displayName, verifiedBadge, profession } = await getProfileInfo(post);
      
      postDiv.innerHTML = `
        <div class="post-header">
                    ${avatarHtml}
                    <div>
                        <div class="post-username">
                            ${post.identity === 'anonymous' 
                                ? `<span style="color: #374151; cursor: default;" title="User anonim - profil tidak dapat diakses">${displayName}</span>`
                                : `<span onclick="navigateToUserProfile('${post.user_id}')" style="cursor: pointer; color: #374151; text-decoration: none;" onmouseover="this.style.color='#1f2937'; this.style.textDecoration='underline';" onmouseout="this.style.color='#374151'; this.style.textDecoration='none';" data-user-id="${post.user_id}">${displayName}</span>`
                            }${verifiedBadge}
                        </div>
                        ${profession ? `<div class="post-profession" style="font-size: 12px; color: #64748b; margin-top: 2px;">${profession}</div>` : ''}
                        <div class="post-time">${timeAgo}</div>
          </div>
        </div>
                <div class="post-content">${post.content}</div>
                ${post.video_url
                  ? `<div class=\"post-media\"><video src=\"${post.video_url}\" controls style=\"max-width:100%;border-radius:12px;margin-top:8px;\"></video></div>`
                  : (post.image_url ? `<div class=\"post-media\"><img src=\"${post.image_url}\" alt=\"Post image\" style=\"max-width:100%;border-radius:12px;margin-top:8px;\"/></div>` : '')}
                ${post.category ? `<div class="post-category">${post.category}</div>` : ''}
                <div class="post-meta">
                    ${post.want_solution ? '💡 Mencari solusi' : ''}
                </div>
                <div class="post-comments-toggle" style="margin-top:6px;">
                  <button
                    style="background:none;border:none;color:#6b7280;font-size:12px;padding:0;margin:0;cursor:pointer;"
                    onclick="toggleComments('${post.id}')"
                    id="comments-toggle-${post.id}">Lihat komentar.....</button>
                </div>
        <div class="post-actions">
                    <button class="action-btn like-btn" onclick="likePost('${post.id}')" title="Like">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.834a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
            </svg>
            <span class="count">0</span>
          </button>
                    <button class="action-btn" onclick="commentPost('${post.id}')" title="Comment">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.314-3.582 6-8 6-.87 0-1.706-.108-2.486-.31L3 17l1.31-3.514C3.108 12.706 3 11.87 3 11c0-3.314 3.582-6 8-6s8 2.686 8 6z" clip-rule="evenodd"/>
            </svg>
            <span class="count">0</span>
                    </button>
                    <button class="action-btn follow-btn" onclick="followPost('${post.id}')" title="Pin Post">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 384 512">
                            <path d="M32 32C32 14.3 46.3 0 64 0H320c17.7 0 32 14.3 32 32s-14.3 32-32 32H290.5l11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3H32c-10.3 0-19.9-4.9-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64H64C46.3 64 32 49.7 32 32zM160 384h64v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z"/>
                        </svg>
                    </button>
                    <button class="action-btn save-btn" onclick="savePost('${post.id}')" title="Save">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                        </svg>
                    </button>
                    <button class="action-btn repost-btn" onclick="repostPost('${post.id}')" title="Repost">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8zM3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15a2 2 0 002-2V5a2 2 0 00-2-2h-2a3 3 0 00-3-3H8a3 3 0 00-3 3H3z"/>
                        </svg>
                        <span class="count">0</span>
                    </button>
                    <button class="action-btn" onclick="sharePost('${post.id}')" title="Share">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3 3 0 000-1.319l4.94-2.47A3 3 0 0015 8z"/>
                        </svg>
                    </button>
        </div>
      `;
      
      // Comments container under each post (non-intrusive)
      const commentsContainer = document.createElement('div');
      commentsContainer.className = 'post-comments';
      commentsContainer.id = `comments-${post.id}`;
      commentsContainer.style.marginTop = '8px';
      commentsContainer.style.display = 'none';
      // Keep post owner id for permission checks when rendering comments
      try { commentsContainer.setAttribute('data-owner-id', String(post.user_id || '')); } catch(_) {}
      postDiv.appendChild(commentsContainer);
      
      // Load initial counts
      console.log('DEBUG: Calling loadPostCounts with post.id:', post.id);
      console.log('DEBUG: post object:', post);
      loadPostCounts(post.id);
      // Conditionally add delete button for owner
      try {
        const actions = postDiv.querySelector('.post-actions');
        if (actions && supabase && supabase.auth) {
          const { data: { user } } = await supabase.auth.getUser();
          if (user && user.id === post.user_id) {
            const delBtn = document.createElement('button');
            delBtn.className = 'action-btn';
            delBtn.title = 'Hapus Post';
            delBtn.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 448 512"><path d="M135.2 17.7C140.6 7.2 151.2 0 162.7 0H285.3c11.5 0 22.1 7.2 27.5 17.7L328 32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 96 0 81.7 0 64S14.3 32 32 32H120l15.2-14.3zM53.2 467c1.6 25.5 22.8 45 48.4 45H346.4c25.6 0 46.8-19.5 48.4-45L416 128H32l21.2 339z"/></svg>';
            delBtn.addEventListener('click', () => deletePost(post.id));
            actions.appendChild(delBtn);
          }
        }
      } catch (_) {}
      
      // Comments will be lazy-loaded when user toggles visibility
      
      return postDiv;
    }
    
    // Load initial counts for a post
    async function loadPostCounts(postId) {
      try {
        console.log('DEBUG: Loading counts for postId:', postId);
        console.log('DEBUG: postId type:', typeof postId);
        console.log('DEBUG: postId length:', postId ? postId.length : 'undefined');
        
        // Validate postId
        if (!postId || postId === 'null' || postId === 'undefined') {
          console.error('Invalid postId:', postId);
          return;
        }

        // Load like count with improved error handling and fallback
        try {
        console.log('Attempting to load like count for post:', postId);
        
        // Check authentication first
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        console.log('Current user:', user);
        console.log('Auth error:', authError);
        
        if (!user) {
          console.warn('No authenticated user - setting like count to 0');
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = '0';
            }
          }
          return;
        }
        
        const { data: likeData, error: likeError } = await supabase
          .from('post_likes')
            .select('id')
          .eq('post_id', postId);
        
          if (!likeError && likeData !== null) {
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = likeData.length || 0;
            }
          }
        } else {
            console.warn('Like count error (406/RLS issue):', likeError);
            console.warn('Error details:', {
              code: likeError?.code,
              message: likeError?.message,
              details: likeError?.details
            });
            
            // Show user-friendly message for RLS issues
            if (likeError?.code === 'PGRST301' || likeError?.message?.includes('permission denied')) {
              console.warn('RLS permission denied - user may need to login or RLS policies need to be fixed');
            }
            
            // Set to 0 if error
            const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
            if (likeBtn) {
              const countSpan = likeBtn.querySelector('.count');
              if (countSpan) {
                countSpan.textContent = '0';
              }
            }
          }
        } catch (likeCountError) {
          console.warn('Like count request failed:', likeCountError);
          // Set to 0 if error
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = '0';
            }
          }
        }
        
        // Load comment count with improved error handling
        try {
        // Check authentication first
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (!user) {
          console.warn('No authenticated user - setting comment count to 0');
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = '0';
            }
          }
          return;
        }
        
        const { data: commentData, error: commentError } = await supabase
          .from('post_comments')
            .select('id')
          .eq('post_id', postId);
        
          if (!commentError && commentData !== null) {
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = commentData.length || 0;
            }
          }
        } else {
            console.warn('Comment count error (406/RLS issue):', commentError);
            console.warn('Error details:', {
              code: commentError?.code,
              message: commentError?.message,
              details: commentError?.details
            });
            // Set to 0 if error
            const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
            if (commentBtn) {
              const countSpan = commentBtn.querySelector('.count');
              if (countSpan) {
                countSpan.textContent = '0';
              }
            }
          }
        } catch (commentCountError) {
          console.warn('Comment count request failed:', commentCountError);
          // Set to 0 if error
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = '0';
            }
          }
        }
        
        // Check if current user has liked/saved/followed this post
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          // Check like status with better error handling
          try {
          const { data: userLike, error: likeCheckError } = await supabase
            .from('post_likes')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (userLike && !likeCheckError) {
            updateLikeButton(postId, true);
            }
          } catch (likeError) {
            console.warn('Like check failed:', likeError);
          }
          
          // Check save status with better error handling
          try {
          console.log('DEBUG: Checking save status - postId:', postId, 'user.id:', user.id);
          const { data: userSave, error: saveCheckError } = await supabase
            .from('post_saves')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (userSave && !saveCheckError) {
            updateSaveButton(postId, true);
            }
          } catch (saveError) {
            console.warn('Save check failed:', saveError);
          }

          // Check pin status with better error handling
          try {
            console.log('DEBUG: Checking pin status - postId:', postId, 'user.id:', user.id);
            const { data: post, error: pinCheckError } = await supabase
              .from('posts')
              .select('is_pinned, user_id')
              .eq('id', postId)
              .single();
            
            if (post && !pinCheckError) {
              console.log('Pin status for post', postId, ':', post.is_pinned);
              updateFollowButton(postId, post.is_pinned === true || post.is_pinned === 'true');
            }
          } catch (pinError) {
            console.warn('Pin check failed:', pinError);
          }
        }
        
      } catch (error) {
        console.log('Error loading post counts:', error);
        // Set to 0 if error
        const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
        if (likeBtn) {
          const countSpan = likeBtn.querySelector('.count');
          if (countSpan) {
            countSpan.textContent = '0';
          }
        }
        
        const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
        if (commentBtn) {
          const countSpan = commentBtn.querySelector('.count');
          if (countSpan) {
            countSpan.textContent = '0';
          }
        }
      }
      
      // Check repost status for current user
      checkRepostStatus(postId);
      
      // Update repost count
      updateRepostCount(postId);
      
      // Load interaction states for current user
      loadInteractionStates(postId);
    }
    
    // Load interaction states (like, save, pin) for current user
    async function loadInteractionStates(postId) {
      try {
        console.log('Loading interaction states for post:', postId);
        
        // Check if user is authenticated
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
          console.log('No authenticated user - skipping interaction states');
          return;
        }
        
        console.log('Loading interaction states for user:', user.id);
        
        // Load like status
        try {
          const { data: likeData, error: likeError } = await supabase
            .from('post_likes')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (!likeError && likeData) {
            console.log('User has liked post:', postId);
            updateLikeButton(postId, true);
          } else if (likeError && likeError.code === 'PGRST301') {
            // Table doesn't exist yet - skip like check
            console.log('post_likes table not found - skipping like check');
            updateLikeButton(postId, false);
          } else {
            console.log('User has not liked post:', postId);
            updateLikeButton(postId, false);
          }
        } catch (likeError) {
          console.warn('Error loading like status:', likeError);
          updateLikeButton(postId, false);
        }
        
        // Load save status
        try {
          const { data: saveData, error: saveError } = await supabase
            .from('post_saves')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (!saveError && saveData) {
            console.log('User has saved post:', postId);
            updateSaveButton(postId, true);
          } else if (saveError && saveError.code === 'PGRST301') {
            // Table doesn't exist yet - skip save check
            console.log('post_saves table not found - skipping save check');
            updateSaveButton(postId, false);
          } else {
            console.log('User has not saved post:', postId);
            updateSaveButton(postId, false);
          }
        } catch (saveError) {
          console.warn('Error loading save status:', saveError);
          updateSaveButton(postId, false);
        }
        
        // Load pin status (check if post is pinned by current user)
        try {
          const { data: pinData, error: pinError } = await supabase
            .from('post_pins')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (!pinError && pinData) {
            console.log('User has pinned post:', postId);
            updateFollowButton(postId, true);
          } else if (pinError && pinError.code === 'PGRST301') {
            // Table doesn't exist yet - skip pin check
            console.log('post_pins table not found - skipping pin check');
            updateFollowButton(postId, false);
          } else {
            console.log('User has not pinned post:', postId);
            updateFollowButton(postId, false);
          }
        } catch (pinError) {
          console.warn('Error loading pin status:', pinError);
          updateFollowButton(postId, false);
        }
        
      } catch (error) {
        console.error('Error loading interaction states:', error);
      }
    }
    
    // Helper functions
    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Baru saja';
      if (minutes < 60) return `${minutes} menit yang lalu`;
      if (hours < 24) return `${hours} jam yang lalu`;
            return `${days} hari yang lalu`;
        }
        

        async function getProfileInfo(post) {
            const identity = post.identity;
            let avatarHtml, displayName, verifiedBadge = '', profession = '';
            
            // Get user profile data from profiles table
            let userProfile = null;
            try {
                console.log('Fetching profile for user_id:', post.user_id, 'identity:', identity);
                
                // Try different query approaches to handle RLS issues
                let profile = null;
                let error = null;
                
                // First try: Standard query
                const result1 = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', post.user_id)
                    .single();
                
                if (result1.error && result1.error.code === 'PGRST116') {
                    console.log('Profile not found with standard query, trying alternative...');
                    
                    // Second try: Query without .single() to handle RLS
                    const result2 = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', post.user_id);
                    
                    if (result2.data && result2.data.length > 0) {
                        profile = result2.data[0];
                        console.log('Profile found with alternative query:', profile);
                    } else {
                        error = result2.error;
                        console.log('Alternative query also failed:', error);
                    }
                } else {
                    profile = result1.data;
                    error = result1.error;
                }
                
                console.log('Final profile query result:', { profile, error });
                
                if (!error && profile) {
                    userProfile = profile;
                    console.log('User profile loaded:', {
                        id: profile.id,
                        full_name: profile.full_name,
                        avatar_url: profile.avatar_url,
                        profile_image: profile.profile_image,
                        profession: profile.profession,
                        title: profile.title,
                        is_verified: profile.is_verified
                    });
                } else {
                    console.warn('No profile found for user_id:', post.user_id, 'Error:', error);
                }
            } catch (error) {
                console.warn('Could not fetch user profile:', error);
            }
            
            // Handle different identity types
            if (identity === 'anonymous') {
                // Anonymous - hide all identity information
                return {
                    avatarHtml: `
                    <div class="avatar anonymous">
                        A
                    </div>
                    `,
                    displayName: 'Anonim',
                    verifiedBadge: '',
                    profession: '',
                };
            } else if (identity === 'custom_anon') {
                // Custom Handle/Public - show user's real profile
                if (userProfile) {
                    const profileImage = (userProfile.avatar_url && userProfile.avatar_url !== 'NULL') 
                        ? userProfile.avatar_url 
                        : 'assets/img/profil picture/default-avatar.jpg';
                    const fullName = userProfile.full_name || 'Pengguna';
                    const userProfession = userProfile.title || userProfile.profession || '';
                    
                    
                    avatarHtml = `
                        <img src="${profileImage}" alt="${fullName}" class="avatar custom-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
                    `;
                    displayName = fullName;
                    profession = userProfession;
                    verifiedBadge = ''; // No badge for custom_anon
                } else {
                    // Fallback if no profile data - try to get basic user info
                    console.log('No profile data found, trying to get basic user info for:', post.user_id);
                    
                    // Try to get user email or basic info from auth.users (if accessible)
                    try {
                        const { data: userData, error: userError } = await supabase.auth.admin.getUserById(post.user_id);
                        if (!userError && userData?.user?.email) {
                            const emailName = userData.user.email.split('@')[0];
                            displayName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
                            console.log('Using email-based name:', displayName);
                        } else {
                            displayName = 'Pengguna';
                        }
                    } catch (e) {
                        displayName = 'Pengguna';
                    }
                    
                    avatarHtml = `
                        <div class="avatar custom">
                            ${displayName.charAt(0).toUpperCase()}
                        </div>
                    `;
                    profession = '';
                    verifiedBadge = '';
                }
            } else if (identity === 'verified') {
                // Verified - show user's real profile with verification badge
                if (userProfile) {
                    const profileImage = (userProfile.avatar_url && userProfile.avatar_url !== 'NULL') 
                        ? userProfile.avatar_url 
                        : 'assets/img/profil picture/default-avatar.jpg';
                    const fullName = userProfile.full_name || 'Pengguna Terverifikasi';
                    const userProfession = userProfile.title || userProfile.profession || '';
                    
                    // HANYA tampilkan sebagai verified jika is_verified = true
                    if (userProfile.is_verified === true) {
                        
                        avatarHtml = `
                            <img src="${profileImage}" alt="${fullName}" class="avatar verified-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'" style="border: 2px solid #38bdf8;">
                        `;
                        displayName = fullName;
                        profession = userProfession;
                        verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; margin-left: 4px;" title="Verified Account">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <!-- Simple blue circle -->
                              <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                              <!-- White checkmark in center -->
                              <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>`;
                    } else {
                        // Jika identity = verified tapi is_verified = false, tampilkan sebagai custom_anon
                        
                        avatarHtml = `
                            <img src="${profileImage}" alt="${fullName}" class="avatar custom-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
                        `;
                        displayName = fullName;
                        profession = userProfession;
                        verifiedBadge = '';
                    }
                } else {
                    // Fallback if no profile data - tampilkan sebagai custom_anon
                    avatarHtml = `
                        <div class="avatar custom">
                            U
                        </div>
                    `;
                    displayName = 'Pengguna';
                    profession = '';
                    verifiedBadge = '';
                }
            } else {
                // Default fallback
                return {
                    avatarHtml: `
                    <div class="avatar anonymous">
                        A
                    </div>
                    `,
                    displayName: 'Anonim',
                    verifiedBadge: '',
                    profession: '',
                };
            }
            
            return { avatarHtml, displayName, verifiedBadge, profession };
    }

    // =============================
    // User Profile Navigation
    // =============================
    
    function navigateToUserProfile(userId) {
      if (!userId) {
        console.warn('No user ID provided for profile navigation');
        return;
      }
      
      console.log('Navigating to user profile:', userId);
      
      // Use URL parameter instead of localStorage for persistence
      const url = new URL('profile-desktop.html', window.location.origin);
      url.searchParams.set('user', userId);
      
      // Navigate to profile page with user parameter
      window.location.href = url.toString();
    }

    // =============================
    // Reply and Mention System
    // =============================
    
    // Global variables for reply system
    let currentReplyToCommentId = null;
    let currentReplyToUsername = null;
    
    // Function to start replying to a comment
    function startReply(postId, commentId, username) {
      console.log('startReply called with:', postId, commentId, username);
      currentReplyToCommentId = commentId;
      currentReplyToUsername = username;
      
      // Open comment modal first with postId
      openCommentModal(postId);
      
      // Update comment input placeholder
      const commentInput = document.getElementById('commentText');
      if (commentInput) {
        commentInput.placeholder = `Balas ke @${username}...`;
        commentInput.focus();
      }
      
      // Show reply indicator
      showReplyIndicator(username);
    }
    
    // Function to cancel reply
    function cancelReply() {
      console.log('cancelReply called');
      currentReplyToCommentId = null;
      currentReplyToUsername = null;
      
      // Reset comment input placeholder
      const commentInput = document.getElementById('commentText');
      if (commentInput) {
        commentInput.placeholder = 'Tulis komentar...';
      }
      
      // Hide reply indicator
      hideReplyIndicator();
    }
    
    // Function to show reply indicator
    function showReplyIndicator(username) {
      let indicator = document.getElementById('reply-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'reply-indicator';
        indicator.style.cssText = `
          background: #f3f4f6;
          border: 1px solid #d1d5db;
          border-radius: 8px;
          padding: 8px 12px;
          margin-bottom: 8px;
          font-size: 12px;
          color: #374151;
          display: flex;
          align-items: center;
          justify-content: space-between;
        `;
        
        const commentModal = document.getElementById('commentModal');
        if (commentModal) {
          const commentInput = commentModal.querySelector('#commentText');
          if (commentInput) {
            commentInput.parentNode.insertBefore(indicator, commentInput);
          }
        }
      }
      
      indicator.innerHTML = `
        <span>Membalas ke <strong>@${username}</strong></span>
        <button onclick="cancelReply()" style="background: none; border: none; color: #6b7280; cursor: pointer; font-size: 14px;">×</button>
      `;
      indicator.style.display = 'flex';
      console.log('Reply indicator shown for:', username);
    }
    
    // Function to hide reply indicator
    function hideReplyIndicator() {
      const indicator = document.getElementById('reply-indicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }
    
    // Function to extract mentions from text
    function extractMentions(text) {
      const mentionRegex = /@([a-zA-Z0-9_]+)/g;
      const mentions = [];
      let match;
      while ((match = mentionRegex.exec(text)) !== null) {
        mentions.push(match[1]);
      }
      return [...new Set(mentions)]; // Remove duplicates
    }
    
    // Function to get user ID from username
    async function getUserIdFromUsername(username) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('id')
          .eq('username', username)
          .single();
        
        if (error || !data) return null;
        return data.id;
      } catch (error) {
        console.warn('Error getting user ID from username:', error);
        return null;
      }
    }
    
    // Function to get username from user ID
    async function getUsernameFromUserId(userId) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('username, full_name')
          .eq('id', userId)
          .single();
        
        if (error || !data) return null;
        return data.username || data.full_name;
      } catch (error) {
        console.warn('Error getting username from user ID:', error);
        return null;
      }
    }
    
    // Function to highlight mentions in comment content
    function highlightMentions(content) {
      return content.replace(/@([a-zA-Z0-9_]+)/g, '<span style="color: #3b82f6; font-weight: 600;">@$1</span>');
    }
    
    // Function to get replies for a comment
    async function getCommentReplies(commentId) {
      try {
        const { data: replies, error } = await supabase
          .from('post_comments')
          .select('id, user_id, content, identity, created_at, mentioned_users')
          .eq('parent_comment_id', commentId)
          .order('created_at', { ascending: true })
          .limit(10);
        
        if (error || !replies || replies.length === 0) {
          return '';
        }
        
        const replyItems = await Promise.all(replies.map(async reply => {
          const when = getTimeAgo(new Date(reply.created_at));
          
          let displayName = 'Pengguna';
          let avatarHtml = '<div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">U</div>';
          let verifiedBadge = '';
          
          if (reply.identity === 'anonymous') {
            displayName = 'Anonim';
            avatarHtml = '<div style="width:20px;height:20px;border-radius:9999px;background:#6b7280;color:white;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">A</div>';
          } else {
            try {
              const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', reply.user_id)
                .single();
              
              if (!error && profile) {
                displayName = profile.full_name || 'Pengguna';
                if (profile.is_verified === true) {
                  verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; margin-left: 4px;" title="Verified Account">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                      <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>`;
                }
                if (profile.avatar_url && profile.avatar_url !== 'NULL') {
                  avatarHtml = `<img src="${profile.avatar_url}" alt="${displayName}" style="width:20px;height:20px;border-radius:9999px;object-fit:cover;">`;
                } else {
                  avatarHtml = `<div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">${displayName[0] || 'U'}</div>`;
                }
              }
            } catch (error) {
              console.warn('Error loading profile for reply:', error);
            }
          }
          
          return `<div class="reply-item" style="display:flex;gap:6px;align-items:flex-start;margin:4px 0;">
                    ${avatarHtml}
                    <div class="reply-body" style="flex:1;min-width:0;">
                      <div style="font-size:11px;color:#374151;font-weight:600;display:flex;align-items:center;margin-bottom:2px;">
                        ${reply.identity === 'anonymous' 
                          ? `<span style="color: #374151; cursor: default;">${displayName}</span>`
                          : `<span onclick="navigateToUserProfile('${reply.user_id}')" style="cursor: pointer; color: #374151; text-decoration: none;" onmouseover="this.style.color='#1f2937'; this.style.textDecoration='underline';" onmouseout="this.style.color='#374151'; this.style.textDecoration='none';">${displayName}</span>`
                        }${verifiedBadge} <span style="color:#9ca3af;font-weight:400;">• ${when}</span>
                      </div>
                      <div style="font-size:12px;color:#374151;line-height:1.4;word-wrap:break-word;">${highlightMentions(escapeHtml(reply.content))}</div>
                    </div>
                  </div>`;
        }));
        
        return replyItems.join('');
      } catch (error) {
        console.warn('Error getting comment replies:', error);
        return '';
      }
    }

    // =============================
    // Comments rendering
    // =============================
    async function renderCommentsForPost(postId) {
      const container = document.getElementById(`comments-${postId}`);
      if (!container) return;
      try {
        container.innerHTML = '<div style="font-size:12px;color:#6b7280;">Memuat komentar...</div>';
        if (!supabase) { container.innerHTML = ''; return; }
        const { data: rows, error } = await supabase
          .from('post_comments')
          .select('id, user_id, content, identity, created_at, parent_comment_id, mentioned_users')
          .eq('post_id', postId)
          .is('parent_comment_id', null) // Only get top-level comments
          .order('created_at', { ascending: true })
          .limit(20);
        if (error) { container.innerHTML = ''; return; }
        if (!rows || rows.length === 0) { container.innerHTML = '<div style="font-size:12px;color:#6b7280;">Belum ada komentar.</div>'; return; }
        // identify permissions
        let currentUserId = null;
        try { const { data: { user } } = await supabase.auth.getUser(); currentUserId = user?.id || null; } catch(_) {}
        const postOwnerId = container.getAttribute('data-owner-id');
        const items = await Promise.all(rows.map(async c => {
          const when = getTimeAgo(new Date(c.created_at));
          
          // Handle different identity types for comments
          let displayName = 'Pengguna';
          let username = '';
          let avatarHtml = '<div style="width:24px;height:24px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">U</div>';
          let verifiedBadge = '';
          
          if (c.identity === 'anonymous') {
            // Anonymous comment - hide all identity information
            displayName = 'Anonim';
            avatarHtml = '<div style="width:24px;height:24px;border-radius:9999px;background:#6b7280;color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">A</div>';
          } else {
            // Get user profile for non-anonymous comment author
            try {
              const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', c.user_id)
                .single();
              
              if (!error && profile) {
                displayName = profile.full_name || 'Pengguna';
                username = profile.username || profile.full_name || 'user';
                console.log('Profile loaded for comment:', { displayName, username, profile });
                
                // Check if user is verified
                if (profile.is_verified === true) {
                  verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; margin-left: 4px;" title="Verified Account">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <!-- Simple blue circle -->
                      <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                      <!-- White checkmark in center -->
                      <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>`;
                }
                
                // Create avatar based on profile
                if (profile.avatar_url && profile.avatar_url !== 'NULL') {
                  avatarHtml = `<img src="${profile.avatar_url}" alt="${displayName}" style="width:24px;height:24px;border-radius:9999px;object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="width:24px;height:24px;border-radius:9999px;background:#e5e7eb;color:#374151;display:none;align-items:center;justify-content:center;font-size:12px;font-weight:700;">${displayName[0] || 'U'}</div>`;
                } else {
                  avatarHtml = `<div style="width:24px;height:24px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">${displayName[0] || 'U'}</div>`;
                }
              }
            } catch (error) {
              console.warn('Could not fetch comment user profile:', error);
            }
          }
          
          const canDelete = (currentUserId && (currentUserId === c.user_id || (postOwnerId && currentUserId === postOwnerId)));
          const delBtn = canDelete ? `<button onclick=\"deleteComment('${c.id}','${postId}')\" style=\"background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer;\">Hapus</button>` : '';
          
          // Get replies for this comment
          const replies = await getCommentReplies(c.id);
          
          // Ensure username is not empty
          const replyUsername = username || displayName || 'user';
          console.log('Comment template data:', { commentId: c.id, username: replyUsername, displayName });
          
          return `<div class=\"comment-item\" style=\"display:flex;gap:8px;align-items:flex-start;margin:6px 0;\">
                    ${avatarHtml}
                    <div class=\"comment-body\" style=\"flex:1;min-width:0;\">
                      <div style=\"display:flex;justify-content:space-between;gap:8px;align-items:center;\">
                        <div style=\"font-size:12px;color:#374151;font-weight:600;display:flex;align-items:center;\">
                            ${c.identity === 'anonymous' 
                                ? `<span style=\"color: #374151; cursor: default;\" title=\"User anonim - profil tidak dapat diakses\">${displayName}</span>`
                                : `<span onclick=\"navigateToUserProfile('${c.user_id}')\" style=\"cursor: pointer; color: #374151; text-decoration: none;\" onmouseover=\"this.style.color='#1f2937'; this.style.textDecoration='underline';\" onmouseout=\"this.style.color='#374151'; this.style.textDecoration='none';\">${displayName}</span>`
                            }${verifiedBadge} <span style=\"color:#9ca3af;font-weight:400;\">• ${when}</span>
                        </div>
                        ${delBtn}
                      </div>
                      <div style=\"font-size:13px;color:#374151;line-height:1.5;word-wrap:break-word;\">${highlightMentions(escapeHtml(c.content))}</div>
                      <div style=\"margin-top:4px;display:flex;gap:12px;align-items:center;\">
                        <button onclick=\"startReply('${postId}', '${c.id}', '${replyUsername}')\" style=\"background:none;border:none;color:#6b7280;font-size:12px;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;\">
                          <svg width=\"12\" height=\"12\" fill=\"currentColor\" viewBox=\"0 0 20 20\">
                            <path fill-rule=\"evenodd\" d=\"M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z\" clip-rule=\"evenodd\"/>
                          </svg>
                          Balas
                        </button>
                        ${replies.length > 0 ? `<span style=\"color:#6b7280;font-size:12px;\">${replies.split('reply-item').length - 1} balasan</span>` : ''}
                      </div>
                      ${replies.length > 0 ? `<div class=\"replies\" style=\"margin-left:16px;margin-top:8px;border-left:2px solid #e5e7eb;padding-left:12px;\">${replies}</div>` : ''}
                    </div>
                  </div>`;
        }));
        container.innerHTML = `<div class=\"comments-list\" style=\"background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:8px;\">${items.join('')}</div>`;
      } catch (_) {
        container.innerHTML = '';
      }
    }

    function toggleComments(postId) {
      const container = document.getElementById(`comments-${postId}`);
      const btn = document.getElementById(`comments-toggle-${postId}`);
      if (!container || !btn) return;
      const isHidden = container.style.display === 'none';
      if (isHidden) {
        if (!container.getAttribute('data-loaded')) {
          renderCommentsForPost(postId).then(() => {
            container.setAttribute('data-loaded', 'true');
          });
        }
        container.style.display = 'block';
        btn.textContent = 'Sembunyikan komentar';
      } else {
        container.style.display = 'none';
        btn.textContent = 'Lihat komentar';
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Render comments in the comment modal
    async function renderCommentsInModal(postId) {
      const host = document.getElementById('modalComments');
      if (!host || !postId) return;
      host.innerHTML = '<div style="font-size:12px;color:#6b7280;">Memuat komentar...</div>';
      if (!supabase) { host.innerHTML = ''; return; }
      const { data: rows, error } = await supabase
        .from('post_comments')
        .select('id, user_id, content, identity, created_at, parent_comment_id, mentioned_users')
        .eq('post_id', postId)
        .is('parent_comment_id', null) // Only get top-level comments
        .order('created_at', { ascending: true })
        .limit(100);
      if (error) { host.innerHTML = '<div style="font-size:12px;color:#dc2626;">Gagal memuat komentar.</div>'; return; }
      if (!rows || rows.length === 0) { host.innerHTML = '<div style="font-size:12px;color:#6b7280;">Belum ada komentar.</div>'; return; }
      const items = await Promise.all(rows.map(async c => {
        const when = getTimeAgo(new Date(c.created_at));
        
        // Handle different identity types for comments
        let displayName = 'Pengguna';
        let username = '';
        let avatarHtml = '<div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">U</div>';
        let verifiedBadge = '';
        
        if (c.identity === 'anonymous') {
          // Anonymous comment - hide all identity information
          displayName = 'Anonim';
          avatarHtml = '<div style="width:20px;height:20px;border-radius:9999px;background:#6b7280;color:white;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">A</div>';
        } else {
          // Get user profile for non-anonymous comment author
          try {
            const { data: profile, error } = await supabase
              .from('profiles')
              .select('*')
              .eq('id', c.user_id)
              .single();
            
            if (!error && profile) {
              displayName = profile.full_name || 'Pengguna';
              username = profile.username || profile.full_name || 'user';
              
              // Check if user is verified
              if (profile.is_verified === true) {
                verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; margin-left: 4px;" title="Verified Account">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Simple blue circle -->
                    <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                    <!-- White checkmark in center -->
                    <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>`;
              }
              
              // Create avatar based on profile
              if (profile.avatar_url && profile.avatar_url !== 'NULL') {
                avatarHtml = `<img src="${profile.avatar_url}" alt="${displayName}" style="width:20px;height:20px;border-radius:9999px;object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:none;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${displayName[0] || 'U'}</div>`;
              } else {
                avatarHtml = `<div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${displayName[0] || 'U'}</div>`;
              }
            }
          } catch (error) {
            console.warn('Could not fetch comment user profile:', error);
          }
        }
        
        // Ensure username is not empty
        const replyUsername = username || displayName || 'user';
        
        return `<div style=\"display:flex;gap:8px;align-items:flex-start;margin:6px 0;\">
                  ${avatarHtml}
                  <div style=\"flex:1;min-width:0;\">
                    <div style=\"font-size:12px;color:#374151;font-weight:600;display:flex;align-items:center;\">
                      ${c.identity === 'anonymous' 
                        ? `<span style=\"color: #374151; cursor: default;\" title=\"User anonim - profil tidak dapat diakses\">${displayName}</span>`
                        : `<span onclick=\"navigateToUserProfile('${c.user_id}')\" style=\"cursor: pointer; color: #374151; text-decoration: none;\" onmouseover=\"this.style.color='#1f2937'; this.style.textDecoration='underline';\" onmouseout=\"this.style.color='#374151'; this.style.textDecoration='none';\">${displayName}</span>`
                      }${verifiedBadge} <span style=\"color:#9ca3af;font-weight:400;\">• ${when}</span>
                    </div>
                    <div style=\"font-size:13px;color:#374151;line-height:1.5;word-wrap:break-word;\">${highlightMentions(escapeHtml(c.content))}</div>
                    <div style=\"margin-top:4px;display:flex;gap:12px;align-items:center;\">
                      <button onclick=\"startReply('${postId}', '${c.id}', '${replyUsername}')\" style=\"background:none;border:none;color:#6b7280;font-size:12px;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;\">
                        <svg width=\"12\" height=\"12\" fill=\"currentColor\" viewBox=\"0 0 20 20\">
                          <path fill-rule=\"evenodd\" d=\"M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z\" clip-rule=\"evenodd\"/>
                        </svg>
                        Balas
                      </button>
                    </div>
                  </div>
                </div>`;
      }));
      host.innerHTML = items.join('');
      try { host.scrollTop = host.scrollHeight; } catch (_) {}
    }
    
    // Post interaction functions
    async function likePost(postId) {
      try {
        // Check if Supabase is available
        if (!supabase) {
          showNotification('Database tidak tersedia. Silakan refresh halaman.', 'error');
          return;
        }
        
        // Get current user with timeout
        const userPromise = supabase.auth.getUser();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Authentication timeout')), 5000)
        );
        
        const { data: { user }, error: userError } = await Promise.race([
          userPromise, 
          timeoutPromise
        ]);
        
        if (userError || !user) {
          if (userError && userError.message.includes('timeout')) {
            showNotification('Koneksi timeout. Coba lagi.', 'error');
          } else {
          showNotification('Silakan login terlebih dahulu untuk memberikan like!', 'error');
          }
          return;
        }

        console.log('Like post:', postId, 'by user:', user.id);

        // Check if user already liked this post
        const { data: existingLike, error: checkError } = await supabase
          .from('post_likes')
          .select('id')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking like:', checkError);
          showNotification('Error checking like: ' + checkError.message, 'error');
          return;
        }

        if (existingLike) {
          // Unlike the post
          const { error: deleteError } = await supabase
            .from('post_likes')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id);

          if (deleteError) {
            console.error('Error removing like:', deleteError);
            showNotification('Error removing like: ' + deleteError.message, 'error');
            return;
          }
          
          // Update UI
          updateLikeButton(postId, false);
          showNotification('Like dihapus!', 'info');
        } else {
          // Like the post
          const { data, error: insertError } = await supabase
            .from('post_likes')
            .insert({
              post_id: postId,
              user_id: user.id
            })
            .select();

          if (insertError) {
            console.error('Error adding like:', insertError);
            showNotification('Error adding like: ' + insertError.message, 'error');
            return;
          }
          
          console.log('Like added successfully:', data);
          
          // Create notification for post author
          try {
            console.log('🔔 Creating like notification for post:', postId);
            const { data: postData, error: postError } = await supabase
              .from('posts')
              .select('user_id')
              .eq('id', postId)
              .single();
            
            console.log('📊 Post data:', postData, 'Error:', postError);
            console.log('👤 Current user ID:', user.id, 'Post author ID:', postData?.user_id);
            
            if (!postError && postData && postData.user_id !== user.id) {
              console.log('✅ Creating like notification...');
              const { data: notificationData, error: notificationError } = await supabase.rpc('create_like_notification', {
                p_post_author_id: postData.user_id,
                p_liker_id: user.id,
                p_post_id: postId
              });
              
              if (notificationError) {
                console.error('❌ Error creating like notification:', notificationError);
              } else {
                console.log('✅ Like notification created successfully:', notificationData);
              }
            } else {
              console.log('⏭️ Skipping notification (own post or error)');
            }
          } catch (notificationError) {
            console.error('❌ Error in like notification process:', notificationError);
          }
          
          // Update UI
          updateLikeButton(postId, true);
          showNotification('Postingan disukai!', 'success');
        }

        // Refresh like count
        updateLikeCount(postId);
        
      } catch (error) {
        console.error('Error in likePost:', error);
        
        // Handle specific error types
        let errorMessage = 'Terjadi kesalahan saat memberikan like!';
        
        if (error.message.includes('Network disconnected') || 
            error.message.includes('Network') || 
            error.message.includes('fetch')) {
          errorMessage = 'Koneksi jaringan terputus. Periksa koneksi internet Anda.';
        } else if (error.message.includes('timeout')) {
          errorMessage = 'Koneksi timeout. Coba lagi.';
        } else if (error.message.includes('auth') || error.message.includes('Authentication')) {
          errorMessage = 'Masalah autentikasi. Silakan login ulang.';
        }
        
        showNotification(errorMessage, 'error');
      }
    }
    
    // Global variable to store current post ID for commenting
    let currentCommentPostId = null;

    async function commentPost(postId) {
      try {
        // Check if Supabase is available
        if (!supabase) {
          showNotification('Database tidak tersedia. Silakan refresh halaman.', 'error');
          return;
        }
        
        // Check if user is authenticated with timeout
        const userPromise = supabase.auth.getUser();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Authentication timeout')), 5000)
        );
        
        const { data: { user }, error: authError } = await Promise.race([
          userPromise, 
          timeoutPromise
        ]);
        
      if (authError || !user) {
          if (authError && authError.message.includes('timeout')) {
            showNotification('Koneksi timeout. Coba lagi.', 'error');
          } else {
        showNotification('Silakan login terlebih dahulu untuk berkomentar!', 'error');
          }
        return;
      }

      // Tampilkan daftar komentar terlebih dahulu di bawah post
      try {
        const container = document.getElementById(`comments-${postId}`);
        if (container) {
          if (!container.getAttribute('data-loaded')) {
            await renderCommentsForPost(postId);
            container.setAttribute('data-loaded', 'true');
          }
          container.style.display = 'block';
        }
        const toggleBtn = document.getElementById(`comments-toggle-${postId}`);
        if (toggleBtn) toggleBtn.textContent = 'Sembunyikan komentar';
      } catch (_) {}

      currentCommentPostId = postId;
      openCommentModal(postId);
        
      } catch (error) {
        console.error('Error in commentPost:', error);
        
        // Handle specific error types
        let errorMessage = 'Terjadi kesalahan saat membuka komentar!';
        
        if (error.message.includes('Network disconnected') || 
            error.message.includes('Network') || 
            error.message.includes('fetch')) {
          errorMessage = 'Koneksi jaringan terputus. Periksa koneksi internet Anda.';
        } else if (error.message.includes('timeout')) {
          errorMessage = 'Koneksi timeout. Coba lagi.';
        } else if (error.message.includes('auth') || error.message.includes('Authentication')) {
          errorMessage = 'Masalah autentikasi. Silakan login ulang.';
        }
        
        showNotification(errorMessage, 'error');
      }
    }

    function openCommentModal(postId) {
      const modal = document.getElementById('commentModal');
      const textarea = document.getElementById('commentText');
      
      // Set current comment post ID
      if (postId) {
        currentCommentPostId = postId;
      }
      
      modal.style.display = 'block';
      textarea.value = '';
      textarea.focus();
      // Load modal comments for current post
      try { renderCommentsInModal(currentCommentPostId); } catch (_) {}
      
      // Close emoji picker if open
      const emojiPicker = document.getElementById('commentEmojiPicker');
      if (emojiPicker) emojiPicker.style.display = 'none';
    }

    function closeCommentModal() {
      const modal = document.getElementById('commentModal');
      modal.style.display = 'none';
      currentCommentPostId = null;
    }

    function toggleCommentEmojiPicker() {
      const emojiPicker = document.getElementById('commentEmojiPicker');
      if (!emojiPicker) return;
      const visible = emojiPicker.style.display === 'block';
      emojiPicker.style.display = visible ? 'none' : 'block';
    }

    function insertCommentEmoji(emoji) {
      const textarea = document.getElementById('commentText');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
      
      // Close emoji picker
      const emojiPicker = document.getElementById('commentEmojiPicker');
      if (emojiPicker) emojiPicker.style.display = 'none';
    }

    async function submitComment() {
      const commentText = document.getElementById('commentText').value.trim();
      
      if (!commentText) {
        showNotification('Komentar tidak boleh kosong!', 'error');
        return;
      }

      if (!currentCommentPostId) {
        showNotification('Error: Post ID tidak ditemukan!', 'error');
        return;
      }

      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk berkomentar!', 'error');
          return;
        }

        console.log('Adding comment for post:', currentCommentPostId, 'by user:', user.id);
        console.log('DEBUG: currentCommentPostId type:', typeof currentCommentPostId);
        console.log('DEBUG: user.id type:', typeof user.id);

        // Get current user's identity from profile
        let userIdentity = 'custom_anon'; // default
        try {
          const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('identity')
            .eq('id', user.id)
            .single();
          
          if (!profileError && profile && profile.identity) {
            userIdentity = profile.identity;
          }
        } catch (error) {
          console.warn('Could not fetch user identity for comment:', error);
        }

        // Extract mentions from comment text
        const mentionedUsernames = extractMentions(commentText);
        const mentionedUserIds = [];
        
        // Get user IDs for mentioned usernames
        for (const username of mentionedUsernames) {
          const userId = await getUserIdFromUsername(username);
          if (userId) {
            mentionedUserIds.push(userId);
          }
        }
        
        // Insert comment with reply and mention support
        const { data, error: insertError } = await supabase
          .from('post_comments')
          .insert({
            post_id: currentCommentPostId,
            user_id: user.id,
            content: commentText,
            identity: userIdentity,
            parent_comment_id: currentReplyToCommentId || null,
            mentioned_users: mentionedUserIds.length > 0 ? mentionedUserIds : null
          })
          .select();

        if (insertError) {
          console.error('Error adding comment:', insertError);
          showNotification('Gagal menambahkan komentar: ' + insertError.message, 'error');
          return;
        }

        console.log('Comment added successfully:', data);
        
        // Create notification for post author or comment author
        try {
          if (currentReplyToCommentId) {
            // This is a reply to a comment
            console.log('🔔 Creating reply notification for comment:', currentReplyToCommentId);
            const { data: commentData, error: commentError } = await supabase
              .from('post_comments')
              .select('user_id')
              .eq('id', currentReplyToCommentId)
              .single();
            
            console.log('📊 Comment data:', commentData, 'Error:', commentError);
            console.log('👤 Current user ID:', user.id, 'Comment author ID:', commentData?.user_id);
            
            if (!commentError && commentData && commentData.user_id !== user.id) {
              console.log('✅ Creating reply notification...');
              const { data: notificationData, error: notificationError } = await supabase.rpc('create_reply_notification', {
                p_comment_author_id: commentData.user_id,
                p_replier_id: user.id,
                p_post_id: currentCommentPostId,
                p_comment_id: currentReplyToCommentId,
                p_reply_preview: commentText
              });
              
              if (notificationError) {
                console.error('❌ Error creating reply notification:', notificationError);
              } else {
                console.log('✅ Reply notification created successfully:', notificationData);
              }
            } else {
              console.log('⏭️ Skipping reply notification (own comment or error)');
            }
          } else {
            // This is a comment on a post
            console.log('🔔 Creating comment notification for post:', currentCommentPostId);
            const { data: postData, error: postError } = await supabase
              .from('posts')
              .select('user_id')
              .eq('id', currentCommentPostId)
              .single();
            
            console.log('📊 Post data:', postData, 'Error:', postError);
            console.log('👤 Current user ID:', user.id, 'Post author ID:', postData?.user_id);
            
            if (!postError && postData && postData.user_id !== user.id) {
              console.log('✅ Creating comment notification...');
              const { data: notificationData, error: notificationError } = await supabase.rpc('create_comment_notification', {
                p_post_author_id: postData.user_id,
                p_commenter_id: user.id,
                p_post_id: currentCommentPostId,
                p_comment_preview: commentText
              });
              
              if (notificationError) {
                console.error('❌ Error creating comment notification:', notificationError);
              } else {
                console.log('✅ Comment notification created successfully:', notificationData);
              }
            } else {
              console.log('⏭️ Skipping comment notification (own post or error)');
            }
          }
        } catch (notificationError) {
          console.error('❌ Error in notification process:', notificationError);
        }
        
        showNotification('Komentar berhasil ditambahkan!', 'success');
        
        // Reset reply state
        cancelReply();
        
        // Save postId before closing modal
        const postIdToUpdate = currentCommentPostId;
        
        // Close modal and refresh comment count and list
        closeCommentModal();
        updateCommentCount(postIdToUpdate);
        try { renderCommentsForPost(postIdToUpdate); } catch (_) {}
        
      } catch (error) {
        console.error('Error in submitComment:', error);
        showNotification('Terjadi kesalahan saat menambahkan komentar!', 'error');
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('commentModal');
      if (event.target === modal) {
        closeCommentModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeCommentModal();
      }
    });

    // Close emoji picker when clicking outside
    document.addEventListener('click', function(event) {
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiBtn = document.querySelector('.emoji-btn');
      
      if (emojiPicker && emojiPicker.style.display === 'block') {
        if (!emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
          emojiPicker.style.display = 'none';
        }
      }
    });
    
    async function savePost(postId) {
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk menyimpan postingan!', 'error');
          return;
        }

        console.log('Save post:', postId, 'by user:', user.id);

        // Check if user already saved this post
        const { data: existingSave, error: checkError } = await supabase
          .from('post_saves')
          .select('id')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking save:', checkError);
          showNotification('Error checking save: ' + checkError.message, 'error');
          return;
        }

        if (existingSave) {
          // Unsave the post
          const { error: deleteError } = await supabase
            .from('post_saves')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id);

          if (deleteError) {
            console.error('Error removing save:', deleteError);
            showNotification('Error removing save: ' + deleteError.message, 'error');
            return;
          }
          
          // Update UI
          updateSaveButton(postId, false);
          showNotification('Postingan dihapus dari simpanan!', 'info');
          // Notify profile/archive to refresh if loaded
          try {
            window.dispatchEvent(new CustomEvent('postSaveChanged', { detail: { postId, action: 'unsaved' } }));
            if (typeof loadSavedPosts === 'function') {
              console.log('Reloading archive after unsave');
              loadSavedPosts();
            }
          } catch (_) {}
        } else {
          // Save the post
          const { data, error: insertError } = await supabase
            .from('post_saves')
            .insert({
              post_id: postId,
              user_id: user.id
            })
            .select();

          if (insertError) {
            console.error('Error adding save:', insertError);
            showNotification('Error adding save: ' + insertError.message, 'error');
            return;
          }
          
          console.log('Save added successfully:', data);
          // Update UI
          updateSaveButton(postId, true);
          showNotification('Postingan disimpan!', 'success');
          // Notify profile/archive to refresh if loaded
          try {
            window.dispatchEvent(new CustomEvent('postSaveChanged', { detail: { postId, action: 'saved' } }));
            if (typeof loadSavedPosts === 'function') {
              console.log('Reloading archive after save');
              loadSavedPosts();
            }
          } catch (_) {}
        }
        
      } catch (error) {
        console.error('Error in savePost:', error);
        showNotification('Terjadi kesalahan saat menyimpan postingan!', 'error');
      }
    }

    async function followPost(postId) {
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk mem-pin postingan!', 'error');
          return;
        }

        console.log('Pin post:', postId, 'by user:', user.id);

        // Check if user already pinned this post
        const { data: existingPin, error: checkError } = await supabase
          .from('post_pins')
          .select('id')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking pin:', checkError);
          showNotification('Error checking pin: ' + checkError.message, 'error');
          return;
        }

        if (existingPin) {
          // Unpin the post
          const { error: deleteError } = await supabase
            .from('post_pins')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id);

          if (deleteError) {
            console.error('Error removing pin:', deleteError);
            showNotification('Error removing pin: ' + deleteError.message, 'error');
            return;
          }
          
          // Update UI
          updateFollowButton(postId, false);
          showNotification('Postingan tidak di-pin lagi!', 'info');
        } else {
          // Pin the post
          const { data, error: insertError } = await supabase
            .from('post_pins')
            .insert({
              post_id: postId,
              user_id: user.id
            })
            .select();

          if (insertError) {
            console.error('Error adding pin:', insertError);
            showNotification('Error adding pin: ' + insertError.message, 'error');
            return;
          }
          
          console.log('Pin added successfully:', data);
          // Update UI
          updateFollowButton(postId, true);
          showNotification('Postingan di-pin!', 'success');
        }
        
      } catch (error) {
        console.error('Error in followPost (pin):', error);
        showNotification('Terjadi kesalahan saat mem-pin postingan!', 'error');
      }
    }
    
    function sharePost(postId) {
      const postUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Postingan dari SpeakUp!',
          text: 'Lihat postingan menarik ini di SpeakUp!',
          url: postUrl
        }).catch(err => {
          console.log('Error sharing:', err);
          fallbackShare(postUrl);
        });
      } else {
        fallbackShare(postUrl);
      }
    }
    
    function fallbackShare(url) {
      navigator.clipboard.writeText(url).then(() => {
        showNotification('Link berhasil disalin ke clipboard!', 'success');
      }).catch(() => {
        // Fallback untuk browser lama
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Link berhasil disalin ke clipboard!', 'success');
      });
    }
    
    // Helper functions for UI updates
    function updateLikeButton(postId, isLiked) {
      const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
      if (likeBtn) {
        if (isLiked) {
          likeBtn.classList.add('liked');
          likeBtn.title = 'Unlike';
          // Force color change
          likeBtn.style.color = '#38bdf8';
          likeBtn.style.setProperty('color', '#38bdf8', 'important');
          const svg = likeBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '#38bdf8';
            svg.style.fill = '#38bdf8';
            svg.style.setProperty('color', '#38bdf8', 'important');
            svg.style.setProperty('fill', '#38bdf8', 'important');
          }
        } else {
          likeBtn.classList.remove('liked');
          likeBtn.title = 'Like';
          // Reset color
          likeBtn.style.color = '';
          likeBtn.style.removeProperty('color');
          const svg = likeBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '';
            svg.style.fill = '';
            svg.style.removeProperty('color');
            svg.style.removeProperty('fill');
          }
        }
      }
    }
    
    function updateSaveButton(postId, isSaved) {
      const saveBtn = document.querySelector(`button[onclick="savePost('${postId}')"]`);
      if (saveBtn) {
        if (isSaved) {
          saveBtn.classList.add('saved');
          saveBtn.title = 'Hapus dari simpanan';
          // Force color change
          saveBtn.style.color = '#38bdf8';
          saveBtn.style.setProperty('color', '#38bdf8', 'important');
          const svg = saveBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '#38bdf8';
            svg.style.fill = '#38bdf8';
            svg.style.setProperty('color', '#38bdf8', 'important');
            svg.style.setProperty('fill', '#38bdf8', 'important');
          }
        } else {
          saveBtn.classList.remove('saved');
          saveBtn.title = 'Simpan';
          // Reset color
          saveBtn.style.color = '';
          saveBtn.style.removeProperty('color');
          const svg = saveBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '';
            svg.style.fill = '';
            svg.style.removeProperty('color');
            svg.style.removeProperty('fill');
          }
        }
      }
    }

    function updateFollowButton(postId, isFollowed) {
      const followBtn = document.querySelector(`button[onclick="followPost('${postId}')"]`);
      if (followBtn) {
        if (isFollowed) {
          followBtn.classList.add('followed');
          followBtn.title = 'Unpin Post';
          // Force color change
          followBtn.style.color = '#38bdf8';
          followBtn.style.setProperty('color', '#38bdf8', 'important');
          const svg = followBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '#38bdf8';
            svg.style.fill = '#38bdf8';
            svg.style.setProperty('color', '#38bdf8', 'important');
            svg.style.setProperty('fill', '#38bdf8', 'important');
          }
        } else {
          followBtn.classList.remove('followed');
          followBtn.title = 'Pin Post';
          // Reset color
          followBtn.style.color = '';
          followBtn.style.removeProperty('color');
          const svg = followBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '';
            svg.style.fill = '';
            svg.style.removeProperty('color');
            svg.style.removeProperty('fill');
          }
        }
      }
    }

    // Repost function
    async function repostPost(postId) {
      try {
        // Check if user is logged in
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk repost!', 'error');
          return;
        }

        // Check if user already reposted this post
        const { data: existingRepost, error: checkError } = await supabase
          .from('post_reposts')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking repost:', checkError);
          return;
        }

        if (existingRepost) {
          // Unrepost the post
          const { error: deleteError } = await supabase
            .from('post_reposts')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id);

          if (deleteError) {
            console.error('Error removing repost:', deleteError);
            return;
          }
          
          showNotification('Repost dihapus!', 'info');
        } else {
          // Repost the post
          const { error: insertError } = await supabase
            .from('post_reposts')
            .insert({
              post_id: postId,
              user_id: user.id,
              created_at: new Date().toISOString()
            });

          if (insertError) {
            console.error('Error adding repost:', insertError);
            return;
          }
          
          // Create notification for original post author
          try {
            const { data: postData, error: postError } = await supabase
              .from('posts')
              .select('user_id')
              .eq('id', postId)
              .single();
            
            if (!postError && postData && postData.user_id !== user.id) {
              await supabase.rpc('create_notification', {
                p_user_id: postData.user_id,
                p_type: 'repost',
                p_message: 'Seseorang merepost postingan Anda',
                p_related_user_id: user.id,
                p_related_post_id: postId,
                p_related_comment_id: null
              });
              console.log('Repost notification created');
            }
          } catch (notificationError) {
            console.error('Error creating repost notification:', notificationError);
          }
          
          showNotification('Post berhasil di-repost!', 'success');
        }

        // Refresh repost count
        updateRepostCount(postId);
        
      } catch (error) {
        console.error('Error in repostPost:', error);
        showNotification('Terjadi kesalahan saat repost!', 'error');
      }
    }

    // Update repost count and status
    async function updateRepostCount(postId) {
      try {
        const { data, error } = await supabase
          .from('post_reposts')
          .select('id', { count: 'exact' })
          .eq('post_id', postId);
        
        if (!error && data !== null) {
          const repostBtn = document.querySelector(`button[onclick="repostPost('${postId}')"]`);
          if (repostBtn) {
            const countSpan = repostBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = data.length || 0;
            }
          }
        }
        
        // Check if current user has reposted this post
        await checkRepostStatus(postId);
      } catch (error) {
        console.warn('Repost count request failed:', error);
      }
    }
    
    // Check if current user has reposted a post and update button appearance
    async function checkRepostStatus(postId) {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          return; // User not logged in, no need to check
        }
        
        const { data: existingRepost, error: checkError } = await supabase
          .from('post_reposts')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();
        
        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking repost status:', checkError);
          return;
        }
        
        const repostBtn = document.querySelector(`button[onclick="repostPost('${postId}')"]`);
        if (repostBtn) {
          if (existingRepost) {
            // User has reposted this post - make button blue
            repostBtn.classList.add('reposted');
            repostBtn.style.color = '#38bdf8';
            repostBtn.title = 'Hapus repost';
            
            // Also make the SVG blue
            const svg = repostBtn.querySelector('svg');
            if (svg) {
              svg.style.color = '#38bdf8';
              svg.style.fill = '#38bdf8';
            }
          } else {
            // User hasn't reposted this post - make button normal
            repostBtn.classList.remove('reposted');
            repostBtn.style.color = '';
            repostBtn.title = 'Repost';
            
            // Reset SVG color
            const svg = repostBtn.querySelector('svg');
            if (svg) {
              svg.style.color = '';
              svg.style.fill = '';
            }
          }
        }
      } catch (error) {
        console.warn('Error checking repost status:', error);
      }
    }
    
    async function updateLikeCount(postId) {
      try {
        const { data, error } = await supabase
          .from('post_likes')
          .select('id')
          .eq('post_id', postId);
        
        if (!error && data) {
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = data.length || 0;
            }
          }
        } else {
          console.log('Like count error or no data:', error);
        }
      } catch (error) {
        console.log('Error updating like count:', error);
      }
    }
    
    async function updateCommentCount(postId) {
      try {
        console.log('DEBUG: updateCommentCount called with postId:', postId);
        console.log('DEBUG: postId type:', typeof postId);
        
        if (!postId || postId === 'null' || postId === 'undefined') {
          console.error('Invalid postId in updateCommentCount:', postId);
          return;
        }
        
        const { data, error } = await supabase
          .from('post_comments')
          .select('id')
          .eq('post_id', postId);
        
        if (!error && data) {
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = data.length || 0;
            }
          }
        } else {
          console.log('Comment count error or no data:', error);
        }
      } catch (error) {
        console.log('Error updating comment count:', error);
      }
    }
    
    // Delete a comment (allowed for comment owner or post owner via RLS policies)
    async function deleteComment(commentId, postId) {
      try {
        if (!commentId) return;
        // Auth check
        const { data: { user }, error: userErr } = await supabase.auth.getUser();
        if (userErr || !user) { showNotification('Silakan login untuk menghapus komentar.', 'error'); return; }
        
        // Optional confirm
        const agreed = confirm('Hapus komentar ini?');
        if (!agreed) return;
        
        const { error } = await supabase
          .from('post_comments')
          .delete()
          .eq('id', commentId);
        
        if (error) { showNotification('Gagal menghapus komentar: ' + error.message, 'error'); return; }
        
        try { window.showToast('Komentar berhasil dihapus', 'success'); } catch(_) {}
        // Refresh list & count
        try { renderCommentsForPost(postId); } catch(_) {}
        try { updateCommentCount(postId); } catch(_) {}
      } catch (e) {
        console.error('deleteComment error:', e);
        showNotification('Terjadi kesalahan saat menghapus komentar.', 'error');
      }
    }
    
    function showNotification(message, type = 'info') {
      // Unified toast style (bottom-center), subtle like comment-deleted notice
      const hostId = 'su-toast-host';
      let host = document.getElementById(hostId);
      if (!host) {
        host = document.createElement('div');
        host.id = hostId;
        host.style.cssText = `
          position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
          display: flex; flex-direction: column; gap: 8px; align-items: center;
          z-index: 10000; pointer-events: none;`;
        document.body.appendChild(host);
      }

      const toast = document.createElement('div');
      toast.style.cssText = `
        background: #111827; color: #ffffff !important; border-radius: 9999px;
        padding: 10px 14px; font-size: 13px; font-weight: 500;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.08);
        opacity: 0; transform: translateY(8px); transition: all .25s ease;
        pointer-events: auto; white-space: nowrap; max-width: 90vw; overflow: hidden; text-overflow: ellipsis;`;

      // Accent dot
      const dot = document.createElement('span');
      dot.style.cssText = 'display:inline-block;width:8px;height:8px;border-radius:9999px;margin-right:8px;vertical-align:middle;';
      if (type === 'success') dot.style.background = '#10b981';
      else if (type === 'error') dot.style.background = '#ef4444';
      else if (type === 'warning') dot.style.background = '#f59e0b';
      else dot.style.background = '#60a5fa';

      const text = document.createElement('span');
      text.textContent = message;

      toast.appendChild(dot);
      toast.appendChild(text);
      host.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      });

      // Auto remove
      const lifetimeMs = 2400;
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(8px)';
        setTimeout(() => {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
          if (host && host.children.length === 0 && host.parentNode) host.parentNode.removeChild(host);
        }, 250);
      }, lifetimeMs);
    }
        
        // Function to get current user profile data from Supabase
        async function getUserProfile() {
            try {
                // Get current user from Supabase
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    console.error('Error getting user:', userError);
                    return getFallbackProfile();
                }
                
                console.log('Current user:', user);
                
                // Get user profile from profiles table
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    console.error('Error getting profile:', profileError);
                    console.log('Profile error details:', {
                        message: profileError.message,
                        details: profileError.details,
                        hint: profileError.hint,
                        code: profileError.code
                    });
                    return getFallbackProfile();
                }
                
                if (!profile) {
                    console.log('No profile found for user:', user.id);
                    return getFallbackProfile();
                }
                
                console.log('User profile from database:', profile);
                console.log('Available profile fields:', Object.keys(profile));
                console.log('Profile image field:', profile.profile_image);
                console.log('Avatar URL field:', profile.avatar_url);
                console.log('Full name field:', profile.full_name);
                console.log('Name field:', profile.name);
                console.log('Avatar URL type:', typeof profile.avatar_url);
                console.log('Avatar URL length:', profile.avatar_url ? profile.avatar_url.length : 'null/undefined');
                
                const userProfile = {
                    name: profile.name || user.email?.split('@')[0] || 'Pengguna',
                    full_name: profile.full_name || profile.name || user.email?.split('@')[0] || 'Pengguna',
                    profile_image: profile.avatar_url || profile.profile_image || 'assets/img/profil picture/default-avatar.jpg',
                    profession: profile.title || profile.profession || '',
                    title: profile.title || profile.profession || '',
                    is_verified: profile.is_verified || false
                };
                
                console.log('Processed user profile:', userProfile);
                return userProfile;
                
            } catch (error) {
                console.error('Error in getUserProfile:', error);
                return getFallbackProfile();
            }
        }
        
        function getFallbackProfile() {
            return {
                name: 'Pengguna',
                full_name: 'Pengguna',
                profile_image: 'assets/img/profil picture/default-avatar.jpg',
                profession: '',
                title: '',
                is_verified: false
            };
        }
        
        // Action functions - removed old alert versions
    
        // Navigation and authentication functions (copied from desktop.html)
    function updateNavigationForLoggedInUser() {
            console.log('Updating navigation for logged in user...');
            
            // Show all navigation items
            const navItems = document.querySelectorAll('.desktop-nav .nav-item');
            navItems.forEach(item => {
                item.style.display = 'flex';
            });
            
            // Convert Login button to Logout button
            const signButton = document.getElementById('signButton');
            if (signButton) {
                signButton.innerHTML = `
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                    </svg>
                    <span>Logout</span>
                `;
                signButton.onclick = function() {
                    window.location.href = './sign-desktop.html';
                };
            }
            
            // Show Speak! button
            const speakButton = document.querySelector('.plus-btn');
            if (speakButton) {
                speakButton.style.display = 'flex';
            }
            
            // Handle Profile button click to go to own profile
            const profileButton = document.querySelector('a[href="./profile-desktop.html"]');
            if (profileButton) {
                profileButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Navigate to own profile (without URL parameter)
                    window.location.href = 'profile-desktop.html';
                });
            }
            
            // Show dashboard-only navigation items
            const dashboardItems = document.querySelectorAll('.dashboard-only');
            dashboardItems.forEach(item => {
                item.style.display = 'flex';
            });
    }
    
    function updateNavigationForHomepage() {
            console.log('Updating navigation for homepage...');
            
            // Show only Home and Login navigation items
            const navItems = document.querySelectorAll('.desktop-nav .nav-item');
            navItems.forEach(item => {
                if (item.textContent.includes('Home') || 
                    item.textContent.includes('Login')) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Hide Speak! button
            const speakButton = document.querySelector('.plus-btn');
            if (speakButton) {
                speakButton.style.display = 'none';
            }
            
            // Hide dashboard-only navigation items
            const dashboardItems = document.querySelectorAll('.dashboard-only');
            dashboardItems.forEach(item => {
                item.style.display = 'none';
            });
        }
        
        async function checkAuthenticationStatus() {
            const { data: { user }, error } = await supabase.auth.getUser();
            console.log('Authentication status:', user ? 'logged in' : 'not logged in');
            
            if (user && !error) {
          updateNavigationForLoggedInUser();
        } else {
          updateNavigationForHomepage();
            }
        }
    
        // Logout handled globally in assets/js/app.js
    
    // Handle notification navigation
    function handleNotificationNavigation() {
        const urlParams = new URLSearchParams(window.location.search);
        const highlightPostId = urlParams.get('highlight');
        
        if (highlightPostId) {
            console.log('Highlighting post from notification:', highlightPostId);
            
            // Wait for posts to load, then highlight the specific post
            setTimeout(() => {
                highlightPost(highlightPostId);
            }, 2000);
        }
    }
    
    // Highlight a specific post
    function highlightPost(postId) {
        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
        if (postElement) {
            // Scroll to the post
            postElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Add highlight effect
            postElement.style.border = '3px solid #38bdf8';
            postElement.style.borderRadius = '12px';
            postElement.style.backgroundColor = '#eff6ff';
            postElement.style.transition = 'all 0.3s ease';
            
            // Remove highlight after 5 seconds
            setTimeout(() => {
                postElement.style.border = '';
                postElement.style.borderRadius = '';
                postElement.style.backgroundColor = '';
            }, 5000);
            
            console.log('Post highlighted:', postId);
        } else {
            console.log('Post not found for highlighting:', postId);
        }
    }
    
    // Load posts when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOMContentLoaded event fired!');
            console.log('Page loaded, checking authentication...');
            checkAuthenticationStatus();
        loadPosts();
        
        // Handle URL parameters for notification navigation
        handleNotificationNavigation();
            
            // Add event listener for successful post creation
            window.addEventListener('postCreated', () => {
                console.log('📢 Post created event received, reloading timeline...');
                setTimeout(() => {
                    loadPosts();
                }, 500);
            });
            
            // Ensure Speak! button works
            const speakButton = document.querySelector('[data-open-create]');
            const createModal = document.getElementById('createModal');
            const closeButton = document.getElementById('closeCreate');
            
            if (speakButton && createModal) {
                speakButton.addEventListener('click', () => {
                    createModal.classList.add('open');
                });
            }
            
            if (closeButton && createModal) {
                closeButton.addEventListener('click', () => {
                    createModal.classList.remove('open');
                });
            }
            
            // Close modal when clicking outside
            createModal.addEventListener('click', (e) => {
                if (e.target === createModal) {
                    createModal.classList.remove('open');
                }
            });
            
            // Form submission ditangani secara global oleh assets/js/app.js
        });

    // Emoji Picker Functions - Completely separate for timeline modal
    function toggleTimelineModalEmojiPicker() {
        const emojiPicker = document.getElementById('timelineEmojiPicker');
        console.log('toggleTimelineModalEmojiPicker called, emojiPicker:', emojiPicker);
        
        if (emojiPicker) {
            const rect = emojiPicker.getBoundingClientRect();
            console.log('Timeline modal emoji picker position:', rect);
            console.log('Timeline modal emoji picker computed style:', window.getComputedStyle(emojiPicker));
            
            if (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') {
                emojiPicker.style.display = 'block';
                emojiPicker.classList.add('open');
                console.log('Timeline modal emoji picker shown');
                
                // Check position after showing
                setTimeout(() => {
                    const newRect = emojiPicker.getBoundingClientRect();
                    console.log('Timeline modal emoji picker position after show:', newRect);
                }, 100);
            } else {
                emojiPicker.style.display = 'none';
                emojiPicker.classList.remove('open');
                console.log('Timeline modal emoji picker hidden');
            }
        } else {
            console.log('Timeline modal emoji picker not found!');
        }
    }

    function insertTimelineModalEmoji(emoji) {
        const textarea = document.getElementById('contentText');
        console.log('insertTimelineModalEmoji called, textarea:', textarea);
        console.log('insertTimelineModalEmoji called, emoji:', emoji);
        
        if (textarea) {
            const currentPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, currentPos);
            const textAfter = textarea.value.substring(textarea.selectionEnd);
            
            textarea.value = textBefore + emoji + textAfter;
            textarea.focus();
            textarea.setSelectionRange(currentPos + emoji.length, currentPos + emoji.length);
            
            // Hide emoji picker after selection
            const emojiPicker = document.getElementById('timelineEmojiPicker');
            if (emojiPicker) {
                emojiPicker.style.display = 'none';
                emojiPicker.classList.remove('open');
            }
            
            console.log('Timeline modal emoji inserted successfully:', emoji);
            console.log('New textarea value:', textarea.value);
        } else {
            console.log('Timeline modal contentText not found!');
        }
    }

    // Close timeline modal emoji picker when clicking outside
    document.addEventListener('click', function(e) {
        const emojiPicker = document.getElementById('timelineEmojiPicker');
        const emojiBtn = document.querySelector('[onclick="toggleTimelineModalEmojiPicker()"]');
        
        if (emojiPicker && emojiBtn && !emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
            emojiPicker.style.display = 'none';
            emojiPicker.classList.remove('open');
            console.log('Timeline modal emoji picker closed by outside click');
        }
    });

    function removeImage() {
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('previewImg').style.display = 'none';
    }

    // Speak! button functionality moved to main DOMContentLoaded above

    // Handle image upload preview
    const imageUpload = document.getElementById('imageUpload');
    if (imageUpload) {
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('previewImg');
                    const previewContainer = document.getElementById('imagePreview');
                    if (preview && previewContainer) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        previewContainer.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Function to create post in Supabase
    async function createPostToSupabase(postData) {
        try {
            // Get current user
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            console.log('🔍 Authentication check:', { user, userError });
            
            if (userError || !user) {
                console.error('❌ User not authenticated:', userError);
                showNotification('Silakan login terlebih dahulu untuk membuat post!', 'error');
                return;
            }

            console.log('✅ User authenticated:', user.id);
            console.log('📝 Creating post:', postData, 'by user:', user.id);

            // Insert post to Supabase
            console.log('Attempting to insert post with data:', {
                content: postData.content,
                category: postData.category,
                identity: postData.identity,
                want_solution: postData.want_solution,
                user_id: user.id,
                is_pinned: false
            });

            const insertData = {
                content: postData.content,
                category: postData.category,
                identity: postData.identity,
                want_solution: postData.want_solution,
                user_id: user.id,
                is_pinned: false
            };
            
            console.log('🚀 Attempting Supabase INSERT with data:', insertData);
            console.log('🔑 User ID type:', typeof user.id, 'Value:', user.id);
            console.log('📊 Content length:', postData.content ? postData.content.length : 'null');
            
            const { data, error } = await supabase
                .from('posts')
                .insert(insertData)
                .select();

            console.log('📊 Insert result - data:', data);
            console.log('❌ Insert result - error:', error);

            if (error) {
                console.error('Error creating post:', error);
                console.error('Error details:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });
                showNotification('Gagal membuat post: ' + error.message, 'error');
                return;
            }

            console.log('✅ Post created successfully:', data);
            showNotification('Post berhasil dibuat!', 'success');
            
            // Dispatch event to notify other parts of the app
            console.log('📢 Dispatching postCreated event...');
            window.dispatchEvent(new CustomEvent('postCreated', { 
                detail: { postId: data[0]?.id, postData: data[0] } 
            }));
            
            // Wait a moment for database to be consistent, then reload posts
            console.log('🔄 Waiting for database consistency...');
            setTimeout(async () => {
                console.log('🔄 Reloading posts after successful creation...');
                try {
                    await loadPosts();
                    console.log('✅ Posts reloaded successfully');
                } catch (reloadError) {
                    console.error('❌ Error reloading posts:', reloadError);
                    showNotification('Post berhasil dibuat, tapi gagal memuat ulang timeline. Silakan refresh halaman.', 'warning');
                }
            }, 1000);
            
        } catch (error) {
            console.error('Error in createPostToSupabase:', error);
            showNotification('Terjadi kesalahan saat membuat post!', 'error');
        }
    }

    // Toggle custom category input
    function toggleCustomCategory() {
      const categorySelect = document.getElementById('categorySelect');
      const customInput = document.getElementById('customCategoryInput');
      
      if (categorySelect && customInput) {
        if (categorySelect.value === 'other') {
          customInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
          // Clear custom category input when not needed
          const customInputField = customInput.querySelector('input');
          if (customInputField) {
            customInputField.value = '';
          }
        }
      }
    }

    // Form submission handler moved to DOMContentLoaded above
  </script>

  <!-- Create Post Modal -->
  <div id="createModal" class="modal" role="dialog">
    <div class="box">
      <div class="head">
        <strong>Buat Post</strong>
        <button id="closeCreate" class="btn ghost">×</button>
      </div>
      <form id="createForm">
        <div class="mt-12">
          <label>Konten</label>
          <div style="position: relative;">
            <textarea name="content" id="contentText" rows="6" maxlength="5000" required placeholder="Speak! Bagikan pengalamanmu..." style="
              width: 100%;
              min-height: 120px;
              padding: 12px 40px 12px 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              resize: vertical;
              font-family: inherit;
              font-size: 14px;
              outline: none;
              transition: border-color 0.2s;
            " onfocus="this.style.borderColor='#38bdf8'" onblur="this.style.borderColor='#d1d5db'"></textarea>
            <button type="button" onclick="toggleTimelineModalEmojiPicker()" style="
              position: absolute;
              right: 8px;
              bottom: 8px;
              background: none;
              border: none;
              font-size: 18px;
              cursor: pointer;
              padding: 4px;
              border-radius: 4px;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Pilih Emoji">
              😊
            </button>
            
            <!-- Emoji Picker for Timeline Modal -->
            <div id="timelineEmojiPicker" style="
              position: absolute;
              bottom: 10px;
              left: 10px;
              right: 50px;
              background: #ffffff;
              border: 2px solid #38bdf8;
              border-radius: 8px;
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
              padding: 12px;
              z-index: 10;
              display: none;
            ">
              <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                <button type="button" onclick="insertTimelineModalEmoji('😊')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😊</button>
                <button type="button" onclick="insertTimelineModalEmoji('😢')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😢</button>
                <button type="button" onclick="insertTimelineModalEmoji('😡')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😡</button>
                <button type="button" onclick="insertTimelineModalEmoji('😍')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😍</button>
                <button type="button" onclick="insertTimelineModalEmoji('🤔')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🤔</button>
                <button type="button" onclick="insertTimelineModalEmoji('😮')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😮</button>
                <button type="button" onclick="insertTimelineModalEmoji('😭')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😭</button>
                <button type="button" onclick="insertTimelineModalEmoji('😤')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😤</button>
                <button type="button" onclick="insertTimelineModalEmoji('🙏')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🙏</button>
                <button type="button" onclick="insertTimelineModalEmoji('❤️')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">❤️</button>
                <button type="button" onclick="insertTimelineModalEmoji('👍')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">👍</button>
                <button type="button" onclick="insertTimelineModalEmoji('👎')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">👎</button>
                <button type="button" onclick="insertTimelineModalEmoji('🔥')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🔥</button>
                <button type="button" onclick="insertTimelineModalEmoji('💪')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">💪</button>
                <button type="button" onclick="insertTimelineModalEmoji('🎉')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🎉</button>
                <button type="button" onclick="insertTimelineModalEmoji('✨')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">✨</button>
                <button type="button" onclick="insertTimelineModalEmoji('😀')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😀</button>
                <button type="button" onclick="insertTimelineModalEmoji('😃')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😃</button>
                <button type="button" onclick="insertTimelineModalEmoji('😄')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😄</button>
                <button type="button" onclick="insertTimelineModalEmoji('😁')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😁</button>
                <button type="button" onclick="insertTimelineModalEmoji('😆')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😆</button>
                <button type="button" onclick="insertTimelineModalEmoji('😅')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😅</button>
                <button type="button" onclick="insertTimelineModalEmoji('🤣')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🤣</button>
                <button type="button" onclick="insertTimelineModalEmoji('😂')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😂</button>
                <button type="button" onclick="insertTimelineModalEmoji('🙂')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🙂</button>
                <button type="button" onclick="insertTimelineModalEmoji('🙃')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🙃</button>
                <button type="button" onclick="insertTimelineModalEmoji('😉')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😉</button>
                <button type="button" onclick="insertTimelineModalEmoji('😇')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😇</button>
                <button type="button" onclick="insertTimelineModalEmoji('🥰')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🥰</button>
                <button type="button" onclick="insertTimelineModalEmoji('🤩')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🤩</button>
                <button type="button" onclick="insertTimelineModalEmoji('😘')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😘</button>
                <button type="button" onclick="insertTimelineModalEmoji('😋')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😋</button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-12">
          <label>Upload Gambar/Foto (Opsional)</label>
          <div class="file-upload-container">
            <input type="file" id="imageUpload" name="image" accept="image/*">
            <button type="button" class="btn ghost upload-btn" onclick="document.getElementById('imageUpload').click()">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
              Klik untuk Upload Gambar
            </button>
            <div id="imagePreview" class="image-preview">
              <img id="previewImg">
              <button type="button" onclick="removeImage()" class="btn ghost remove-btn">Hapus Gambar</button>
            </div>
          </div>
        </div>
        <div class="mt-12">
          <label>Upload Video (Opsional)</label>
          <div class="file-upload-container">
            <input type="file" id="videoUpload" name="video" accept="video/*">
            <button type="button" class="btn ghost upload-btn" onclick="document.getElementById('videoUpload').click()">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H4zm9 4l5-3v12l-5-3V7z" clip-rule="evenodd"/>
              </svg>
              Klik untuk Upload Video
            </button>
            <div id="videoPreview" class="image-preview" style="display:none">
              <video id="previewVideo" controls style="max-width:100%; border-radius: 8px;"></video>
              <button type="button" onclick="removeVideo()" class="btn ghost remove-btn">Hapus Video</button>
            </div>
          </div>
        </div>
        <div class="mt-12">
          <label>Kategori (Opsional)</label>
          <select name="category" id="categorySelect" onchange="toggleCustomCategory()">
            <option value="">Pilih kategori...</option>
            <option value="bullying">Bullying</option>
            <option value="mental_health">Mental Health</option>
            <option value="workplace">Workplace</option>
            <option value="aspirasi">Aspirasi</option>
            <option value="other">Other</option>
          </select>
          <div id="customCategoryInput" style="display: none; margin-top: 8px;">
            <input type="text" name="custom_category" placeholder="Tuliskan topik Anda..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
          </div>
        </div>
        <div class="mt-12">
          <label><input type="checkbox" name="want_solution" value="true" /> Saya ingin solusi</label>
        </div>
        <div class="actions-row">
          <button type="submit" class="btn primary">Kirim</button>
          <button type="button" id="closeCreate2" class="btn ghost" onclick="document.getElementById('createModal').classList.remove('open')">Batal</button>
        </div>
        
      </form>
    </div>
  </div>
  <script src="assets/js/app.js?v=20250109008"></script>
</body>
</html>

