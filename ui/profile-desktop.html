<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpeakUp! — Profile (Desktop)</title>
  <link rel="icon" type="image/png" href="assets/logo/logo apps.png?v=2">
  <link rel="shortcut icon" type="image/png" href="assets/logo/logo apps.png?v=2">
  <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
  <link rel="stylesheet" href="assets/css/style.css" />
  <style>
    /* Critical CSS - Prevent flash of unstyled content */
    body {
      visibility: hidden;
    }
    
    body.loaded {
      visibility: visible;
    }
    
    /* Typing animation */
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }
    
    /* Notification popup animation */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    :root { --bg:#ffffff; --panel:#ffffff; --text:#374151; --muted:#64748b; --accent:#38bdf8; --border:#e5e7eb; }
    .logo img[data-theme="light"]{display:block!important}.logo img[data-theme="dark"]{display:none!important}
    html,body,main,.desktop-container,.desktop-nav,.card,.tabs .tab,.modal .box{background:#ffffff!important}
    body{margin:0;padding:0;min-height:100vh;background:#ffffff!important;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .desktop-nav{display:block!important}
    .desktop-container{max-width:1024px;margin:0 auto;padding:24px 32px}
    .desktop-nav .nav-item.active{background:#ffffff!important;color:#374151!important;border:1px solid #e5e7eb!important}
    .desktop-nav .nav-item.plus-btn,.btn.primary{background:#ffffff!important;color:#374151!important;border:1px solid #e5e7eb!important}
    body.desktop-page, body.desktop-page *:not(h1):not(h2):not(h3):not(h4):not(h5):not(h6){color:#374151!important}
    
    /* Logo SpeakUp! berwarna biru */
    .desktop-nav .logo { 
      color: #38bdf8 !important; 
      font-weight: 800; 
      letter-spacing: 0.5px; 
    }

    /* Force logo color with maximum specificity */
    .desktop-page .desktop-nav .logo,
    body.desktop-page .desktop-nav .logo,
    html body.desktop-page .desktop-nav .logo {
      color: #38bdf8 !important;
      font-weight: 800 !important;
      letter-spacing: 0.5px !important;
    }

    /* Emoji Picker Styles */
    .post-content {
      position: relative;
    }
    
    .emoji-picker {
      position: absolute;
      top: -180px;
      left: 0;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 12px;
      z-index: 1000;
      max-width: 200px;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      max-width: 200px;
    }

    .emoji-btn {
      background: none;
      border: none;
      font-size: 20px;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .emoji-btn:hover {
      background: #f3f4f6;
    }

    /* Comment Modal Styles */
    .comment-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    .comment-modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .comment-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .comment-modal-header h3 {
      margin: 0;
      color: #374151;
      font-size: 18px;
      font-weight: 600;
    }

    .comment-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #64748b;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .comment-modal-close:hover {
      background-color: #f3f4f6;
      color: #374151;
    }

    .comment-modal-body {
      padding: 24px;
    }

    .comment-input-container {
      position: relative;
      z-index: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #commentText {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
      margin: 0;
    }

    #commentText:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }

    .comment-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .emoji-btn {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-btn:hover {
      background-color: #f3f4f6;
      color: #374151;
    }

    .comment-submit-btn {
      background-color: #38bdf8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .comment-submit-btn:hover {
      background-color: #0ea5e9;
    }

    .comment-submit-btn:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .emoji-picker {
      position: absolute;
      top: -120px;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #38bdf8;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      height: 120px;
      width: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      margin: 0;
      min-width: 0;
      max-width: 100%;
      left: 0;
      right: 0;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
    }

    .emoji {
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      text-align: center;
      transition: background-color 0.2s ease;
    }

    .emoji:hover {
      background-color: #f3f4f6;
    }

    .no-posts-message {
      text-align: center;
      color: #64748b;
      padding: 20px;
    }

    .hidden {
      display: none;
    }

    /* Active states for buttons */
    .action-btn.like-btn.liked,
    .action-btn.like-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.like-btn.liked svg,
    .action-btn.like-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    .action-btn.save-btn.saved,
    .action-btn.save-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.save-btn.saved svg,
    .action-btn.save-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    .action-btn.follow-btn.followed,
    .action-btn.follow-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.follow-btn.followed svg,
    .action-btn.follow-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }

    .action-btn.repost-btn.reposted,
    .action-btn.repost-btn[style*="color: #38bdf8"] {
      color: #38bdf8 !important;
    }

    .action-btn.repost-btn.reposted svg,
    .action-btn.repost-btn[style*="color: #38bdf8"] svg {
      color: #38bdf8 !important;
      fill: #38bdf8 !important;
    }



    /* Post actions styling */
    .post-actions {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .action-btn {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      background: #f3f4f6;
    }

    .action-btn .count {
      margin-left: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .comment-modal-content {
        margin: 10% auto;
        width: 95%;
      }
      
      .emoji-grid {
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
      }
      
      .emoji {
        font-size: 18px;
        padding: 2px;
      }
      
      .emoji-picker {
        height: 100px;
        top: -100px;
        padding: 12px;
      }
    }

    /* Force white color for profile username */
    .profile-username {
      color: white !important;
    }
    
    /* Avatar styles for posts */
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 12px;
    }
    .avatar.anonymous { background: #6b7280; }
    .avatar.verified { background: #38bdf8; }
    .avatar.custom { background: #10b981; }
    .avatar.verified-profile { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid #38bdf8;
    }
    .avatar.custom-profile { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid #10b981;
    }
    
    /* Post action buttons */
    .post-actions {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .action-btn {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .action-btn:hover {
      background: #f3f4f6;
    }
    .action-btn .count {
      margin-left: 4px;
      font-size: 12px;
      font-weight: 500;
    }
  </style>
</head>
<body class="desktop-page">
  <div class="desktop-container">
    <nav class="desktop-nav" aria-label="Navigasi desktop">
      <div class="desktop-nav-inner">
        <div class="nav-left">
          <div class="logo">SpeakUp!</div>
          <a href="./desktop.html" class="nav-item" title="Home">
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
            <span>Home</span>
          </a>
          
          <a href="./timeline-desktop.html" class="nav-item" title="Timeline">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
            <span>Timeline</span>
          </a>
          <a href="./petitions-desktop.html" class="nav-item" title="Aspirasi">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
            <span>Aspirasi</span>
          </a>
        </div>
        <div class="nav-right">
          <a href="./settings-desktop.html" class="nav-item" title="Settings">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
            <span>Settings</span>
          </a>
          <a href="./profile-desktop.html" class="nav-item active" title="Profile">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
            <span>Profile</span>
          </a>
          <a href="./sign-desktop.html" class="nav-item" id="signButton" title="Login">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h8.586l-3.293-3.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 11-1.414-1.414L12.586 11H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
            <span>Login</span>
          </a>
        </div>
      </div>
    </nav>

    <main>
      <section class="container">
        <!-- Profile Header - Unified Banner and Bio -->
        <div class="profile-header">
          <div class="profile-unified" style="background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%); border-radius: 12px; margin-bottom: 24px; position: relative; overflow: hidden;">
            <!-- Banner Section -->
            <div class="profile-cover" style="height: 160px; position: relative;">
              <div class="profile-avatar-large" style="width: 120px; height: 120px; border-radius: 50%; background: #fff; border: 4px solid #fff; position: absolute; bottom: -30px; left: 32px; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 700; color: #38bdf8; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10;">
                <img id="profileAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9ImN1cnJlbnRDb2xvciIgdmlld0JveD0iMCAwIDIwIDIwIiBzdHlsZT0iY29sb3I6ICM5Y2EzYWY7Ij48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMCA5YTMgMyAwIDEwMC02IDMgMyAwIDAwMCA2em0tNyA5YTcgNyAwIDExMTQgMEgzeiIgY2xpcC1ydWxlPSJldmVub2RkIi8+PC9zdmc+" alt="Profile Picture" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
              </div>
            </div>
            
            <!-- Bio Section - Integrated with Banner -->
            <div class="profile-info" style="padding: 100px 32px 32px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 0 0 12px 12px; position: relative; z-index: 2; margin-top: -30px; padding-top: 90px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
            <div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <h1 class="profile-name" style="margin: 0; font-size: 28px; font-weight: 700; color: #1f2937;">Loading...</h1>
                  <div id="profile-verified-badge" style="display: none; align-items: center; justify-content: center; width: 24px; height: 24px; position: relative;" title="Verified Account">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- Simple blue circle -->
                  <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                      <!-- White checkmark in center -->
                      <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                </div>
                <div style="margin: 0 0 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                  <p class="profile-username" style="margin: 0; color: white !important; font-size: 12px; background: #38bdf8; padding: 2px 6px; border-radius: 4px; display: inline-block; font-style: italic;"></p>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <p class="profile-role" style="margin: 0; color: white !important; font-size: 12px; background: #38bdf8; padding: 2px 6px; border-radius: 4px; display: inline-block; font-style: italic;"></p>
                  </div>
                </div>
                
                <p class="profile-bio" style="margin: 0 0 16px; color: #374151; line-height: 1.6; max-width: 600px;">
                </p>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                  <div class="profile-website" style="color: #38bdf8; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
                    </svg>
                    <span></span>
                  </div>
                  <span class="profile-location" style="color: #6b7280; font-size: 14px;"></span>
                </div>
                
                <!-- Profile Stats -->
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 24px; margin-bottom: 16px;">
                  <div style="text-align: center; cursor: pointer;" onclick="showPostsModal()" title="Lihat semua postingan">
                    <div id="postsCount" style="font-size: 20px; font-weight: 700; color: #1f2937;">0</div>
                    <div style="font-size: 14px; color: #6b7280;">Posts</div>
                  </div>
                  <div style="text-align: center; cursor: pointer;" onclick="showFollowersModal()" title="Lihat followers">
                    <div id="followersCount" style="font-size: 20px; font-weight: 700; color: #1f2937;">0</div>
                    <div style="font-size: 14px; color: #6b7280;">Followers</div>
                  </div>
                  <div style="text-align: center; cursor: pointer;" onclick="showFollowingModal()" title="Lihat following">
                    <div id="followingCount" style="font-size: 20px; font-weight: 700; color: #1f2937;">0</div>
                    <div style="font-size: 14px; color: #6b7280;">Following</div>
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <button id="editProfileButton" onclick="editProfile()" style="background: none; border: none; color: #38bdf8; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Edit Profile">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                  </svg>
                </button>
                <button id="followButton" onclick="toggleUserFollow()" style="
                  background: #38bdf8; 
                  border: none; 
                  color: white !important; 
                  cursor: pointer; 
                  padding: 8px 16px; 
                  border-radius: 20px; 
                  font-size: 14px;
                  font-weight: 600;
                  transition: all 0.2s; 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  gap: 6px;
                " onmouseover="this.style.backgroundColor='#0ea5e9'; this.style.color='white !important';" onmouseout="this.style.backgroundColor='#38bdf8'; this.style.color='white !important';" title="Follow User">
                  <span id="followButtonText" style="color: white !important;">Follow</span>
                </button>
                <button onclick="console.log('DM button clicked'); openDMWithUser();" style="background: none; border: none; color: #38bdf8; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Kirim Pesan">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                  </svg>
                </button>
                <button id="notificationButton" onclick="toggleNotificationDropdown()" style="background: none; border: none; color: #38bdf8; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; position: relative;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Notifikasi">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                  </svg>
                  <span id="notificationBadge" style="position: absolute; top: 2px; right: 2px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none;">0</span>
                </button>
                <button onclick="shareProfile()" style="background: none; border: none; color: #38bdf8; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Bagikan Profil">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                  </svg>
                </button>
                <button id="reportButton" onclick="reportUser()" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='#fef2f2'" onmouseout="this.style.backgroundColor='transparent'" title="Laporkan Orang Ini">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Tabs -->
        <div class="content-tabs" style="margin-bottom: 24px;">
          <div style="display: flex; gap: 0; border-bottom: 2px solid #e5e7eb;">
            <button class="tab-btn active" data-tab="posts" style="padding: 12px 24px; border: none; background: none; color: #38bdf8; font-weight: 600; border-bottom: 2px solid #38bdf8; cursor: pointer;">
              Posts
            </button>
            <button class="tab-btn" data-tab="reposts" style="padding: 12px 24px; border: none; background: none; color: #6b7280; font-weight: 600; cursor: pointer;">
              Reposts
            </button>
            <button class="tab-btn" data-tab="media" style="padding: 12px 24px; border: none; background: none; color: #6b7280; font-weight: 600; cursor: pointer;">
              Media
            </button>
            <button class="tab-btn" id="archiveTab" data-tab="archive" style="padding: 12px 24px; border: none; background: none; color: #6b7280; font-weight: 600; cursor: pointer; display: inline-block; min-width: 80px;">
              Archive
            </button>
          </div>
        </div>

        <!-- Posts Section -->
        <div class="posts-section" id="postsContainer">
          <!-- User Posts Container -->
          <div class="user-posts">
            <!-- Posts will be loaded here dynamically -->
          </div>
          
          <!-- Empty state for new users -->
          <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
            <h3 style="margin: 0 0 8px; color: #374151; font-size: 18px;">Belum ada posting</h3>
            <p style="margin: 0 0 24px; font-size: 14px;">Mulai berbagi pengalaman dan aspirasi Anda dengan komunitas SpeakUp!</p>
            <button onclick="document.querySelector('[data-open-create]').click()" style="background: #38bdf8; color: white !important; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#0ea5e9'; this.style.color='white !important';" onmouseout="this.style.backgroundColor='#38bdf8'; this.style.color='white !important';">
              Buat Posting Pertama
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Comment Modal -->
  <div id="commentModal" class="comment-modal">
    <div class="comment-modal-content">
      <div class="comment-modal-header">
        <h3>Komentar</h3>
        <button class="comment-modal-close" onclick="closeCommentModal()">&times;</button>
      </div>
      <div class="comment-modal-body">
        <div class="comment-input-container">
          <textarea id="commentText" placeholder="Tulis komentar Anda..." rows="3"></textarea>
          <div class="comment-actions">
            <button class="emoji-btn" onclick="toggleEmojiPicker()" title="Tambah Emoji" type="button">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button class="comment-submit-btn" onclick="submitComment()">Kirim</button>
          </div>
          <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-grid">
              <!-- Wajah dan Emosi -->
              <span class="emoji" onclick="insertEmoji('😀')">😀</span>
              <span class="emoji" onclick="insertEmoji('😃')">😃</span>
              <span class="emoji" onclick="insertEmoji('😄')">😄</span>
              <span class="emoji" onclick="insertEmoji('😁')">😁</span>
              <span class="emoji" onclick="insertEmoji('😆')">😆</span>
              <span class="emoji" onclick="insertEmoji('😅')">😅</span>
              <span class="emoji" onclick="insertEmoji('😂')">😂</span>
              <span class="emoji" onclick="insertEmoji('🤣')">🤣</span>
              <span class="emoji" onclick="insertEmoji('😊')">😊</span>
              <span class="emoji" onclick="insertEmoji('😇')">😇</span>
              
              <span class="emoji" onclick="insertEmoji('🙂')">🙂</span>
              <span class="emoji" onclick="insertEmoji('🙃')">🙃</span>
              <span class="emoji" onclick="insertEmoji('😉')">😉</span>
              <span class="emoji" onclick="insertEmoji('😌')">😌</span>
              <span class="emoji" onclick="insertEmoji('😍')">😍</span>
              <span class="emoji" onclick="insertEmoji('🥰')">🥰</span>
              <span class="emoji" onclick="insertEmoji('😘')">😘</span>
              <span class="emoji" onclick="insertEmoji('😗')">😗</span>
              <span class="emoji" onclick="insertEmoji('😙')">😙</span>
              <span class="emoji" onclick="insertEmoji('😚')">😚</span>
              
              <span class="emoji" onclick="insertEmoji('😋')">😋</span>
              <span class="emoji" onclick="insertEmoji('😛')">😛</span>
              <span class="emoji" onclick="insertEmoji('😝')">😝</span>
              <span class="emoji" onclick="insertEmoji('😜')">😜</span>
              <span class="emoji" onclick="insertEmoji('🤪')">🤪</span>
              <span class="emoji" onclick="insertEmoji('🤨')">🤨</span>
              <span class="emoji" onclick="insertEmoji('🧐')">🧐</span>
              <span class="emoji" onclick="insertEmoji('🤓')">🤓</span>
              <span class="emoji" onclick="insertEmoji('😎')">😎</span>
              <span class="emoji" onclick="insertEmoji('🤩')">🤩</span>
              
              <span class="emoji" onclick="insertEmoji('🥳')">🥳</span>
              <span class="emoji" onclick="insertEmoji('😏')">😏</span>
              <span class="emoji" onclick="insertEmoji('😒')">😒</span>
              <span class="emoji" onclick="insertEmoji('😞')">😞</span>
              <span class="emoji" onclick="insertEmoji('😔')">😔</span>
              <span class="emoji" onclick="insertEmoji('😟')">😟</span>
              <span class="emoji" onclick="insertEmoji('😕')">😕</span>
              <span class="emoji" onclick="insertEmoji('🙁')">🙁</span>
              <span class="emoji" onclick="insertEmoji('☹️')">☹️</span>
              <span class="emoji" onclick="insertEmoji('😣')">😣</span>
              
              <span class="emoji" onclick="insertEmoji('😖')">😖</span>
              <span class="emoji" onclick="insertEmoji('😫')">😫</span>
              <span class="emoji" onclick="insertEmoji('😩')">😩</span>
              <span class="emoji" onclick="insertEmoji('🥺')">🥺</span>
              <span class="emoji" onclick="insertEmoji('😢')">😢</span>
              <span class="emoji" onclick="insertEmoji('😭')">😭</span>
              <span class="emoji" onclick="insertEmoji('😤')">😤</span>
              <span class="emoji" onclick="insertEmoji('😠')">😠</span>
              <span class="emoji" onclick="insertEmoji('😡')">😡</span>
              <span class="emoji" onclick="insertEmoji('🤬')">🤬</span>
              
              <span class="emoji" onclick="insertEmoji('🤯')">🤯</span>
              <span class="emoji" onclick="insertEmoji('😳')">😳</span>
              <span class="emoji" onclick="insertEmoji('🥵')">🥵</span>
              <span class="emoji" onclick="insertEmoji('🥶')">🥶</span>
              <span class="emoji" onclick="insertEmoji('😱')">😱</span>
              <span class="emoji" onclick="insertEmoji('😨')">😨</span>
              <span class="emoji" onclick="insertEmoji('😰')">😰</span>
              <span class="emoji" onclick="insertEmoji('😥')">😥</span>
              <span class="emoji" onclick="insertEmoji('😓')">😓</span>
              <span class="emoji" onclick="insertEmoji('🤗')">🤗</span>
              
              <!-- Gesture dan Tangan -->
              <span class="emoji" onclick="insertEmoji('🤔')">🤔</span>
              <span class="emoji" onclick="insertEmoji('🤭')">🤭</span>
              <span class="emoji" onclick="insertEmoji('🤫')">🤫</span>
              <span class="emoji" onclick="insertEmoji('🤥')">🤥</span>
              <span class="emoji" onclick="insertEmoji('😶')">😶</span>
              <span class="emoji" onclick="insertEmoji('😐')">😐</span>
              <span class="emoji" onclick="insertEmoji('😑')">😑</span>
              <span class="emoji" onclick="insertEmoji('😬')">😬</span>
              <span class="emoji" onclick="insertEmoji('🙄')">🙄</span>
              <span class="emoji" onclick="insertEmoji('😯')">😯</span>
              
              <span class="emoji" onclick="insertEmoji('😦')">😦</span>
              <span class="emoji" onclick="insertEmoji('😧')">😧</span>
              <span class="emoji" onclick="insertEmoji('😮')">😮</span>
              <span class="emoji" onclick="insertEmoji('😲')">😲</span>
              <span class="emoji" onclick="insertEmoji('🥱')">🥱</span>
              <span class="emoji" onclick="insertEmoji('😴')">😴</span>
              <span class="emoji" onclick="insertEmoji('🤤')">🤤</span>
              <span class="emoji" onclick="insertEmoji('😪')">😪</span>
              <span class="emoji" onclick="insertEmoji('😵')">😵</span>
              <span class="emoji" onclick="insertEmoji('🤐')">🤐</span>
              
              <!-- Tangan dan Gesture -->
              <span class="emoji" onclick="insertEmoji('👍')">👍</span>
              <span class="emoji" onclick="insertEmoji('👎')">👎</span>
              <span class="emoji" onclick="insertEmoji('👌')">👌</span>
              <span class="emoji" onclick="insertEmoji('✌️')">✌️</span>
              <span class="emoji" onclick="insertEmoji('🤞')">🤞</span>
              <span class="emoji" onclick="insertEmoji('🤟')">🤟</span>
              <span class="emoji" onclick="insertEmoji('🤘')">🤘</span>
              <span class="emoji" onclick="insertEmoji('🤙')">🤙</span>
              <span class="emoji" onclick="insertEmoji('👈')">👈</span>
              <span class="emoji" onclick="insertEmoji('👉')">👉</span>
              
              <span class="emoji" onclick="insertEmoji('👆')">👆</span>
              <span class="emoji" onclick="insertEmoji('🖕')">🖕</span>
              <span class="emoji" onclick="insertEmoji('👇')">👇</span>
              <span class="emoji" onclick="insertEmoji('☝️')">☝️</span>
              <span class="emoji" onclick="insertEmoji('👋')">👋</span>
              <span class="emoji" onclick="insertEmoji('🤚')">🤚</span>
              <span class="emoji" onclick="insertEmoji('🖐️')">🖐️</span>
              <span class="emoji" onclick="insertEmoji('✋')">✋</span>
              <span class="emoji" onclick="insertEmoji('🖖')">🖖</span>
              <span class="emoji" onclick="insertEmoji('👏')">👏</span>
              
              <!-- Simbol dan Objek -->
              <span class="emoji" onclick="insertEmoji('❤️')">❤️</span>
              <span class="emoji" onclick="insertEmoji('🧡')">🧡</span>
              <span class="emoji" onclick="insertEmoji('💛')">💛</span>
              <span class="emoji" onclick="insertEmoji('💚')">💚</span>
              <span class="emoji" onclick="insertEmoji('💙')">💙</span>
              <span class="emoji" onclick="insertEmoji('💜')">💜</span>
              <span class="emoji" onclick="insertEmoji('🖤')">🖤</span>
              <span class="emoji" onclick="insertEmoji('🤍')">🤍</span>
              <span class="emoji" onclick="insertEmoji('🤎')">🤎</span>
              <span class="emoji" onclick="insertEmoji('💔')">💔</span>
              
              <span class="emoji" onclick="insertEmoji('💕')">💕</span>
              <span class="emoji" onclick="insertEmoji('💞')">💞</span>
              <span class="emoji" onclick="insertEmoji('💓')">💓</span>
              <span class="emoji" onclick="insertEmoji('💗')">💗</span>
              <span class="emoji" onclick="insertEmoji('💖')">💖</span>
              <span class="emoji" onclick="insertEmoji('💘')">💘</span>
              <span class="emoji" onclick="insertEmoji('💝')">💝</span>
              <span class="emoji" onclick="insertEmoji('💟')">💟</span>
              <span class="emoji" onclick="insertEmoji('☮️')">☮️</span>
              <span class="emoji" onclick="insertEmoji('✝️')">✝️</span>
              
              <span class="emoji" onclick="insertEmoji('☪️')">☪️</span>
              <span class="emoji" onclick="insertEmoji('🕉️')">🕉️</span>
              <span class="emoji" onclick="insertEmoji('☸️')">☸️</span>
              <span class="emoji" onclick="insertEmoji('✡️')">✡️</span>
              <span class="emoji" onclick="insertEmoji('🔯')">🔯</span>
              <span class="emoji" onclick="insertEmoji('🕎')">🕎</span>
              <span class="emoji" onclick="insertEmoji('☯️')">☯️</span>
              <span class="emoji" onclick="insertEmoji('☦️')">☦️</span>
              <span class="emoji" onclick="insertEmoji('🛐')">🛐</span>
              <span class="emoji" onclick="insertEmoji('⛎')">⛎</span>
              
              <!-- Simbol Populer -->
              <span class="emoji" onclick="insertEmoji('♈')">♈</span>
              <span class="emoji" onclick="insertEmoji('♉')">♉</span>
              <span class="emoji" onclick="insertEmoji('♊')">♊</span>
              <span class="emoji" onclick="insertEmoji('♋')">♋</span>
              <span class="emoji" onclick="insertEmoji('♌')">♌</span>
              <span class="emoji" onclick="insertEmoji('♍')">♍</span>
              <span class="emoji" onclick="insertEmoji('♎')">♎</span>
              <span class="emoji" onclick="insertEmoji('♏')">♏</span>
              <span class="emoji" onclick="insertEmoji('♐')">♐</span>
              <span class="emoji" onclick="insertEmoji('♑')">♑</span>
              
              <span class="emoji" onclick="insertEmoji('♒')">♒</span>
              <span class="emoji" onclick="insertEmoji('♓')">♓</span>
              <span class="emoji" onclick="insertEmoji('🆔')">🆔</span>
              <span class="emoji" onclick="insertEmoji('⚛️')">⚛️</span>
              <span class="emoji" onclick="insertEmoji('🉑')">🉑</span>
              <span class="emoji" onclick="insertEmoji('☢️')">☢️</span>
              <span class="emoji" onclick="insertEmoji('☣️')">☣️</span>
              <span class="emoji" onclick="insertEmoji('📴')">📴</span>
              <span class="emoji" onclick="insertEmoji('📳')">📳</span>
              <span class="emoji" onclick="insertEmoji('🈶')">🈶</span>
              
              <span class="emoji" onclick="insertEmoji('🈚')">🈚</span>
              <span class="emoji" onclick="insertEmoji('🈸')">🈸</span>
              <span class="emoji" onclick="insertEmoji('🈺')">🈺</span>
              <span class="emoji" onclick="insertEmoji('🈷️')">🈷️</span>
              <span class="emoji" onclick="insertEmoji('✴️')">✴️</span>
              <span class="emoji" onclick="insertEmoji('🆚')">🆚</span>
              <span class="emoji" onclick="insertEmoji('💮')">💮</span>
              <span class="emoji" onclick="insertEmoji('🉐')">🉐</span>
              <span class="emoji" onclick="insertEmoji('㊙️')">㊙️</span>
              <span class="emoji" onclick="insertEmoji('㊗️')">㊗️</span>
              
              <!-- Simbol Populer Lainnya -->
              <span class="emoji" onclick="insertEmoji('🈴')">🈴</span>
              <span class="emoji" onclick="insertEmoji('🈵')">🈵</span>
              <span class="emoji" onclick="insertEmoji('🈹')">🈹</span>
              <span class="emoji" onclick="insertEmoji('🈲')">🈲</span>
              <span class="emoji" onclick="insertEmoji('🅰️')">🅰️</span>
              <span class="emoji" onclick="insertEmoji('🅱️')">🅱️</span>
              <span class="emoji" onclick="insertEmoji('🆎')">🆎</span>
              <span class="emoji" onclick="insertEmoji('🅾️')">🅾️</span>
              <span class="emoji" onclick="insertEmoji('🆑')">🆑</span>
              <span class="emoji" onclick="insertEmoji('🅾️')">🅾️</span>
              
              <!-- Simbol Populer -->
              <span class="emoji" onclick="insertEmoji('🔥')">🔥</span>
              <span class="emoji" onclick="insertEmoji('💯')">💯</span>
              <span class="emoji" onclick="insertEmoji('✨')">✨</span>
              <span class="emoji" onclick="insertEmoji('🎉')">🎉</span>
              <span class="emoji" onclick="insertEmoji('🎊')">🎊</span>
              <span class="emoji" onclick="insertEmoji('🎈')">🎈</span>
              <span class="emoji" onclick="insertEmoji('🎁')">🎁</span>
              <span class="emoji" onclick="insertEmoji('🏆')">🏆</span>
              <span class="emoji" onclick="insertEmoji('🥇')">🥇</span>
              <span class="emoji" onclick="insertEmoji('🥈')">🥈</span>
              
              <span class="emoji" onclick="insertEmoji('🥉')">🥉</span>
              <span class="emoji" onclick="insertEmoji('🏅')">🏅</span>
              <span class="emoji" onclick="insertEmoji('🎖️')">🎖️</span>
              <span class="emoji" onclick="insertEmoji('🏵️')">🏵️</span>
              <span class="emoji" onclick="insertEmoji('🎗️')">🎗️</span>
              <span class="emoji" onclick="insertEmoji('🎫')">🎫</span>
              <span class="emoji" onclick="insertEmoji('🎟️')">🎟️</span>
              <span class="emoji" onclick="insertEmoji('🎪')">🎪</span>
              <span class="emoji" onclick="insertEmoji('🤹')">🤹</span>
              <span class="emoji" onclick="insertEmoji('🎭')">🎭</span>
              
              <span class="emoji" onclick="insertEmoji('🩰')">🩰</span>
              <span class="emoji" onclick="insertEmoji('🎨')">🎨</span>
              <span class="emoji" onclick="insertEmoji('🎬')">🎬</span>
              <span class="emoji" onclick="insertEmoji('🎤')">🎤</span>
              <span class="emoji" onclick="insertEmoji('🎧')">🎧</span>
              <span class="emoji" onclick="insertEmoji('🎼')">🎼</span>
              <span class="emoji" onclick="insertEmoji('🎵')">🎵</span>
              <span class="emoji" onclick="insertEmoji('🎶')">🎶</span>
              <span class="emoji" onclick="insertEmoji('🎹')">🎹</span>
              <span class="emoji" onclick="insertEmoji('🥁')">🥁</span>
              
              <span class="emoji" onclick="insertEmoji('🎷')">🎷</span>
              <span class="emoji" onclick="insertEmoji('🎺')">🎺</span>
              <span class="emoji" onclick="insertEmoji('🎸')">🎸</span>
              <span class="emoji" onclick="insertEmoji('🪕')">🪕</span>
              <span class="emoji" onclick="insertEmoji('🎻')">🎻</span>
              <span class="emoji" onclick="insertEmoji('🪘')">🪘</span>
              <span class="emoji" onclick="insertEmoji('🎲')">🎲</span>
              <span class="emoji" onclick="insertEmoji('♠️')">♠️</span>
              <span class="emoji" onclick="insertEmoji('♥️')">♥️</span>
              <span class="emoji" onclick="insertEmoji('♦️')">♦️</span>
              
              <span class="emoji" onclick="insertEmoji('♣️')">♣️</span>
              <span class="emoji" onclick="insertEmoji('♟️')">♟️</span>
              <span class="emoji" onclick="insertEmoji('🃏')">🃏</span>
              <span class="emoji" onclick="insertEmoji('🀄')">🀄</span>
              <span class="emoji" onclick="insertEmoji('🎴')">🎴</span>
              <span class="emoji" onclick="insertEmoji('🎯')">🎯</span>
              <span class="emoji" onclick="insertEmoji('🎳')">🎳</span>
              <span class="emoji" onclick="insertEmoji('🎮')">🎮</span>
              <span class="emoji" onclick="insertEmoji('🕹️')">🕹️</span>
              <span class="emoji" onclick="insertEmoji('🎰')">🎰</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase SDK -->
  
  <script src="assets/js/app.js"></script>
  <script>
    // Initialize Supabase client
    let supabase;
    let currentUser = null;
    let userProfile = null;
    
    // Real-time DM variables
    let realtimeChannel = null;
    let typingTimeout = null;
    let isTyping = false;
    let otherUserTyping = false;
    
    // Notification variables
    let notificationChannel = null;
    let notifications = [];
    let unreadNotificationCount = 0;
    
    // Wait for config to load
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Profile page loaded, initializing...');
      
      // Make page visible after initialization
      document.body.classList.add('loaded');
      
      // Initialize tab functionality (will be called again after profile loads)
      initializeTabs();
      
      // Helper: wait for Supabase bootstrap/config to be ready (avoid race conditions)
      async function waitForSupabaseReady(maxWaitMs = 500) {
        const start = Date.now();
        while (Date.now() - start < maxWaitMs) {
          if ((window.getSupabase && window.getSupabase()) || (window.SUPABASE_CONFIG && window.supabase)) {
            return true;
          }
          await new Promise(r => setTimeout(r, 25));
        }
        return false;
      }

      // Initialize Supabase after config is loaded
      await waitForSupabaseReady();
      if (window.getSupabase) {
        supabase = window.getSupabase();
      }
      if (!supabase && window.SUPABASE_CONFIG && window.supabase && window.supabase.createClient) {
        supabase = window.supabase.createClient(
          window.SUPABASE_CONFIG.url,
          window.SUPABASE_CONFIG.anonKey
        );
      }

      if (supabase) {
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        // Get current user (standardized)
        const { data: { session } } = await supabase.auth.getSession();
        const user = session?.user;
        console.log('profile session.user:', user || null);
        try {
          const { data: userData } = await supabase.auth.getUser();
          console.log('auth.getUser() on profile:', userData);
        } catch(e) { console.warn('getUser() failed:', e); }
        if (session) {
          console.log('Supabase session found, user is logged in');
          console.log('Session user:', session.user);
          currentUser = session.user;
          // User is authenticated via Supabase
          
          // Reset profile data first to ensure clean state
          await resetProfileData();
          await loadUserProfile();
          
          // Load user's posts
          await loadUserPosts();
          
          // Setup notification system
          await setupNotificationSystem();
          
          // User is logged in, update navigation
          console.log('Updating navigation after Supabase session detection...');
          updateNavigationForLoggedInUser();
          
          // Double-check navigation after a short delay
          setTimeout(() => {
            console.log('Double-checking navigation after delay...');
            updateNavigationForLoggedInUser();
          }, 1000);
        } else if (!session || !session.user) {
          console.log('No Supabase session, checking localStorage...');
          const isLoggedIn = localStorage.getItem('speakup_logged_in');
          if (isLoggedIn === 'true') {
            console.log('localStorage indicates user is logged in. Proceeding without Supabase session.');
            try {
              await resetProfileData();
              await loadUserProfile();
              await loadUserPosts();
            } catch (err) {
              console.warn('Error loading profile with localStorage fallback:', err);
            }
            updateNavigationForLoggedInUser();
          } else {
            console.log('No login detected, redirecting to sign page');
            showNotification('Session hilang. Silakan login ulang.', 'error');
            // User is not logged in, redirect to sign page
            window.location.href = './sign-desktop.html';
          }
        }
      } else {
        console.log('Supabase config not available, redirecting to login');
        window.location.href = './sign-desktop.html';
      }
    });
    
    // Navigation logic function
    function checkAndUpdateNavigation() {
      console.log('Checking navigation status in profile...');
      
      const isLoggedIn = localStorage.getItem('speakup_logged_in');
      console.log('Login status in profile:', isLoggedIn);
      
      if (isLoggedIn === 'true') {
        console.log('User is logged in, updating navigation...');
        updateNavigationForLoggedInUser();
      } else {
        console.log('User is not logged in, showing Login button...');
        updateNavigationForHomepage();
      }
    }
    
    // Run navigation logic when window loads (fallback)
    window.addEventListener('load', function() {
      console.log('Window loaded, checking navigation in profile...');
      setTimeout(checkAndUpdateNavigation, 100);
    });
    
    // Run navigation logic when page becomes visible (user switches tabs)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        console.log('Page became visible, checking navigation...');
        setTimeout(checkAndUpdateNavigation, 50);
      }
    });
    
    function updateNavigationForLoggedInUser() {
      console.log('Updating navigation for logged in user...');
      
      // Show all navigation items
      const navItems = document.querySelectorAll('.desktop-nav .nav-item');
      navItems.forEach(item => {
        item.style.display = 'flex';
      });
      
      // Convert Login button to Logout button (delegated handler global akan menangani klik)
      const signButton = document.getElementById('signButton');
      if (signButton) {
        console.log('Converting Login button to Logout button');
        console.log('Current button text:', signButton.textContent);
        console.log('Current button href:', signButton.href);
        
        signButton.href = 'javascript:void(0)';
        try { signButton.onclick = null; } catch(_) {}
        signButton.title = 'Logout';
        signButton.innerHTML = `
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
          </svg>
          <span>Logout</span>
        `;
        
        console.log('Button updated. New text:', signButton.textContent);
        console.log('Button updated. New href:', signButton.href);
      } else {
        console.error('signButton not found!');
      }
      
      // Show Speak! button
      const speakButton = document.querySelector('.plus-btn');
      if (speakButton) {
        speakButton.style.display = 'flex';
      }
      
      // Handle Profile button click to go to own profile
      const profileButton = document.querySelector('a[href="./profile-desktop.html"]');
      if (profileButton) {
        profileButton.addEventListener('click', function(e) {
          e.preventDefault();
          // Navigate to own profile (without URL parameter)
          window.location.href = 'profile-desktop.html';
        });
      }
    }
    
    function updateNavigationForHomepage() {
      console.log('Updating navigation for homepage (not logged in)...');
      
        // Show only Home and Login navigation items for non-logged in users
        const navItems = document.querySelectorAll('.desktop-nav .nav-item');
        navItems.forEach(item => {
          if (item.textContent.includes('Home') || 
              item.textContent.includes('Login')) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
        
        // Reset Login button to original state
        const signButton = document.getElementById('signButton');
        if (signButton) {
          console.log('Resetting Login button to original state');
          signButton.href = './sign-desktop.html';
          signButton.onclick = null;
          signButton.title = 'Login';
          signButton.innerHTML = `
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h8.586l-3.293-3.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 11-1.414-1.414L12.586 11H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
            <span>Login</span>
          `;
        }
      
      // Hide Speak! button for non-logged in users
      const speakButton = document.querySelector('.plus-btn');
      if (speakButton) {
        speakButton.style.display = 'none';
      }
    }
    
    // Debug function to manually update navigation
    window.debugNavigation = function() {
      console.log('Manual navigation update triggered in profile');
      const isLoggedIn = localStorage.getItem('speakup_logged_in');
      console.log('Current login status:', isLoggedIn);
      
      if (isLoggedIn === 'true') {
        updateNavigationForLoggedInUser();
      } else {
        updateNavigationForHomepage();
      }
    };
    
    // Force navigation update function
    window.forceNavigationUpdate = function() {
      console.log('Force navigation update in profile...');
      
      // Force set localStorage if not set
      if (!localStorage.getItem('speakup_logged_in')) {
        localStorage.setItem('speakup_logged_in', 'true');
        console.log('Set login status to true');
      }
      
      // Force update navigation
      checkAndUpdateNavigation();
    };
    
    // Manual navigation update function
    window.manualUpdateNavigation = function() {
      console.log('Manual navigation update triggered in profile');
      const isLoggedIn = localStorage.getItem('speakup_logged_in');
      console.log('Current login status:', isLoggedIn);
      
      if (isLoggedIn === 'true') {
        console.log('Forcing updateNavigationForLoggedInUser...');
        updateNavigationForLoggedInUser();
      } else {
        console.log('Forcing updateNavigationForHomepage...');
        updateNavigationForHomepage();
      }
    };
    
    // Check if user is logged in and force update
    window.checkLoginStatus = function() {
      const isLoggedIn = localStorage.getItem('speakup_logged_in');
      console.log('Current login status:', isLoggedIn);
      console.log('All localStorage keys:', Object.keys(localStorage));
      
      if (isLoggedIn === 'true') {
        console.log('User is logged in, forcing navigation update...');
        updateNavigationForLoggedInUser();
      } else {
        console.log('User is not logged in, showing Login button...');
        updateNavigationForHomepage();
      }
    };
    
    // Logout handled globally in assets/js/app.js
    
    // Load user's posts
    async function loadUserPosts() {
      try {
        console.log('Loading user posts...');
        
        // Check if we're viewing another user's profile from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const viewingUserId = urlParams.get('user');
        const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
        
        console.log('Posts loading - viewingUserId:', viewingUserId, 'targetUserId:', targetUserId);
        
        if (!targetUserId) {
          console.log('No target user ID, skipping posts load');
          return;
        }
        
        // Fetch user's posts from database with better error handling
        const { data: posts, error } = await supabase
          .from('posts')
          .select('id, user_id, content, category, identity, want_solution, image_url, video_url, is_pinned, created_at, updated_at')
          .eq('user_id', targetUserId)
          .order('is_pinned', { ascending: false })
          .order('created_at', { ascending: false });
          
        if (error) {
          console.error('Error loading user posts:', error);
          // Show error message to user
          const postsContainer = document.getElementById('postsContainer');
          if (postsContainer) {
            postsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Gagal memuat postingan. Silakan coba lagi.</p>';
          }
          return;
        }
        
        console.log('User posts loaded:', posts);
        
        // Display posts in profile
        displayUserPosts(posts);
        
      } catch (error) {
        console.error('Error in loadUserPosts:', error);
        // Show error message to user
        const postsContainer = document.getElementById('postsContainer');
        if (postsContainer) {
          postsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Terjadi kesalahan saat memuat postingan. Silakan refresh halaman.</p>';
        }
      }
    }
    
    // Flag to prevent duplicate loading
    let isLoadingSavedPosts = false;
    let isLoadingMediaPosts = false;
    let isLoadingReposts = false;
    
    // Load saved posts for archive (joined with posts, with safe fallback)
    async function loadSavedPosts() {
      // Prevent duplicate loading
      if (isLoadingSavedPosts) {
        console.log('Already loading saved posts, skipping...');
        return;
      }
      
      try {
        isLoadingSavedPosts = true;
        console.log('Loading saved posts...');
        console.log('Current user ID:', currentUser ? currentUser.id : 'No user');
        console.log('Current user object:', currentUser);
        
        if (!currentUser) {
          console.log('No current user, skipping saved posts load');
          return;
        }
        
        // Clear container first to prevent duplicates
        const postsContainer = document.getElementById('postsContainer');
        if (postsContainer) {
          postsContainer.innerHTML = '';
        }
        
        // Join post_saves -> posts to fetch full post content in one query
        console.log('DEBUG: Querying post_saves join posts for user:', currentUser.id);
        let saves = null; let joinError = null;
        try {
          // Try unaliased relation first (standard FK: post_id -> posts.id)
          const res1 = await supabase
            .from('post_saves')
            .select('id, created_at, posts(*)')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
          saves = res1.data; joinError = res1.error;

          // If relation not recognized, try explicit column alias
          if ((saves == null && joinError) || (Array.isArray(saves) && saves.length === 0 && joinError)) {
            console.warn('Join using posts(*) had an issue, trying posts:post_id(*) ...', joinError);
            const res2 = await supabase
              .from('post_saves')
              .select('id, created_at, posts:post_id(*)')
              .eq('user_id', currentUser.id)
              .order('created_at', { ascending: false });
            saves = res2.data; joinError = res2.error;
          }

          // As a final attempt, try forcing inner join syntax if supported
          if ((saves == null && joinError) || (Array.isArray(saves) && saves.length === 0 && joinError)) {
            console.warn('Join using alias had an issue, trying posts!inner(*) ...', joinError);
            const res3 = await supabase
              .from('post_saves')
              .select('id, created_at, posts!inner(*)')
              .eq('user_id', currentUser.id)
              .order('created_at', { ascending: false });
            saves = res3.data; joinError = res3.error;
          }
        } catch (e) {
          joinError = e;
        }
        
        console.log('DEBUG: join query result:', { saves, joinError });
        
        if (joinError) {
          console.error('Error loading saved posts (join):', joinError);
          const postsContainer = document.getElementById('postsContainer');
          if (postsContainer) {
            postsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Gagal memuat postingan tersimpan. Silakan coba lagi.</p>';
          }
          // Fallback: two-step query
          try {
            console.log('FALLBACK: Using two-step query for saved posts');
            const idsRes = await supabase
              .from('post_saves')
              .select('post_id')
              .eq('user_id', currentUser.id)
              .order('created_at', { ascending: false });
            const postIds = (idsRes.data || []).map(r => r.post_id);
            const postsRes = postIds.length ? await supabase
              .from('posts')
              .select('*')
              .in('id', postIds) : { data: [] };
            displaySavedPosts(postsRes.data || []);
          } catch (fbErr) {
            console.error('Fallback load saved posts failed:', fbErr);
          }
          return;
        }
        
        // Map to posts array expected by displaySavedPosts
        const savedPosts = (saves || []).map(s => s.posts).filter(Boolean);
        console.log('Mapped saved posts count:', savedPosts.length);
        
        // Ensure posts container is visible when rendering
        try {
          const postsSection = document.getElementById('postsContainer'); // parent wrapper
          if (postsSection) postsSection.style.display = 'block';         // ensure parent visible
        } catch (_) {}

        displaySavedPosts(savedPosts);
        try {
          console.log('Rendered archive items:', document.querySelectorAll('#postsContainer .user-post-item').length);
        } catch (_) {}
        
      } catch (error) {
        console.error('Error in loadSavedPosts:', error);
        const postsContainer = document.getElementById('postsContainer');
        if (postsContainer) {
          postsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Terjadi kesalahan saat memuat postingan tersimpan. Silakan refresh halaman.</p>';
        }
      } finally {
        // Reset loading flag
        isLoadingSavedPosts = false;
      }
    }

    // Format time ago function
    function formatTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return `${diffInSeconds} detik yang lalu`;
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} menit yang lalu`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} jam yang lalu`;
      } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} hari yang lalu`;
      }
    }

    // Load reposts for reposts tab - shows posts from other users that we reposted
    async function loadReposts() {
      // Prevent duplicate loading
      if (isLoadingReposts) {
        console.log('Already loading reposts, skipping...');
        return;
      }
      
      try {
        isLoadingReposts = true;
        const urlParams = new URLSearchParams(window.location.search);
        const viewingUserId = urlParams.get('user');
        const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
        
        if (!targetUserId) {
          console.log('No target user ID for reposts');
          return;
        }
        
        console.log('Loading reposts for user:', targetUserId);
        
        // Clear container first to prevent duplicates
        const repostsContainer = document.getElementById('postsContainer');
        if (repostsContainer) {
          repostsContainer.innerHTML = '';
        }
        
        // Get reposts - posts from other users that this user reposted
        const { data: reposts, error } = await supabase
          .from('post_reposts')
          .select(`
            created_at,
            posts (
              id,
              content,
              image_url,
              video_url,
              category,
              identity,
              want_solution,
              created_at,
              user_id,
              is_pinned
            )
          `)
          .eq('user_id', targetUserId)
          .order('created_at', { ascending: false });
          
        if (error) {
          console.error('Error loading reposts:', error);
          return;
        }
        
        console.log('Reposts loaded:', reposts);
        
        // Display reposts in posts container
        const postsContainer = document.getElementById('postsContainer');
        if (postsContainer) {
          if (reposts && reposts.length > 0) {
            // Load profiles for each post
            const repostsWithProfiles = await Promise.all(
              reposts.map(async (repost) => {
                const post = repost.posts;
                if (!post) return null;
                
                // Get profile for this post's author
                const { data: profile, error: profileError } = await supabase
                  .from('profiles')
                  .select('id, username, full_name, avatar_url, is_verified, title')
                  .eq('id', post.user_id)
                  .single();
                
                if (profileError) {
                  console.warn('Error loading profile for post:', profileError);
                }
                
                return {
                  ...repost,
                  post: {
                    ...post,
                    profile: profile || { full_name: 'User', avatar_url: null }
                  }
                };
              })
            );
            
            // Get current user name first
            const currentUserName = await getCurrentUserName();
            
            postsContainer.innerHTML = repostsWithProfiles
              .filter(repost => repost !== null)
              .map(repost => {
                const post = repost.post;
                if (!post) return '';
                
                // Show original post content with repost indicator
                return `
                  <div class="post-card" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- Repost indicator -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: #6b7280; font-size: 14px;">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8zM3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15a2 2 0 002-2V5a2 2 0 00-2-2h-2a3 3 0 00-3-3H8a3 3 0 00-3 3H3z"/>
                      </svg>
                      <span>Reposted by ${currentUserName}</span>
                    </div>
                    
                    <!-- Original post content -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                      <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${post.profile?.avatar_url ? 
                          `<img src="${post.profile.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;">` :
                          `<svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="color: #9ca3af;">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                          </svg>`
                        }
                      </div>
                      <div>
                        <div style="font-weight: 600; color: #1f2937; display: flex; align-items: center;">
                          <span style="cursor: pointer;" onclick="navigateToUserProfile('${post.user_id}')" onmouseover="this.style.color='#374151'; this.style.textDecoration='underline';" onmouseout="this.style.color='#1f2937'; this.style.textDecoration='none';" data-user-id="${post.user_id}">${post.profile?.full_name || 'User'}</span>
                          ${post.profile?.is_verified === true ? `<span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; margin-left: 4px;" title="Verified Account">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <!-- Simple blue circle -->
                              <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                              <!-- White checkmark in center -->
                              <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          </span>` : ''}
                        </div>
                        ${post.profile?.title ? `<div style="font-size: 12px; color: #64748b; margin-top: 2px;">${post.profile.title}</div>` : ''}
                        <div style="font-size: 14px; color: #6b7280;">${formatTimeAgo(post.created_at)}</div>
                      </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      ${post.content}
                    </div>
                    ${post.video_url
                      ? `<div class="post-media"><video src="${post.video_url}" controls style="max-width:100%;border-radius:12px;margin:8px 0;max-height:420px;"></video></div>`
                      : (post.image_url ? `<div class="post-media"><img src="${post.image_url}" alt="Post image" style="max-width:100%;border-radius:12px;margin:8px 0;"/></div>` : '')}
                    
                    <!-- Post metadata -->
                    <div style="display: flex; align-items: center; gap: 16px; font-size: 14px; color: #64748b; margin-bottom: 12px;">
                      ${post.category ? `<span>Kategori: ${post.category}</span>` : ''}
                      ${post.want_solution ? '<span style="color: #38bdf8;">💡 Mencari solusi</span>' : ''}
                    </div>
                    
                    <!-- Post interactions -->
                    <div style="display: flex; gap: 16px; color: #6b7280; font-size: 14px;">
                      <button class="action-btn like-btn" onclick="likePost('${post.id}')" title="Like">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.834a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                        </svg>
                        <span class="count">0</span>
                      </button>
                      <button class="action-btn comment-btn" onclick="commentPost('${post.id}')" title="Comment">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                        </svg>
                        <span class="count">0</span>
                      </button>
                      <button class="action-btn repost-btn" onclick="repostPost('${post.id}')" title="Repost">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8zM3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15a2 2 0 002-2V5a2 2 0 00-2-2h-2a3 3 0 00-3-3H8a3 3 0 00-3 3H3z"/>
                        </svg>
                        <span class="count">0</span>
                      </button>
                      <button class="action-btn save-btn" onclick="savePost('${post.id}', true)" title="Save">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                        </svg>
                      </button>
                      <button class="action-btn share-btn" onclick="sharePost('${post.id}')" title="Share">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                `;
              }).join('');
              
            // Check repost status and update counts for all reposted posts
            repostsWithProfiles
              .filter(repost => repost !== null)
              .forEach(repost => {
                if (repost.post && repost.post.id) {
                  checkRepostStatus(repost.post.id);
                  updateRepostCount(repost.post.id);
                }
              });
          } else {
            postsContainer.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #6b7280;">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 20 20" style="margin-bottom: 16px;">
                  <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8zM3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15a2 2 0 002-2V5a2 2 0 00-2-2h-2a3 3 0 00-3-3H8a3 3 0 00-3 3H3z"/>
                </svg>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Belum ada repost</div>
                <div>Post yang Anda repost akan muncul di sini</div>
              </div>
            `;
          }
        }
        
      } catch (error) {
        console.error('Error in loadReposts:', error);
      } finally {
        // Reset loading flag
        isLoadingReposts = false;
      }
    }
    
    // Load media posts for media tab - shows posts with images or videos
    async function loadMediaPosts() {
      // Prevent duplicate loading
      if (isLoadingMediaPosts) {
        console.log('Already loading media posts, skipping...');
        return;
      }
      
      try {
        isLoadingMediaPosts = true;
        const urlParams = new URLSearchParams(window.location.search);
        const viewingUserId = urlParams.get('user');
        const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
        
        if (!targetUserId) {
          console.log('No target user ID for media posts');
          return;
        }
        
        console.log('Loading media posts for user:', targetUserId);
        
        // Clear container first to prevent duplicates
        const mediaContainer = document.getElementById('postsContainer');
        if (mediaContainer) {
          mediaContainer.innerHTML = '';
        }
        
        // First, let's check all posts for this user to see what media fields exist
        const { data: allPosts, error: allPostsError } = await supabase
          .from('posts')
          .select('id, image_url, video_url')
          .eq('user_id', targetUserId);
        
        if (!allPostsError) {
          console.log('All posts for user (for debugging):', allPosts);
          const postsWithMedia = allPosts.filter(post => post.image_url || post.video_url);
          console.log('Posts with media found:', postsWithMedia);
        }
        
        // Get posts with media (image_url or video_url is not null)
        const { data: posts, error } = await supabase
          .from('posts')
          .select('id, user_id, content, category, identity, want_solution, image_url, video_url, is_pinned, created_at, updated_at')
          .eq('user_id', targetUserId)
          .or('image_url.not.is.null,video_url.not.is.null')
          .order('is_pinned', { ascending: false })
          .order('created_at', { ascending: false });
          
        if (error) {
          console.error('Error loading media posts:', error);
          return;
        }
        
        console.log('Media posts loaded:', posts);
        
        // Remove duplicates based on post ID
        const uniquePosts = [];
        const seenIds = new Set();
        
        if (posts) {
          for (const post of posts) {
            if (!seenIds.has(post.id)) {
              seenIds.add(post.id);
              uniquePosts.push(post);
            }
          }
        }
        
        console.log('Unique media posts after deduplication:', uniquePosts);
        
        // Display media posts in posts container
        const postsContainer = document.getElementById('postsContainer');
        if (postsContainer) {
          if (uniquePosts && uniquePosts.length > 0) {
            // Create post elements sequentially with error handling
            postsContainer.innerHTML = '';
            for (const post of uniquePosts) {
              try {
                const postElement = await createUserPostElement(post);
                if (postElement) {
                  postsContainer.appendChild(postElement);
                }
              } catch (postError) {
                console.error('Error creating post element:', postError);
              }
            }
          } else {
            postsContainer.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #6b7280;">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 20 20" style="margin-bottom: 16px;">
                  <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Belum ada media</div>
                <div>Postingan dengan foto atau video akan muncul di sini</div>
              </div>
            `;
          }
        }
        
      } catch (error) {
        console.error('Error in loadMediaPosts:', error);
      } finally {
        // Reset loading flag
        isLoadingMediaPosts = false;
      }
    }
    
    // Display saved posts in archive
    async function displaySavedPosts(savedPosts) {
      console.log('displaySavedPosts called with:', savedPosts);
      
      // Wait a bit for DOM to be ready
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Use the same container as other tabs for consistency
      const postsContainer = document.getElementById('postsContainer');
      
      if (!postsContainer) {
        console.error('Posts container not found');
        return;
      }
      
      console.log('Using postsContainer for archive');
      
      // Clear existing content
      postsContainer.innerHTML = '';
      
      if (!savedPosts || savedPosts.length === 0) {
        console.log('No saved posts found or empty array');
        postsContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Belum ada postingan yang disimpan.</p>';
        return;
      }
      
      // Remove duplicates based on post ID
      const uniquePosts = [];
      const seenIds = new Set();
      
      for (const post of savedPosts) {
        if (post && post.id && !seenIds.has(post.id)) {
          seenIds.add(post.id);
          uniquePosts.push(post);
        }
      }
      
      console.log('Unique saved posts after deduplication:', uniquePosts.length);
      
      // Display each saved post
      console.log('Rendering', uniquePosts.length, 'unique saved posts');
      for (const post of uniquePosts) {
        try {
          console.log('Rendering saved post:', post.id);
          // Use getProfileInfo for saved posts to show original author's name
          const postElement = await createOtherUserPostElement(post);
          if (postElement) {
            postsContainer.appendChild(postElement);
            console.log('Successfully appended post element');
          } else {
            console.warn('createOtherUserPostElement returned null for post:', post.id);
          }
        } catch (e) {
          console.warn('Failed to render saved post:', post?.id, e);
        }
      }
      
      console.log('Final postsContainer children count:', postsContainer.children.length);
    }
    
    // Create individual post element for other users' posts (Archive, Reposts)
    async function createOtherUserPostElement(post) {
      try {
        const postDiv = document.createElement('div');
        postDiv.className = 'user-post-item';
        postDiv.id = `post-${post.id}`;
        postDiv.style.cssText = `
          background: #ffffff;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 16px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        `;
        
        const timeAgo = getTimeAgo(new Date(post.created_at));
        
        // For other users' posts (Archive, Reposts), use getProfileInfo to get original author's info
        const { avatarHtml, displayName, verifiedBadge, profession } = await getProfileInfo(post);
      
      postDiv.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 12px;">
          ${avatarHtml}
          <div>
            <div style="font-weight: 600; color: #374151; display: flex; align-items: center;">
              ${post.identity === 'anonymous' 
                ? `<span style="color: #374151; cursor: default;" title="User anonim - profil tidak dapat diakses">${displayName}</span>`
                : `<span onclick="navigateToUserProfile('${post.user_id}')" style="cursor: pointer; color: #374151; text-decoration: none;" onmouseover="this.style.color='#1f2937'; this.style.textDecoration='underline';" onmouseout="this.style.color='#374151'; this.style.textDecoration='none';" data-user-id="${post.user_id}">${displayName}</span>`
              }${verifiedBadge}
            </div>
            ${profession ? `<div style="font-size: 12px; color: #64748b; margin-top: 2px;">${profession}</div>` : ''}
            <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${timeAgo}</div>
          </div>
        </div>
        <div style="color: #374151; line-height: 1.6; margin-bottom: 12px;">
          ${post.content}
        </div>
        ${post.video_url
          ? `<div class=\"post-media\"><video src=\"${post.video_url}\" controls style=\"max-width:100%;border-radius:12px;margin:8px 0;max-height:420px;\"></video></div>`
          : (post.image_url ? `<div class=\"post-media\"><img src=\"${post.image_url}\" alt=\"Post image\" style=\"max-width:100%;border-radius:12px;margin:8px 0;\"/></div>` : '')}
        <div style="display: flex; align-items: center; gap: 16px; font-size: 14px; color: #64748b; margin-bottom: 12px;">
          ${post.category ? `<span>Kategori: ${post.category}</span>` : ''}
          ${post.want_solution ? '<span style="color: #38bdf8;">💡 Mencari solusi</span>' : ''}
        </div>
        <div class="post-actions">
          <button class="action-btn like-btn" onclick="likePost('${post.id}')" title="Like">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.834a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
            </svg>
            <span class="count">0</span>
          </button>
          <button class="action-btn follow-btn" onclick="followPost('${post.id}')" title="Pin Post">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 384 512">
              <path d="M32 32C32 14.3 46.3 0 64 0H320c17.7 0 32 14.3 32 32s-14.3 32-32 32H290.5l11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3H32c-10.3 0-19.9-4.9-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64H64C46.3 64 32 49.7 32 32zM160 384h64v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z"/>
            </svg>
          </button>
          <button class="action-btn save-btn" onclick="savePost('${post.id}')" title="Save">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
            </svg>
          </button>
          <button class="action-btn repost-btn" onclick="repostPost('${post.id}')" title="Repost">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8zM3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15a2 2 0 002-2V5a2 2 0 00-2-2h-2a3 3 0 00-3-3H8a3 3 0 00-3 3H3z"/>
            </svg>
            <span class="count">0</span>
          </button>
        </div>
      `;
      
      // Load initial counts
      loadPostCounts(post.id);
      
      return postDiv;
      
    } catch (error) {
      console.error('Error creating other user post element:', error);
      return null;
    }
  }
    
    // Display user's posts in profile
    async function displayUserPosts(posts) {
      const postsContainer = document.getElementById('postsContainer');
      if (!postsContainer) {
        console.error('User posts container not found');
        return;
      }
      // Toggle empty state based on posts availability
      try {
        const emptyState = document.querySelector('.empty-state');
        if (emptyState) {
          if (posts && posts.length > 0) {
            emptyState.style.display = 'none';
          } else {
            emptyState.style.display = 'block';
          }
        }
      } catch (_) {}
      
      // Clear existing posts
      postsContainer.innerHTML = '';
      
      if (!posts || posts.length === 0) {
        postsContainer.innerHTML = '';
        return;
      }
      
      // Create post elements sequentially with error handling
      for (const post of posts) {
        try {
          const postElement = await createUserPostElement(post);
          postsContainer.appendChild(postElement);
        } catch (error) {
          console.error('Error creating post element for post:', post.id, error);
          // Continue with other posts even if one fails
        }
      }
    }
    
    // Create individual user post element (for user's own posts)
    async function createUserPostElement(post) {
      try {
        const postDiv = document.createElement('div');
        postDiv.className = 'user-post-item';
        postDiv.id = `post-${post.id}`;
        postDiv.style.cssText = `
          background: #ffffff;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 16px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        `;
        
        const timeAgo = getTimeAgo(new Date(post.created_at));
        
        // For user's own posts (Posts and Media tabs), use the profile data directly
        const urlParams = new URLSearchParams(window.location.search);
        const viewingUserId = urlParams.get('user');
        const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
        const userProfile = await getUserProfile(targetUserId);
        
        // Use the profile data directly for user's own posts
        const profileImage = userProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg';
        const fullName = userProfile.full_name || userProfile.name || '';
        const profession = userProfile.title || userProfile.profession || '';
        const isVerified = userProfile.is_verified || false;
        
        const avatarHtml = `
          <img src="${profileImage}" alt="${fullName}" class="avatar custom-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
        `;
        
        const displayName = fullName;
        
        const verifiedBadge = isVerified ? `<span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; margin-left: 4px;" title="Verified Account">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Simple blue circle -->
              <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
              <!-- Checkmark -->
              <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>` : '';
      
      postDiv.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 12px;">
          ${avatarHtml}
          <div>
            <div style="font-weight: 600; color: #374151; display: flex; align-items: center;">
              ${post.identity === 'anonymous' 
                ? `<span style="color: #374151; cursor: default;" title="User anonim - profil tidak dapat diakses">${displayName}</span>`
                : `<span onclick="navigateToUserProfile('${post.user_id}')" style="cursor: pointer; color: #374151; text-decoration: none;" onmouseover="this.style.color='#1f2937'; this.style.textDecoration='underline';" onmouseout="this.style.color='#374151'; this.style.textDecoration='none';" data-user-id="${post.user_id}">${displayName}</span>`
              }${verifiedBadge}
            </div>
            ${profession ? `<div style="font-size: 12px; color: #64748b; margin-top: 2px;">${profession}</div>` : ''}
            <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${timeAgo}</div>
          </div>
        </div>
        <div style="color: #374151; line-height: 1.6; margin-bottom: 12px;">
          ${post.content}
        </div>
        ${post.video_url
          ? `<div class=\"post-media\"><video src=\"${post.video_url}\" controls style=\"max-width:100%;border-radius:12px;margin:8px 0;max-height:420px;\"></video></div>`
          : (post.image_url ? `<div class=\"post-media\"><img src=\"${post.image_url}\" alt=\"Post image\" style=\"max-width:100%;border-radius:12px;margin:8px 0;\"/></div>` : '')}
        <div style="display: flex; align-items: center; gap: 16px; font-size: 14px; color: #64748b; margin-bottom: 12px;">
          ${post.category ? `<span>Kategori: ${post.category}</span>` : ''}
          ${post.want_solution ? '<span style="color: #38bdf8;">💡 Mencari solusi</span>' : ''}
        </div>
        <div class="post-actions">
          <button class="action-btn like-btn" onclick="likePost('${post.id}')" title="Like">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.834a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
            </svg>
            <span class="count">0</span>
          </button>
          <button class="action-btn" onclick="commentPost('${post.id}')" title="Comment">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.314-3.582 6-8 6-.87 0-1.706-.108-2.486-.31L3 17l1.31-3.514C3.108 12.706 3 11.87 3 11c0-3.314 3.582-6 8-6s8 2.686 8 6z" clip-rule="evenodd"/>
            </svg>
            <span class="count">0</span>
          </button>
          <button class="action-btn follow-btn" onclick="followPost('${post.id}')" title="Pin Post">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 384 512">
              <path d="M32 32C32 14.3 46.3 0 64 0H320c17.7 0 32 14.3 32 32s-14.3 32-32 32H290.5l11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3H32c-10.3 0-19.9-4.9-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64H64C46.3 64 32 49.7 32 32zM160 384h64v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z"/>
            </svg>
          </button>
          <button class="action-btn save-btn" onclick="savePost('${post.id}')" title="Save">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
            </svg>
          </button>
          <button class="action-btn repost-btn" onclick="repostPost('${post.id}')" title="Repost">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8zM3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15a2 2 0 002-2V5a2 2 0 00-2-2h-2a3 3 0 00-3-3H8a3 3 0 00-3 3H3z"/>
            </svg>
            <span class="count">0</span>
          </button>
          <button class="action-btn" onclick="sharePost('${post.id}')" title="Share">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3 3 0 000-1.319l4.94-2.47A3 3 0 0015 8z"/>
            </svg>
          </button>
        </div>
        <div class="post-comments-toggle" style="margin-top:6px;">
          <button
            style="background:none;border:none;color:#6b7280;font-size:12px;padding:0;margin:0;cursor:pointer;"
            onclick="toggleComments('${post.id}')"
            id="comments-toggle-${post.id}">Lihat komentar.....</button>
        </div>
        <div id="comments-${post.id}" style="display:none;" data-owner-id="${post.user_id}"></div>
      `;
      
        // Load initial counts
        loadPostCounts(post.id);
        
        // Check repost status for current user
        checkRepostStatus(post.id);
        
        // Load interaction states for current user
        loadInteractionStates(post.id);
      // Add delete button (owner is always current user on profile posts)
      try {
        const actions = postDiv.querySelector('.post-actions');
        if (actions) {
          const delBtn = document.createElement('button');
          delBtn.className = 'action-btn';
          delBtn.title = 'Hapus Post';
          delBtn.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 448 512"><path d="M135.2 17.7C140.6 7.2 151.2 0 162.7 0H285.3c11.5 0 22.1 7.2 27.5 17.7L328 32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 96 0 81.7 0 64S14.3 32 32 32H120l15.2-14.3zM53.2 467c1.6 25.5 22.8 45 48.4 45H346.4c25.6 0 46.8-19.5 48.4-45L416 128H32l21.2 339z"/></svg>';
          delBtn.addEventListener('click', () => deletePost(post.id));
          actions.appendChild(delBtn);
        }
      } catch (_) {}
        
        return postDiv;
      } catch (error) {
        console.error('Error creating post element:', error);
        // Return a fallback element
        const fallbackDiv = document.createElement('div');
        fallbackDiv.className = 'user-post-item';
        fallbackDiv.style.cssText = `
          background: #ffffff;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 16px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        `;
        fallbackDiv.innerHTML = `
          <div style="text-align: center; color: #ef4444; padding: 20px;">
            Gagal memuat postingan. Silakan refresh halaman.
          </div>
        `;
        return fallbackDiv;
      }
    }
    
    // Load initial counts for a post
    async function loadPostCounts(postId) {
      try {
        // Validate postId
        if (!postId || postId === 'null' || postId === 'undefined') {
          console.error('Invalid postId:', postId);
          return;
        }

        // Load like count with improved headers
        try {
        const { data: likeData, error: likeError } = await supabase
          .from('post_likes')
            .select('id', { count: 'exact' })
          .eq('post_id', postId);
        
          if (!likeError && likeData !== null) {
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = likeData.length || 0;
            }
          }
        } else {
            console.warn('Like count error (406/RLS issue):', likeError);
            // Set to 0 if error
            const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
            if (likeBtn) {
              const countSpan = likeBtn.querySelector('.count');
              if (countSpan) {
                countSpan.textContent = '0';
              }
            }
          }
        } catch (likeCountError) {
          console.warn('Like count request failed:', likeCountError);
          // Set to 0 if error
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = '0';
            }
          }
        }
        
        // Load comment count with improved headers
        try {
        const { data: commentData, error: commentError } = await supabase
          .from('post_comments')
            .select('id', { count: 'exact' })
          .eq('post_id', postId);
        
          if (!commentError && commentData !== null) {
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = commentData.length || 0;
            }
          }
        } else {
            console.warn('Comment count error (406/RLS issue):', commentError);
            // Set to 0 if error
            const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
            if (commentBtn) {
              const countSpan = commentBtn.querySelector('.count');
              if (countSpan) {
                countSpan.textContent = '0';
              }
            }
          }
        } catch (commentCountError) {
          console.warn('Comment count request failed:', commentCountError);
          // Set to 0 if error
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = '0';
            }
          }
        }
        
        // Check if current user has liked/saved/followed this post
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          // Check like status with better error handling
          try {
          const { data: userLike, error: likeCheckError } = await supabase
            .from('post_likes')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (userLike && !likeCheckError) {
            updateLikeButton(postId, true);
            }
          } catch (likeError) {
            console.warn('Like check failed:', likeError);
          }
          
          // Check save status with better error handling
          try {
          const { data: userSave, error: saveCheckError } = await supabase
            .from('post_saves')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (userSave && !saveCheckError) {
            updateSaveButton(postId, true);
            }
          } catch (saveError) {
            console.warn('Save check failed:', saveError);
          }

          // Check pin status with better error handling
          try {
            console.log('DEBUG: Checking pin status - postId:', postId, 'user.id:', user.id);
            const { data: post, error: pinCheckError } = await supabase
              .from('posts')
              .select('is_pinned, user_id')
              .eq('id', postId)
              .single();
            
            if (post && !pinCheckError && post.is_pinned) {
              updateFollowButton(postId, true);
            }
          } catch (pinError) {
            console.warn('Pin check failed:', pinError);
          }
        }
        
      } catch (error) {
        console.log('Error loading post counts:', error);
        // Set to 0 if error
        const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
        if (likeBtn) {
          const countSpan = likeBtn.querySelector('.count');
          if (countSpan) {
            countSpan.textContent = '0';
          }
        }
        
        const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
        if (commentBtn) {
          const countSpan = commentBtn.querySelector('.count');
          if (countSpan) {
            countSpan.textContent = '0';
          }
        }
      }
    }
    
    // Get time ago string
    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Baru saja';
      if (minutes < 60) return `${minutes} menit yang lalu`;
      if (hours < 24) return `${hours} jam yang lalu`;
      return `${days} hari yang lalu`;
    }
    
    // Function to get user profile data from Supabase
    async function getUserProfile(targetUserId = null) {
      try {
        // If no targetUserId provided, get current user
        let userId = targetUserId;
        if (!userId) {
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          if (userError || !user) {
            console.error('Error getting user:', userError);
            return getFallbackProfile();
          }
          userId = user.id;
        }
        
        // Get user profile from profiles table with better error handling
        console.log('getUserProfile - fetching profile for userId:', userId);
        
        // Optimized single query approach
        const result = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId);
        
        let profile = null;
        let profileError = null;
        
        if (result.data && result.data.length > 0) {
          profile = result.data[0];
          console.log('Profile found:', profile);
        } else {
          profileError = result.error;
          console.log('Profile not found:', profileError);
        }
        
        console.log('getUserProfile - final query result:', { profile, error: profileError });
        
        if (profileError) {
          console.error('Error getting profile:', profileError);
          console.log('Profile error details:', {
            message: profileError.message,
            details: profileError.details,
            hint: profileError.hint,
            code: profileError.code
          });
          return getFallbackProfile();
        }
        
        if (!profile) {
          console.log('No profile found for user:', userId);
          return getFallbackProfile();
        }
        
        console.log('User profile from database:', profile);
        console.log('Available profile fields:', Object.keys(profile));
        console.log('Profile image field:', profile.profile_image);
        console.log('Avatar URL field:', profile.avatar_url);
        console.log('Full name field:', profile.full_name);
        console.log('Avatar URL type:', typeof profile.avatar_url);
        console.log('Avatar URL length:', profile.avatar_url ? profile.avatar_url.length : 'null/undefined');
        
        const userProfile = {
          name: profile.full_name || '',
          full_name: profile.full_name || '',
          profile_image: (profile.avatar_url && profile.avatar_url !== 'NULL') 
            ? profile.avatar_url 
            : 'assets/img/profil picture/default-avatar.jpg',
          profession: profile.title || profile.profession || '',
          title: profile.title || profile.profession || '',
          is_verified: profile.is_verified || false
        };
        
        console.log('Processed user profile:', userProfile);
        return userProfile;
        
      } catch (error) {
        console.error('Error in getUserProfile:', error);
        return getFallbackProfile();
      }
    }
    
    function getFallbackProfile() {
      return {
        name: 'Pengguna',
        full_name: 'Pengguna',
        profile_image: 'assets/img/profil picture/default-avatar.jpg',
        profession: '',
        title: '',
        is_verified: false
      };
    }
    
    async function getProfileInfo(post) {
      try {
        const identity = post.identity;
        let avatarHtml, displayName, verifiedBadge = '', profession = '';
        
        // Ambil data profil pengguna yang membuat postingan
        const userProfile = await getUserProfile(post.user_id);
      
        if (identity === 'anonymous') {
          // Anonim - avatar abu-abu dengan huruf A
          avatarHtml = `
            <div class="avatar anonymous">
              A
            </div>
          `;
          displayName = 'Anonim';
          profession = '';
        } else if (identity === 'custom_anon') {
          // Custom Handle/Public - tampilkan foto profil asli pengguna yang login
          const profileImage = userProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg';
          const fullName = userProfile.full_name || userProfile.name || '';
          profession = userProfile.title || userProfile.profession || '';
          
          
          avatarHtml = `
            <img src="${profileImage}" alt="${fullName}" class="avatar custom-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
          `;
          displayName = fullName;
        } else if (identity === 'verified') {
          // HANYA tampilkan sebagai verified jika is_verified = true
          if (userProfile.is_verified === true) {
            const profileImage = userProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg';
            const fullName = userProfile.full_name || userProfile.name || '';
            profession = userProfile.title || userProfile.profession || '';
            
            // Generate professional badge if profession exists
            if (profession && profession.trim()) {
              const professionalIcon = getProfessionalIcon(profession);
              if (professionalIcon) {
                professionalBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; margin-left: 4px;" title="Professional: ${profession}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- Simple gray circle -->
                  <circle cx="12" cy="12" r="10" fill="#64748b"/>
                    <!-- Professional icon -->
                    ${professionalIcon}
                  </svg>
                </span>`;
              }
            }
            
            avatarHtml = `
              <img src="${profileImage}" alt="${fullName}" class="avatar verified-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'" style="border: 2px solid #38bdf8;">
            `;
            displayName = fullName;
            verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; margin-left: 4px;" title="Verified Account">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- Simple blue circle -->
                  <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                <!-- White checkmark in center -->
                <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>`;
          } else {
            // Jika identity = verified tapi is_verified = false, tampilkan sebagai custom_anon
            const profileImage = userProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg';
            const fullName = userProfile.full_name || userProfile.name || '';
            profession = userProfile.title || userProfile.profession || '';
            
            // Generate professional badge if profession exists
            if (profession && profession.trim()) {
              const professionalIcon = getProfessionalIcon(profession);
              if (professionalIcon) {
                professionalBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; margin-left: 4px;" title="Professional: ${profession}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- Simple gray circle -->
                  <circle cx="12" cy="12" r="10" fill="#64748b"/>
                    <!-- Professional icon -->
                    ${professionalIcon}
                  </svg>
                </span>`;
              }
            }
            
            avatarHtml = `
              <img src="${profileImage}" alt="${fullName}" class="avatar custom-profile" onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
            `;
            displayName = fullName;
            verifiedBadge = '';
          }
        } else {
          // Default fallback
          avatarHtml = `
            <div class="avatar anonymous">
              A
            </div>
          `;
          displayName = 'Anonim';
          profession = '';
        }
      
        return { avatarHtml, displayName, verifiedBadge, profession };
      } catch (error) {
        console.error('Error getting profile info:', error);
        // Return fallback values
        return {
          avatarHtml: '<div class="avatar anonymous">U</div>',
          displayName: 'User',
          verifiedBadge: '',
          profession: '',
        };
      }
    }
    
    // =============================
    // User Profile Navigation
    // =============================
    
    function navigateToUserProfile(userId) {
      if (!userId) {
        console.warn('No user ID provided for profile navigation');
        return;
      }
      
      console.log('Navigating to user profile:', userId);
      
      // Use URL parameter instead of localStorage for persistence
      const url = new URL('profile-desktop.html', window.location.origin);
      url.searchParams.set('user', userId);
      
      // Navigate to profile page with user parameter
      window.location.href = url.toString();
    }
    
    // Post interaction functions
    async function likePost(postId) {
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk memberikan like!', 'error');
          return;
        }

        // Check if user already liked this post
        const { data: existingLike, error: checkError } = await supabase
          .from('post_likes')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking like:', checkError);
          return;
        }

        if (existingLike) {
          // Unlike the post
          const { error: deleteError } = await supabase
            .from('post_likes')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id);

          if (deleteError) {
            console.error('Error removing like:', deleteError);
            return;
          }
          
          // Update UI
          updateLikeButton(postId, false);
          showNotification('Like dihapus!', 'info');
        } else {
          // Like the post
          const { error: insertError } = await supabase
            .from('post_likes')
            .insert({
              post_id: postId,
              user_id: user.id,
              created_at: new Date().toISOString()
            });

          if (insertError) {
            console.error('Error adding like:', insertError);
            return;
          }
          
          // Update UI
          updateLikeButton(postId, true);
          showNotification('Postingan disukai!', 'success');
        }

        // Refresh like count
        updateLikeCount(postId);
        
      } catch (error) {
        console.error('Error in likePost:', error);
        showNotification('Terjadi kesalahan saat memberikan like!', 'error');
      }
    }
    
    // Global variable to store current post ID for commenting
    let currentCommentPostId = null;

    function commentPost(postId) {
      // Check if user is logged in first
      const isLoggedIn = localStorage.getItem('speakup_logged_in');
      if (isLoggedIn !== 'true') {
        showNotification('Silakan login terlebih dahulu untuk berkomentar!', 'error');
        return;
      }

      currentCommentPostId = postId;
      openCommentModal();
    }

    function openCommentModal() {
      const modal = document.getElementById('commentModal');
      const textarea = document.getElementById('commentText');
      
      modal.style.display = 'block';
      textarea.value = '';
      textarea.focus();
      
      // Close emoji picker if open
      const emojiPicker = document.getElementById('emojiPicker');
      emojiPicker.style.display = 'none';
    }

    function closeCommentModal() {
      const modal = document.getElementById('commentModal');
      modal.style.display = 'none';
      currentCommentPostId = null;
    }

    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      
      if (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') {
        emojiPicker.style.display = 'block';
      } else {
        emojiPicker.style.display = 'none';
      }
    }

    function insertEmoji(emoji) {
      const textarea = document.getElementById('commentText');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
      
      // Close emoji picker
      const emojiPicker = document.getElementById('emojiPicker');
      emojiPicker.style.display = 'none';
    }

    async function submitComment() {
      const commentText = document.getElementById('commentText').value.trim();
      
      if (!commentText) {
        showNotification('Komentar tidak boleh kosong!', 'error');
        return;
      }

      if (!currentCommentPostId) {
        showNotification('Error: Post ID tidak ditemukan!', 'error');
        return;
      }

      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk berkomentar!', 'error');
          return;
        }

        console.log('Adding comment for post:', currentCommentPostId, 'by user:', user.id);

        // Insert comment
        const { data, error: insertError } = await supabase
          .from('post_comments')
          .insert({
            post_id: currentCommentPostId,
            user_id: user.id,
            content: commentText
          })
          .select();

        if (insertError) {
          console.error('Error adding comment:', insertError);
          showNotification('Gagal menambahkan komentar: ' + insertError.message, 'error');
          return;
        }

        console.log('Comment added successfully:', data);
        showNotification('Komentar berhasil ditambahkan!', 'success');
        
        // Close modal and refresh comment count
        closeCommentModal();
        updateCommentCount(currentCommentPostId);
        
      } catch (error) {
        console.error('Error in submitComment:', error);
        showNotification('Terjadi kesalahan saat menambahkan komentar!', 'error');
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('commentModal');
      if (event.target === modal) {
        closeCommentModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeCommentModal();
      }
    });

    // Close emoji picker when clicking outside
    document.addEventListener('click', function(event) {
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiBtn = document.querySelector('.emoji-btn');
      
      if (emojiPicker && emojiPicker.style.display === 'block') {
        if (!emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
          emojiPicker.style.display = 'none';
        }
      }
    });
    
    async function savePost(postId, isRepost = false) {
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk menyimpan postingan!', 'error');
          return;
        }

        console.log('DEBUG: Save post attempt - postId:', postId, 'user.id:', user.id);
        console.log('DEBUG: PostId type:', typeof postId, 'User ID type:', typeof user.id);

        // Check if user already saved this post (considering repost status)
        const { data: existingSave, error: checkError } = await supabase
          .from('post_saves')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .eq('is_repost', isRepost)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking save:', checkError);
          return;
        }

        if (existingSave) {
          // Unsave the post
          const { error: deleteError } = await supabase
            .from('post_saves')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .eq('is_repost', isRepost);

          if (deleteError) {
            console.error('Error removing save:', deleteError);
            return;
          }
          
          // Update UI
          updateSaveButton(postId, false, isRepost);
          showNotification('Postingan dihapus dari simpanan!', 'info');
        } else {
          // Save the post
          console.log('DEBUG: Inserting save - postId:', postId, 'user_id:', user.id, 'isRepost:', isRepost);
          const { data: insertData, error: insertError } = await supabase
            .from('post_saves')
            .insert({
              post_id: postId,
              user_id: user.id,
              is_repost: isRepost,
              created_at: new Date().toISOString()
            })
            .select();

          console.log('DEBUG: Insert result - data:', insertData, 'error:', insertError);

          if (insertError) {
            console.error('Error adding save:', insertError);
            showNotification('Gagal menyimpan postingan: ' + insertError.message, 'error');
            return;
          }
          
          // Update UI
          updateSaveButton(postId, true, isRepost);
          showNotification('Postingan disimpan!', 'success');
        }
        
      } catch (error) {
        console.error('Error in savePost:', error);
        showNotification('Terjadi kesalahan saat menyimpan postingan!', 'error');
      }
    }
    
    async function followPost(postId) {
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk mem-pin postingan!', 'error');
          return;
        }

        console.log('Pin post:', postId, 'by user:', user.id);

        // Check if post is already pinned
        const { data: post, error: postError } = await supabase
          .from('posts')
          .select('is_pinned, user_id')
          .eq('id', postId)
          .single();

        if (postError) {
          console.error('Error getting post:', postError);
          showNotification('Error getting post: ' + postError.message, 'error');
          return;
        }

        // Allow pinning any post (removed restriction)
        // Users can now pin posts from other users

        if (post.is_pinned) {
          // Unpin the post
          const { error: updateError } = await supabase
            .from('posts')
            .update({ is_pinned: false })
            .eq('id', postId);

          if (updateError) {
            console.error('Error unpinning post:', updateError);
            showNotification('Error unpinning post: ' + updateError.message, 'error');
            return;
          }
          
          // Update UI
          updateFollowButton(postId, false);
          showNotification('Postingan tidak di-pin lagi!', 'info');
          
          // Reload posts to reorder timeline
          loadUserPosts();
        } else {
          // Pin the post
          const { error: updateError } = await supabase
            .from('posts')
            .update({ is_pinned: true })
            .eq('id', postId);

          if (updateError) {
            console.error('Error pinning post:', updateError);
            showNotification('Error pinning post: ' + updateError.message, 'error');
            return;
          }
          
          // Update UI
          updateFollowButton(postId, true);
          showNotification('Postingan di-pin! Postingan ini akan diprioritaskan di timeline.', 'success');
          
          // Reload posts to reorder timeline
          loadUserPosts();
        }
        
      } catch (error) {
        console.error('Error in followPost (pin):', error);
        showNotification('Terjadi kesalahan saat mem-pin postingan!', 'error');
      }
    }

    function sharePost(postId) {
      const postUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Postingan dari SpeakUp!',
          text: 'Lihat postingan menarik ini di SpeakUp!',
          url: postUrl
        }).catch(err => {
          console.log('Error sharing:', err);
          fallbackShare(postUrl);
        });
      } else {
        fallbackShare(postUrl);
      }
    }
    
    function fallbackShare(url) {
      navigator.clipboard.writeText(url).then(() => {
        showNotification('Link berhasil disalin ke clipboard!', 'success');
      }).catch(() => {
        // Fallback untuk browser lama
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Link berhasil disalin ke clipboard!', 'success');
      });
    }
    
    // Helper functions for UI updates
    function updateLikeButton(postId, isLiked) {
      const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
      if (likeBtn) {
        if (isLiked) {
          likeBtn.classList.add('liked');
          likeBtn.title = 'Unlike';
          // Force color change
          likeBtn.style.color = '#38bdf8';
          likeBtn.style.setProperty('color', '#38bdf8', 'important');
          const svg = likeBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '#38bdf8';
            svg.style.fill = '#38bdf8';
            svg.style.setProperty('color', '#38bdf8', 'important');
            svg.style.setProperty('fill', '#38bdf8', 'important');
          }
        } else {
          likeBtn.classList.remove('liked');
          likeBtn.title = 'Like';
          // Reset color
          likeBtn.style.color = '';
          likeBtn.style.removeProperty('color');
          const svg = likeBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '';
            svg.style.fill = '';
            svg.style.removeProperty('color');
            svg.style.removeProperty('fill');
          }
        }
      }
    }
    
    function updateSaveButton(postId, isSaved, isRepost = false) {
      const saveBtn = document.querySelector(`button[onclick="savePost('${postId}'${isRepost ? ', true' : ''})"]`);
      if (saveBtn) {
        if (isSaved) {
          saveBtn.classList.add('saved');
          saveBtn.title = 'Hapus dari simpanan';
          // Force color change
          saveBtn.style.color = '#38bdf8';
          saveBtn.style.setProperty('color', '#38bdf8', 'important');
          const svg = saveBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '#38bdf8';
            svg.style.fill = '#38bdf8';
            svg.style.setProperty('color', '#38bdf8', 'important');
            svg.style.setProperty('fill', '#38bdf8', 'important');
          }
        } else {
          saveBtn.classList.remove('saved');
          saveBtn.title = 'Simpan';
          // Reset color
          saveBtn.style.color = '';
          saveBtn.style.removeProperty('color');
          const svg = saveBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '';
            svg.style.fill = '';
            svg.style.removeProperty('color');
            svg.style.removeProperty('fill');
          }
        }
      }
    }

    function updateFollowButton(postId, isFollowed) {
      const followBtn = document.querySelector(`button[onclick="followPost('${postId}')"]`);
      if (followBtn) {
        if (isFollowed) {
          followBtn.classList.add('followed');
          followBtn.title = 'Unpin Post';
          // Force color change
          followBtn.style.color = '#38bdf8';
          followBtn.style.setProperty('color', '#38bdf8', 'important');
          const svg = followBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '#38bdf8';
            svg.style.fill = '#38bdf8';
            svg.style.setProperty('color', '#38bdf8', 'important');
            svg.style.setProperty('fill', '#38bdf8', 'important');
          }
        } else {
          followBtn.classList.remove('followed');
          followBtn.title = 'Pin Post';
          // Reset color
          followBtn.style.color = '';
          followBtn.style.removeProperty('color');
          const svg = followBtn.querySelector('svg');
          if (svg) {
            svg.style.color = '';
            svg.style.fill = '';
            svg.style.removeProperty('color');
            svg.style.removeProperty('fill');
          }
        }
      }
    }

    // Repost function
    async function repostPost(postId) {
      try {
        // Check if user is logged in
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk repost!', 'error');
          return;
        }

        // Check if user already reposted this post
        const { data: existingRepost, error: checkError } = await supabase
          .from('post_reposts')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking repost:', checkError);
          return;
        }

        if (existingRepost) {
          // Unrepost the post
          const { error: deleteError } = await supabase
            .from('post_reposts')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', user.id);

          if (deleteError) {
            console.error('Error removing repost:', deleteError);
            return;
          }
          
          showNotification('Repost dihapus!', 'info');
        } else {
          // Repost the post
          const { error: insertError } = await supabase
            .from('post_reposts')
            .insert({
              post_id: postId,
              user_id: user.id,
              created_at: new Date().toISOString()
            });

          if (insertError) {
            console.error('Error adding repost:', insertError);
            return;
          }
          
          showNotification('Post berhasil di-repost!', 'success');
        }

        // Refresh repost count
        updateRepostCount(postId);
        
      } catch (error) {
        console.error('Error in repostPost:', error);
        showNotification('Terjadi kesalahan saat repost!', 'error');
      }
    }

    // Update repost count and status
    async function updateRepostCount(postId) {
      try {
        const { data, error } = await supabase
          .from('post_reposts')
          .select('id', { count: 'exact' })
          .eq('post_id', postId);
        
        if (!error && data !== null) {
          const repostBtn = document.querySelector(`button[onclick="repostPost('${postId}')"]`);
          if (repostBtn) {
            const countSpan = repostBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = data.length || 0;
            }
          }
        }
        
        // Check if current user has reposted this post
        await checkRepostStatus(postId);
      } catch (error) {
        console.warn('Repost count request failed:', error);
      }
    }
    
    // Check if current user has reposted a post and update button appearance
    async function checkRepostStatus(postId) {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          return; // User not logged in, no need to check
        }
        
        const { data: existingRepost, error: checkError } = await supabase
          .from('post_reposts')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', user.id)
          .maybeSingle();
        
        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking repost status:', checkError);
          return;
        }
        
        const repostBtn = document.querySelector(`button[onclick="repostPost('${postId}')"]`);
        if (repostBtn) {
          if (existingRepost) {
            // User has reposted this post - make button blue
            repostBtn.classList.add('reposted');
            repostBtn.style.color = '#38bdf8';
            repostBtn.title = 'Hapus repost';
            
            // Also make the SVG blue
            const svg = repostBtn.querySelector('svg');
            if (svg) {
              svg.style.color = '#38bdf8';
              svg.style.fill = '#38bdf8';
            }
          } else {
            // User hasn't reposted this post - make button normal
            repostBtn.classList.remove('reposted');
            repostBtn.style.color = '';
            repostBtn.title = 'Repost';
            
            // Reset SVG color
            const svg = repostBtn.querySelector('svg');
            if (svg) {
              svg.style.color = '';
              svg.style.fill = '';
            }
          }
        }
      } catch (error) {
        console.warn('Error checking repost status:', error);
      }
    }
    
    async function updateLikeCount(postId) {
      try {
        const { data, error } = await supabase
          .from('post_likes')
          .select('id')
          .eq('post_id', postId);
        
        if (!error && data) {
          const likeBtn = document.querySelector(`button[onclick="likePost('${postId}')"]`);
          if (likeBtn) {
            const countSpan = likeBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = data.length || 0;
            }
          }
        } else {
          console.log('Like count error or no data:', error);
        }
      } catch (error) {
        console.log('Error updating like count:', error);
      }
    }
    
    async function updateCommentCount(postId) {
      try {
        const { data, error } = await supabase
          .from('post_comments')
          .select('id')
          .eq('post_id', postId);
        
        if (!error && data) {
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"]`);
          if (commentBtn) {
            const countSpan = commentBtn.querySelector('.count');
            if (countSpan) {
              countSpan.textContent = data.length || 0;
            }
          }
        } else {
          console.log('Comment count error or no data:', error);
        }
      } catch (error) {
        console.log('Error updating comment count:', error);
      }
    }
    
    
    // Get avatar HTML based on identity
    function getAvatarHTML(identity, userProfile) {
      if (identity === 'anonymous') {
        return '<div style="width: 100%; height: 100%; background: #6b7280; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">A</div>';
      } else if (identity === 'verified') {
        if (userProfile && userProfile.avatar_url) {
          return `<img src="${userProfile.avatar_url}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          return '<div style="width: 100%; height: 100%; background: #38bdf8; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">V</div>';
        }
      } else {
        // Custom identity - show first letter
        return `<div style="width: 100%; height: 100%; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">${identity.charAt(0).toUpperCase()}</div>`;
      }
    }
    
    // Get display name based on identity
    function getDisplayName(identity, userProfile) {
      if (identity === 'anonymous') {
        return 'Anonymous';
      } else if (identity === 'verified') {
        return userProfile ? (userProfile.full_name || userProfile.username || 'Verified User') : 'Verified User';
      } else {
        return identity;
      }
    }

    
    async function loadUserProfile() {
      if (!supabase) return;
      
      // Check if we're viewing another user's profile from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const viewingUserId = urlParams.get('user');
      const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
      
      console.log('Profile loading - viewingUserId:', viewingUserId, 'targetUserId:', targetUserId, 'currentUser:', currentUser?.id);
      
      if (!targetUserId) {
        console.log('No target user ID found');
        return;
      }
      
      console.log('Loading profile for user:', targetUserId, viewingUserId ? '(viewing other user)' : '(own profile)');
      
      try {
        // Optimized single query approach
        const result = await supabase
          .from('profiles')
          .select('*')
          .eq('id', targetUserId);
        
        let data = null;
        let error = null;
        
        if (result.data && result.data.length > 0) {
          data = result.data[0];
          console.log('Profile found:', data);
        } else {
          error = result.error;
          console.log('Profile not found:', error);
        }
          
        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
          console.error('Error loading profile:', error);
          showNotification('Gagal memuat profil', 'error');
          return;
        }
        
        userProfile = data;
        
        if (data) {
          console.log('Profile data loaded:', data);
          console.log('Username from database:', data.username);
          
          // Check if user is anonymous and we're trying to view their profile
          if (data.identity === 'anonymous' && viewingUserId && viewingUserId !== currentUser?.id) {
            console.log('User is anonymous, blocking profile access');
            showNotification('Profil user anonim tidak dapat diakses', 'error');
            // Redirect back to timeline
            setTimeout(() => {
              window.location.href = 'timeline-desktop.html';
            }, 2000);
            return;
          }
          
          // Check if profile has old data and clean it
          if (data.bio && data.bio.includes('wadwdawd') || 
              data.website && data.website.includes('dika-medical-blog.com') ||
              data.location && data.location.includes('Jakarta')) {
            console.log('Found old data, clearing profile...');
            await clearDatabaseProfile();
            return;
          }
          
          // Update profile display
          updateProfileDisplay(data);
          
          // Load user stats
          await loadUserStats(targetUserId);
          
          // Check follow status if viewing another user's profile
          if (viewingUserId && viewingUserId !== currentUser?.id) {
            await checkFollowStatus();
          }
        } else {
          // Only create default profile if viewing own profile
          if (!viewingUserId || viewingUserId === currentUser?.id) {
            await createDefaultProfile();
          } else {
            // For other users, show fallback profile
            console.log('No profile found for user:', targetUserId, '- showing fallback');
            const fallbackProfile = {
              full_name: 'User',
              bio: '',
              location: '',
              website: '',
              is_verified: false
            };
            updateProfileDisplay(fallbackProfile);
          }
        }
        
        // Re-initialize tabs after profile is loaded to handle visibility
        initializeTabs();
        
        // Set button visibility based on profile ownership
        setButtonVisibility();
        
        // No need to clear URL parameter - it persists across refreshes
      } catch (error) {
        console.error('Error loading profile:', error);
        showNotification('Gagal memuat profil', 'error');
        
        // Fallback: show user data from session
        if (currentUser) {
          console.log('Showing fallback profile data from session');
          const fallbackProfile = {
            full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
            bio: '',
            location: '',
            website: '',
            is_verified: false
          };
          updateProfileDisplay(fallbackProfile);
        }
      }
    }
    
    async function createDefaultProfile() {
      if (!supabase || !currentUser) return;
      
      try {
        // First, delete any existing profile for this user
        const { error: deleteError } = await supabase
          .from('profiles')
          .delete()
          .eq('id', currentUser.id);
          
        if (deleteError) {
          console.error('Error deleting old profile:', deleteError);
        }
        
        // Clear any old data from localStorage
        localStorage.removeItem('speakup_profile_data');
        localStorage.removeItem('speakup_old_profile');
        
        // Create new empty profile
        const { data, error } = await supabase
          .from('profiles')
          .insert({
            id: currentUser.id,
            full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
            bio: '',
            avatar_url: null,
            banner_url: null,
            phone: null,
            location: '',
            website: '',
            created_at: new Date().toISOString()
          });
          
        if (error) {
          console.error('Error creating profile:', error);
          return;
        }
        
        console.log('Default profile created for new user');
        // Reload profile
        await loadUserProfile();
      } catch (error) {
        console.error('Error creating profile:', error);
      }
    }
    
    // Function to force reset profile data
    async function resetProfileData() {
      console.log('Resetting profile data...');
      
      // Clear localStorage
      localStorage.removeItem('speakup_profile_data');
      localStorage.removeItem('speakup_old_profile');
      localStorage.removeItem('speakup_user_profile');
      
      // Clear any cached data
      userProfile = null;
      
      // Force reload with empty data
      const emptyProfile = {
        full_name: currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'User',
        bio: '',
        location: '',
        website: '',
        is_verified: false
      };
      
      updateProfileDisplay(emptyProfile);
      
      console.log('Profile data reset completed');
    }
    
    
    function updateProfileDisplay(profile) {
      console.log('Updating profile display with data:', profile);
      
      // Update profile name
      const profileName = document.querySelector('.profile-name');
      if (profileName) {
        profileName.textContent = profile.full_name || 'User';
        console.log('Updated profile name:', profile.full_name);
      }
      
      // Update verified badge visibility
      const verifiedBadge = document.getElementById('profile-verified-badge');
      if (verifiedBadge) {
        if (profile.is_verified === true) {
          verifiedBadge.style.display = 'flex';
          console.log('Showing verified badge for verified user');
        } else {
          verifiedBadge.style.display = 'none';
          console.log('Hiding verified badge for non-verified user');
        }
      }
      
      // Update profile username
      const profileUsername = document.querySelector('.profile-username');
      if (profileUsername) {
        console.log('Profile data for username:', profile);
        console.log('profile.username value:', profile.username);
        console.log('profile.full_name value:', profile.full_name);
        
        const username = profile.username || profile.full_name?.toLowerCase().replace(/\s+/g, '') || 'user';
        console.log('Final username to display:', username);
        profileUsername.textContent = `@${username}`;
        console.log('Updated profile username:', username);
      }
      
      // Update profile title/role
      const profileRole = document.querySelector('.profile-role');
      if (profileRole) {
        profileRole.textContent = profile.title || '';
        console.log('Updated profile title:', profile.title);
      }
      
      
      // Update profile bio
      const profileBio = document.querySelector('.profile-bio');
      if (profileBio) {
        profileBio.textContent = profile.bio || '';
        console.log('Updated profile bio:', profile.bio);
      }
      
      // Update profile location
      const profileLocation = document.querySelector('.profile-location');
      if (profileLocation) {
        profileLocation.textContent = profile.location ? `📍 ${profile.location}` : '';
        console.log('Updated profile location:', profile.location);
      }
      
      // Update profile website
      const profileWebsite = document.querySelector('.profile-website');
      if (profileWebsite) {
        if (profile.website) {
          profileWebsite.innerHTML = `
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
            </svg>
            <a href="${profile.website}" target="_blank" style="color: #38bdf8; text-decoration: none;">${profile.website}</a>
          `;
        } else {
          profileWebsite.innerHTML = `
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
            </svg>
            <span></span>
          `;
        }
        console.log('Updated profile website:', profile.website);
      }
      
      // Update avatar if exists
      const avatar = document.getElementById('profileAvatar');
      if (avatar) {
        if (profile.avatar_url) {
          avatar.src = profile.avatar_url;
          console.log('Updated profile avatar:', profile.avatar_url);
        } else {
          // Set default avatar icon
          avatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9ImN1cnJlbnRDb2xvciIgdmlld0JveD0iMCAwIDIwIDIwIiBzdHlsZT0iY29sb3I6ICM5Y2EzYWY7Ij48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMCA5YTMgMyAwIDEwMC02IDMgMyAwIDAwMCA2em0tNyA5YTcgNyAwIDExMTQgMEgzeiIgY2xpcC1ydWxlPSJldmVub2RkIi8+PC9zdmc+';
          console.log('Set default avatar icon');
        }
      }
      
      // Update banner if exists
      if (profile.banner_url) {
        const banner = document.querySelector('.profile-cover');
        if (banner) {
          banner.style.background = `url('${profile.banner_url}') center/cover`;
          console.log('Updated profile banner:', profile.banner_url);
        } else {
          console.log('Banner element not found');
        }
      } else {
        console.log('No banner URL in profile data');
      }
      
      console.log('Profile display updated successfully');
    }
    
    function setButtonVisibility() {
      // Check if viewing own profile or other user's profile
      const urlParams = new URLSearchParams(window.location.search);
      const viewingUserId = urlParams.get('user');
      const currentUserId = currentUser ? currentUser.id : null;
      const isViewingOwnProfile = !viewingUserId || viewingUserId === currentUserId;
      
      const followButton = document.getElementById('followButton');
      const editProfileButton = document.getElementById('editProfileButton');
      const reportButton = document.getElementById('reportButton');
      
      if (isViewingOwnProfile) {
        // Viewing own profile - hide follow and report buttons, show edit button
        if (followButton) {
          followButton.style.display = 'none';
        }
        if (editProfileButton) {
          editProfileButton.style.display = 'flex';
        }
        if (reportButton) {
          reportButton.style.display = 'none';
        }
      } else {
        // Viewing other user's profile - show follow and report buttons, hide edit button
        if (followButton) {
          followButton.style.display = 'flex';
        }
        if (editProfileButton) {
          editProfileButton.style.display = 'none';
        }
        if (reportButton) {
          reportButton.style.display = 'flex';
        }
      }
    }
    
    function initializeTabs() {
      // Check if viewing own profile or other user's profile
      const urlParams = new URLSearchParams(window.location.search);
      const viewingUserId = urlParams.get('user');
      const currentUserId = currentUser ? currentUser.id : null;
      const isViewingOwnProfile = !viewingUserId || viewingUserId === currentUserId;
      
      // Hide archive tab if viewing other user's profile
      const archiveTab = document.getElementById('archiveTab');
      if (archiveTab) {
        if (isViewingOwnProfile) {
          archiveTab.style.display = 'inline-block';
          console.log('Archive tab shown (own profile)');
        } else {
          archiveTab.style.display = 'none';
          console.log('Archive tab hidden (other user profile)');
        }
      }
      
      // Hide all tabs for anonymous users (except when viewing own profile)
      if (!isViewingOwnProfile && userProfile && userProfile.identity === 'anonymous') {
        const allTabs = document.querySelectorAll('.tab-btn');
        allTabs.forEach(tab => {
          tab.style.display = 'none';
        });
        console.log('All tabs hidden for anonymous user');
        
        // Show message for anonymous user
        const postsContainer = document.getElementById('postsContainer');
        if (postsContainer) {
          postsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <svg width="48" height="48" fill="currentColor" viewBox="0 0 20 20" style="margin-bottom: 16px;">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
              </svg>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Profil Anonim</div>
              <div>User ini menggunakan profil anonim. Aktivitas mereka tidak dapat dilihat.</div>
            </div>
          `;
        }
      }
      
      // Tab functionality
      const tabButtons = document.querySelectorAll('.tab-btn');
      console.log('Found tab buttons:', tabButtons.length);
      console.log('Archive tab found:', document.getElementById('archiveTab'));
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all tabs
          tabButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.style.color = '#6b7280';
            btn.style.borderBottom = 'none';
          });
          
          // Add active class to clicked tab
          this.classList.add('active');
          this.style.color = '#38bdf8';
          this.style.borderBottom = '2px solid #38bdf8';
          
          // Handle different tab content
          const tabName = this.textContent.trim();
          console.log('Switched to tab:', tabName);
          // update hash for deep-linking
          try { window.location.hash = '#' + tabName.toLowerCase(); } catch(_) {}
          
          // Show/hide appropriate content
          const postsContainer = document.getElementById('postsContainer');
          
          if (tabName === 'Posts') {
            if (postsContainer) postsContainer.style.display = 'block';
            // Load user posts if not already loaded (prevent duplicate loading)
            if (currentUser && postsContainer.innerHTML === '') {
              loadUserPosts();
            }
          } else if (tabName === 'Archive') {
            if (postsContainer) postsContainer.style.display = 'block';
            // Load saved posts
            loadSavedPosts();
          } else if (tabName === 'Reposts') {
            // Show reposts
            if (postsContainer) postsContainer.style.display = 'block';
            // Load reposts
            loadReposts();
          } else if (tabName === 'Media') {
            // Show media posts
            if (postsContainer) postsContainer.style.display = 'block';
            // Load media posts
            loadMediaPosts();
          } else {
            // For other tabs, hide for now
            if (postsContainer) postsContainer.style.display = 'none';
          }
        });
      });

      // Deep-link: open #archive directly
      try {
        const hash = (window.location.hash || '').toLowerCase();
        if (hash === '#archive') {
          const archiveBtn = document.getElementById('archiveTab');
          if (archiveBtn) archiveBtn.click();
        }
      } catch(_) {}
    }

    // DM Modal Function - Open DM with specific user or show DM list
    async function openDMWithUser() {
      console.log('openDMWithUser called');
      
      if (!currentUser) {
        console.log('No current user found');
        showNotification('Silakan login terlebih dahulu untuk menggunakan fitur DM.', 'error');
        return;
      }
      
      // Get user ID from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const targetUserId = urlParams.get('user');
      
      // If no target user ID (own profile), show DM list
      if (!targetUserId) {
        console.log('No target user ID found in URL - showing DM list');
        await openDMModal();
        return;
      }
      
      // If target user is the same as current user (own profile), show DM list
      if (targetUserId === currentUser.id) {
        console.log('Target user is current user - showing DM list');
        await openDMModal();
        return;
      }
      
      try {
        // Get target user profile
        console.log('Getting target user profile for:', targetUserId);
        const targetUserProfile = await getUserProfile(targetUserId);
        console.log('Target user profile:', targetUserProfile);
        
        // Get or create conversation
        console.log('Creating/getting conversation between:', currentUser.id, 'and', targetUserId);
        const { data: conversationId, error: convError } = await supabase.rpc('get_or_create_conversation', {
          p_user1_id: currentUser.id,
          p_user2_id: targetUserId
        });
        
        if (convError) {
          console.error('Error creating conversation:', convError);
          showNotification('Gagal membuat percakapan: ' + convError.message, 'error');
          return;
        }
        
        console.log('Conversation created/found:', conversationId);
        
        // Open conversation directly
        await openConversation(
          conversationId,
          targetUserId,
          targetUserProfile.name || targetUserProfile.full_name || 'User',
          targetUserProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg'
        );
        
      } catch (error) {
        console.error('Error in openDMWithUser:', error);
        showNotification('Gagal membuka DM: ' + error.message, 'error');
      }
    }

    // DM Modal Function - Show conversation list first
    async function openDMModal() {
      console.log('openDMModal called');
      
      // Hapus modal lama jika ada
      const existingModal = document.querySelector('.dm-modal');
      if (existingModal) {
        existingModal.remove();
      }

      console.log('currentUser:', currentUser);
      console.log('currentUser.id:', currentUser?.id);
      console.log('currentUser.email:', currentUser?.email);
      
      if (!currentUser) {
        console.log('No current user found');
        showNotification('Silakan login terlebih dahulu untuk menggunakan fitur DM.', 'error');
        return;
      }
      
      if (!currentUser.id) {
        console.log('No current user ID found');
        showNotification('User ID tidak ditemukan. Silakan login ulang.', 'error');
        return;
      }

      try {
        // Get current user profile
        console.log('Getting user profile for:', currentUser.id);
        const currentUserProfile = await getUserProfile(currentUser.id);
        console.log('Current user profile:', currentUserProfile);
        
        // Check if supabase is available
        if (!supabase) {
          console.error('Supabase client not available');
          showNotification('Database tidak tersedia. Silakan refresh halaman.', 'error');
          showSimpleDMModal();
          return;
        }
        
        // Test database connection
        console.log('Testing database connection...');
        try {
          const { data: testData, error: testError } = await supabase.rpc('get_user_conversations', {
            p_user_id: currentUser.id
          });
          
          if (testError) {
            console.error('Database test error:', testError);
            console.log('Falling back to simple DM modal due to database error');
            showSimpleDMModal();
            return;
          }
          
          console.log('Database test successful:', testData);
          
          // Show conversation list first
          await showConversationList();
        } catch (dbError) {
          console.error('Database connection failed:', dbError);
          console.log('Falling back to simple DM modal due to connection error');
          showSimpleDMModal();
          return;
        }
      } catch (error) {
        console.error('Error in openDMModal:', error);
        showNotification('Gagal membuka DM: ' + error.message, 'error');
        // Fallback to simple modal if database error
        showSimpleDMModal();
      }
    }

    // Simple DM Modal for testing
    function showSimpleDMModal() {
      const modal = document.createElement('div');
      modal.className = 'dm-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      `;

      modal.innerHTML = `
        <div class="dm-modal-content" style="
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 500px;
          max-height: 80vh;
          overflow: hidden;
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
          animation: slideUp 0.3s ease-out;
        ">
          <div class="dm-header" style="
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">Pesan Langsung</h3>
            <button onclick="closeDMModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #6b7280;
              padding: 4px;
              border-radius: 4px;
            ">&times;</button>
          </div>
          
          <div class="dm-conversations" style="
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
          ">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <div style="font-size: 48px; margin-bottom: 16px;">🔧</div>
              <h3 style="color: #374151; margin-bottom: 16px;">Setup Database Diperlukan</h3>
              <p style="margin-bottom: 16px;">Fitur DM memerlukan setup database terlebih dahulu.</p>
              <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px; text-align: left;">
                <h4 style="color: #374151; margin-bottom: 8px;">Langkah Setup:</h4>
                <ol style="color: #6b7280; font-size: 14px; line-height: 1.6;">
                  <li>Buka <strong>Supabase Dashboard</strong></li>
                  <li>Pilih <strong>SQL Editor</strong></li>
                  <li>Copy file <code>dm-quick-fix.sql</code></li>
                  <li>Paste dan klik <strong>Run</strong></li>
                  <li>Refresh halaman ini</li>
                </ol>
              </div>
              <p style="font-size: 12px; color: #9ca3af;">
                File: <code>dm-quick-fix.sql</code> sudah tersedia di folder project
              </p>
            </div>
          </div>
          
          <div class="dm-input" style="
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
            text-align: center;
          ">
            <button onclick="closeDMModal()" style="
              background: #38bdf8;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#0ea5e9'" onmouseout="this.style.backgroundColor='#38bdf8'">
              Tutup
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close modal saat klik di luar
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeDMModal();
        }
      });
    }

    // Helper function untuk format waktu
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return 'Baru saja';
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}m`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}j`;
      } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}h`;
      } else {
        const months = Math.floor(diffInSeconds / 2592000);
        return `${months}bln`;
      }
    }

    // Show conversation list
    async function showConversationList() {
      console.log('showConversationList called');
      
      const modal = document.createElement('div');
      modal.className = 'dm-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      `;

      modal.innerHTML = `
        <div class="dm-modal-content" style="
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 500px;
          max-height: 80vh;
          overflow: hidden;
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
          animation: slideUp 0.3s ease-out;
        ">
          <div class="dm-header" style="
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">Pesan Langsung</h3>
            <button onclick="closeDMModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #6b7280;
              padding: 4px;
              border-radius: 4px;
            ">&times;</button>
          </div>
          
          <div class="dm-conversations" style="
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
          ">
            <div id="conversationsList">
              <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
                <p>Memuat percakapan...</p>
              </div>
            </div>
          </div>
          
          <div class="dm-input" style="
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
            text-align: center;
          ">
            <button onclick="startNewConversation()" style="
              background: #38bdf8;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#0ea5e9'" onmouseout="this.style.backgroundColor='#38bdf8'">
              💬 Mulai Percakapan Baru
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Load conversations
      await loadConversations();

      // Close modal saat klik di luar
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeDMModal();
        }
      });
    }

    // Load conversations from database
    async function loadConversations() {
      console.log('loadConversations called');
      try {
        const conversationsList = document.getElementById('conversationsList');
        if (!conversationsList) {
          console.log('conversationsList element not found');
          return;
        }
        
        console.log('currentUser for conversations:', currentUser);

        // Call the database function to get user conversations
        console.log('Calling get_user_conversations with user ID:', currentUser.id);
        const { data: conversations, error } = await supabase.rpc('get_user_conversations', {
          p_user_id: currentUser.id
        });

        console.log('Conversations response:', { conversations, error });

        if (error) {
          console.error('Error loading conversations:', error);
          conversationsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
              <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
              <p>Gagal memuat percakapan</p>
              <p style="font-size: 12px; color: #6b7280;">${error.message}</p>
              <p style="font-size: 10px; color: #9ca3af;">Error code: ${error.code}</p>
            </div>
          `;
          return;
        }

        if (!conversations || conversations.length === 0) {
          conversationsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
              <p>Belum ada percakapan</p>
              <p style="font-size: 12px;">Mulai percakapan dengan mengklik tombol di bawah</p>
            </div>
          `;
          return;
        }

        // Render conversations
        conversationsList.innerHTML = conversations.map(conv => `
          <div class="conversation-item" onclick="openConversation('${conv.conversation_id}', '${conv.other_user_id}', '${conv.other_user_name}', '${conv.other_user_avatar}')" style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
            ${conv.unread_count > 0 ? 'background: #eff6ff; border-left: 3px solid #38bdf8;' : 'background: white;'}
          " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='${conv.unread_count > 0 ? '#eff6ff' : 'white'}'">
            <img src="${conv.other_user_avatar}" alt="${conv.other_user_name}" style="
              width: 48px;
              height: 48px;
              border-radius: 50%;
              object-fit: cover;
            ">
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  ${conv.other_user_name}
                </h4>
                <div style="display: flex; align-items: center; gap: 8px;">
                  ${conv.is_online ? '<div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;" title="Online"></div>' : ''}
                  <span style="font-size: 11px; color: #6b7280;">
                    ${getTimeAgo(new Date(conv.last_message_at))}
                  </span>
                </div>
              </div>
              <p style="margin: 0; font-size: 12px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${conv.last_message_content || 'Belum ada pesan'}
              </p>
            </div>
            ${conv.unread_count > 0 ? `
              <div style="
                background: #38bdf8;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                font-weight: 600;
              ">
                ${conv.unread_count > 9 ? '9+' : conv.unread_count}
              </div>
            ` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error in loadConversations:', error);
      }
    }

    // Open specific conversation
    async function openConversation(conversationId, otherUserId, otherUserName, otherUserAvatar) {
      // Remove current modal
      const existingModal = document.querySelector('.dm-modal');
      if (existingModal) {
        existingModal.remove();
      }

      // Cleanup previous realtime channel
      if (realtimeChannel) {
        await supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }

      // Get user profiles
      const currentUserProfile = await getUserProfile(currentUser.id);
      const otherUserProfile = await getUserProfile(otherUserId);

      // Use the actual profile data instead of passed parameters
      const actualOtherUserName = otherUserProfile.full_name || otherUserProfile.name || otherUserName;
      const actualOtherUserAvatar = otherUserProfile.profile_image || otherUserAvatar;

      // Store conversation data for later use
      window.currentConversation = {
        id: conversationId,
        otherUserId: otherUserId,
        otherUserName: actualOtherUserName,
        otherUserAvatar: actualOtherUserAvatar
      };

      // Setup real-time channel for this conversation
      setupRealtimeChannel(conversationId, otherUserId);

      // Buat modal DM
      const modal = document.createElement('div');
      modal.className = 'dm-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      `;

      modal.innerHTML = `
        <div class="dm-modal-content" style="
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 500px;
          max-height: 80vh;
          overflow: hidden;
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
          animation: slideUp 0.3s ease-out;
        ">
          <div class="dm-header" style="
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <div style="display: flex; align-items: center; gap: 12px;">
              <button onclick="showConversationList()" style="
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                color: #6b7280;
                padding: 4px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 8px;
              " title="Kembali ke List Percakapan">←</button>
              <img src="${actualOtherUserAvatar}" alt="${actualOtherUserName}" style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
              " onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
              <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #1f2937;">${actualOtherUserName}</h3>
                <p style="margin: 0; font-size: 12px; color: #6b7280;">Aktif sekarang</p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button onclick="showConversationList()" style="
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                color: #6b7280;
                padding: 4px;
                border-radius: 4px;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Kembali ke Daftar Percakapan">
                ←
              </button>
              <button onclick="closeDMModal()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #6b7280;
                padding: 4px;
                border-radius: 4px;
              ">&times;</button>
            </div>
          </div>
          
          <div class="dm-messages" id="dmMessages" style="
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
          ">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
              <p>Memuat pesan...</p>
            </div>
          </div>
          
          <!-- Typing Indicator -->
          <div id="typingIndicator" style="display: none; padding: 0 20px;"></div>
          
          <div class="dm-input" style="
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
          ">
            <div style="display: flex; gap: 12px; align-items: center;">
              <img src="${currentUserProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg'}" alt="${currentUserProfile.full_name}" style="
                width: 32px;
                height: 32px;
                border-radius: 50%;
                object-fit: cover;
              ">
              <div style="flex: 1; position: relative;">
                <input type="text" id="dmMessageInput" placeholder="Ketik pesan..." style="
                  width: 100%;
                  padding: 12px 50px 12px 16px;
                  border: 1px solid #d1d5db;
                  border-radius: 20px;
                  font-family: inherit;
                  font-size: 14px;
                  outline: none;
                  transition: border-color 0.2s;
                " onfocus="this.style.borderColor='#38bdf8'" onblur="this.style.borderColor='#d1d5db'" onkeypress="handleDMKeyPress(event)">
                
                <!-- Emoji Button -->
                <button type="button" onclick="toggleDMEmojiPicker()" style="
                  position: absolute;
                  right: 8px;
                  top: 50%;
                  transform: translateY(-50%);
                  background: none;
                  border: none;
                  font-size: 18px;
                  cursor: pointer;
                  padding: 4px;
                  border-radius: 4px;
                  transition: background-color 0.2s;
                " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Pilih Emoji">
                  😊
                </button>
                
                <!-- DM Emoji Picker -->
                <div id="dmEmojiPicker" style="
                  position: absolute;
                  bottom: 50px;
                  right: 0;
                  background: white;
                  border: 1px solid #e5e7eb;
                  border-radius: 12px;
                  padding: 12px;
                  box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
                  display: none;
                  z-index: 1000;
                  width: 200px;
                  max-height: 150px;
                  overflow-y: auto;
                ">
                  <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                    <button type="button" onclick="insertDMEmoji('😊')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">😊</button>
                    <button type="button" onclick="insertDMEmoji('😢')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">😢</button>
                    <button type="button" onclick="insertDMEmoji('😡')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">😡</button>
                    <button type="button" onclick="insertDMEmoji('😍')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">😍</button>
                    <button type="button" onclick="insertDMEmoji('😂')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">😂</button>
                    <button type="button" onclick="insertDMEmoji('🤔')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">🤔</button>
                    <button type="button" onclick="insertDMEmoji('👍')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">👍</button>
                    <button type="button" onclick="insertDMEmoji('👎')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">👎</button>
                    <button type="button" onclick="insertDMEmoji('❤️')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">❤️</button>
                    <button type="button" onclick="insertDMEmoji('🎉')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">🎉</button>
                    <button type="button" onclick="insertDMEmoji('🔥')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">🔥</button>
                    <button type="button" onclick="insertDMEmoji('💯')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">💯</button>
                  </div>
                </div>
              </div>
              <button onclick="sendDMMessage()" style="
                background: #38bdf8;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 50%;
                cursor: pointer;
                transition: background-color 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
              " onmouseover="this.style.backgroundColor='#5a67d8'" onmouseout="this.style.backgroundColor='#38bdf8'">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Load messages for this conversation
      await loadConversationMessages(conversationId);

      // Close modal saat klik di luar
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeDMModal();
        }
      });

      // Focus ke input
      setTimeout(() => {
        const input = document.getElementById('dmMessageInput');
        if (input) {
          input.focus();
        }
      }, 100);
    }

    // Load messages for a conversation
    async function loadConversationMessages(conversationId) {
      try {
        const messagesContainer = document.getElementById('dmMessages');
        if (!messagesContainer) return;

        // Call the database function to get conversation messages
        const { data: messages, error } = await supabase.rpc('get_conversation_messages', {
          p_conversation_id: conversationId,
          p_user_id: currentUser.id
        });

        if (error) {
          console.error('Error loading messages:', error);
          messagesContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
              <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
              <p>Gagal memuat pesan</p>
              <p style="font-size: 12px; color: #6b7280;">${error.message}</p>
            </div>
          `;
          return;
        }

        if (!messages || messages.length === 0) {
          messagesContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
              <p>Belum ada pesan</p>
              <p style="font-size: 12px;">Mulai percakapan dengan mengirim pesan pertama</p>
            </div>
          `;
          return;
        }

        // Render messages
        messagesContainer.innerHTML = messages.map(message => {
          const isOwnMessage = message.sender_id === currentUser.id;
          const senderAvatar = message.sender_avatar && message.sender_avatar !== 'NULL' 
            ? message.sender_avatar 
            : 'assets/img/profil picture/default-avatar.jpg';
          
          return `
            <div class="message ${isOwnMessage ? 'sent' : 'received'}" style="
              margin-bottom: 16px;
              display: flex;
              gap: 8px;
              ${isOwnMessage ? 'justify-content: flex-end;' : ''}
            ">
              ${!isOwnMessage ? `
                <img src="${senderAvatar}" alt="${message.sender_name}" style="
                  width: 32px;
                  height: 32px;
                  border-radius: 50%;
                  object-fit: cover;
                " onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
              ` : ''}
              <div style="display: flex; flex-direction: column; max-width: 70%;">
                ${!isOwnMessage && message.sender_name ? `
                  <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px; padding-left: 4px;">
                    <span style="font-size: 12px; font-weight: 600; color: #374151;">${message.sender_name}</span>
                    ${message.is_verified === true ? `
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                        <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    ` : ''}
                  </div>
                ` : ''}
                <div data-message-id="${message.message_id}" style="
                  background: ${isOwnMessage ? '#38bdf8' : 'white'};
                  color: ${isOwnMessage ? 'white' : '#374151'};
                  padding: 12px 16px;
                  border-radius: 18px;
                  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                  position: relative;
                  cursor: pointer;
                " oncontextmenu="showMessageContextMenu(event, this); return false;">
                  <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    ${message.content}
                  </p>
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px;">
                  <span style="font-size: 11px; color: ${isOwnMessage ? 'rgba(255,255,255,0.7)' : '#9ca3af'};">
                    ${new Date(message.created_at).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}
                  </span>
                  ${isOwnMessage ? `
                    <span style="font-size: 10px; color: rgba(255,255,255,0.5);">
                      ${message.is_read ? '✓✓' : '✓'}
                    </span>
                  ` : ''}
                </div>
              </div>
              </div>
              ${isOwnMessage ? `
                <img src="${senderAvatar}" alt="${message.sender_name}" style="
                  width: 32px;
                  height: 32px;
                  border-radius: 50%;
                  object-fit: cover;
                " onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
              ` : ''}
            </div>
          `;
        }).join('');

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Error in loadConversationMessages:', error);
      }
    }

    // Start new conversation
    async function startNewConversation() {
      const recipientId = prompt('Masukkan User ID penerima:');
      if (!recipientId) return;
      
      try {
        if (recipientId === currentUser.id) {
          showNotification('Anda tidak bisa mengirim pesan ke diri sendiri!', 'error');
          return;
        }

        // Get recipient profile first to verify user exists
        const recipientProfile = await getUserProfile(recipientId);
        if (!recipientProfile || !recipientProfile.full_name) {
          showNotification('User tidak ditemukan!', 'error');
          return;
        }
        
        // Get or create conversation
        const { data: conversationId, error } = await supabase.rpc('get_or_create_conversation', {
          p_user1_id: currentUser.id,
          p_user2_id: recipientId
        });
        
        if (error) {
          console.error('Error creating conversation:', error);
          showNotification('Gagal membuat percakapan: ' + error.message, 'error');
          return;
        }
        
        // Open conversation with actual profile data
        await openConversation(
          conversationId, 
          recipientId, 
          recipientProfile.full_name || recipientProfile.name || 'User', 
          recipientProfile.profile_image || 'assets/img/profil picture/default-avatar.jpg'
        );
        
      } catch (error) {
        console.error('Error in startNewConversation:', error);
        showNotification('Gagal membuat percakapan!', 'error');
      }
    }

    // Setup real-time channel for conversation
    function setupRealtimeChannel(conversationId, otherUserId) {
      console.log('Setting up realtime channel for conversation:', conversationId);
      
      // Create channel for this conversation
      realtimeChannel = supabase
        .channel(`conversation-${conversationId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `conversation_id=eq.${conversationId}`
        }, (payload) => {
          console.log('New message received:', payload);
          handleNewMessage(payload.new);
        })
        .on('broadcast', { event: 'typing' }, (payload) => {
          console.log('Typing event received:', payload);
          handleTypingEvent(payload);
        })
        .subscribe();

      console.log('Realtime channel subscribed:', realtimeChannel);
    }

    // Handle new message from real-time
    function handleNewMessage(message) {
      // Don't show our own messages (they're already shown)
      if (message.sender_id === currentUser.id) {
        return;
      }

      // Play notification sound
      playMessageSound();

      // Add message to UI
      addMessageToUI(message);

      // Show notification if not focused on conversation
      if (document.hidden || !document.querySelector('.dm-modal')) {
        showMessageNotification(message);
      }
    }

    // Add message to UI
    function addMessageToUI(message) {
      const messagesContainer = document.getElementById('dmMessages');
      if (!messagesContainer) return;

      // Get sender profile
      getUserProfile(message.sender_id).then(senderProfile => {
        const senderAvatar = senderProfile.profile_image && senderProfile.profile_image !== 'NULL' 
          ? senderProfile.profile_image 
          : 'assets/img/profil picture/default-avatar.jpg';
        
        const messageElement = document.createElement('div');
        messageElement.className = 'message received';
        messageElement.style.cssText = `
          margin-bottom: 16px;
          display: flex;
          gap: 8px;
        `;
        
        messageElement.innerHTML = `
          <img src="${senderAvatar}" alt="${senderProfile.full_name}" style="
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
          " onerror="this.src='assets/img/profil picture/default-avatar.jpg'">
          <div style="display: flex; flex-direction: column; max-width: 70%;">
            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px; padding-left: 4px;">
              <span style="font-size: 12px; font-weight: 600; color: #374151;">${senderProfile.full_name || senderProfile.name || 'User'}</span>
              ${senderProfile.is_verified === true ? `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                  <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              ` : ''}
            </div>
            <div data-message-id="${message.id}" style="
              background: white;
              color: #374151;
              padding: 12px 16px;
              border-radius: 18px;
              box-shadow: 0 1px 2px rgba(0,0,0,0.1);
              position: relative;
              cursor: pointer;
            " oncontextmenu="showMessageContextMenu(event, this); return false;">
              <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                ${message.content}
              </p>
            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px;">
              <span style="font-size: 11px; color: #9ca3af;">
                ${new Date(message.created_at).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}
              </span>
            </div>
          </div>
          </div>
        `;

        messagesContainer.appendChild(messageElement);
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Handle typing events
    function handleTypingEvent(payload) {
      if (payload.user_id === currentUser.id) return; // Ignore our own typing

      const typingIndicator = document.getElementById('typingIndicator');
      if (!typingIndicator) return;

      if (payload.is_typing) {
        otherUserTyping = true;
        typingIndicator.style.display = 'block';
        typingIndicator.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; color: #6b7280; font-size: 12px;">
            <div style="display: flex; gap: 2px;">
              <div style="width: 4px; height: 4px; background: #6b7280; border-radius: 50%; animation: typing 1.4s infinite;"></div>
              <div style="width: 4px; height: 4px; background: #6b7280; border-radius: 50%; animation: typing 1.4s infinite 0.2s;"></div>
              <div style="width: 4px; height: 4px; background: #6b7280; border-radius: 50%; animation: typing 1.4s infinite 0.4s;"></div>
            </div>
            <span>${window.currentConversation.otherUserName} sedang mengetik...</span>
          </div>
        `;
      } else {
        otherUserTyping = false;
        typingIndicator.style.display = 'none';
      }
    }

    // Send typing indicator
    function sendTypingIndicator(isTyping) {
      if (!realtimeChannel || !window.currentConversation) return;
      
      realtimeChannel.send({
        type: 'broadcast',
        event: 'typing',
        payload: {
          user_id: currentUser.id,
          is_typing: isTyping
        }
      });
    }

    // Play message sound
    function playMessageSound() {
      try {
        // Create audio context for notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (error) {
        console.log('Could not play notification sound:', error);
      }
    }

    // Show message notification
    function showMessageNotification(message) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Pesan Baru', {
          body: `${window.currentConversation.otherUserName}: ${message.content}`,
          icon: window.currentConversation.otherUserAvatar
        });
      }
    }

    // Close DM Modal
    function closeDMModal() {
      // Cleanup realtime channel
      if (realtimeChannel) {
        supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
      
      const modal = document.querySelector('.dm-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-in';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
          }
        }, 300);
      }
    }

    // =============================
    // NOTIFICATION SYSTEM
    // =============================

    // Setup notification system
    async function setupNotificationSystem() {
      if (!currentUser) return;
      
      console.log('Setting up notification system...');
      
      try {
        // Load existing notifications
        await loadNotifications();
        
        // Setup real-time notification channel
        setupNotificationChannel();
        
        // Update notification badge
        updateNotificationBadge();
        
        // Update notification button visibility
        updateNotificationButtonVisibility();
        
        // Create notification dropdown if on own profile
        if (isViewingOwnProfile()) {
          createNotificationDropdown();
        }
        
        // Setup auto-refresh for notifications every 30 seconds
        setupNotificationAutoRefresh();
        
        console.log('Notification system setup completed successfully');
      } catch (error) {
        console.error('Error setting up notification system:', error);
        // Don't show error to user, just log it
      }
    }

    // Setup auto-refresh for notifications
    function setupNotificationAutoRefresh() {
      // Clear existing interval if any
      if (window.notificationRefreshInterval) {
        clearInterval(window.notificationRefreshInterval);
      }
      
      // Set up new interval to refresh notifications every 30 seconds
      window.notificationRefreshInterval = setInterval(async () => {
        if (currentUser) {
          try {
            await loadNotifications();
            updateNotificationBadge();
          } catch (error) {
            console.error('Error in auto-refresh notifications:', error);
          }
        }
      }, 30000); // 30 seconds
      
      console.log('Notification auto-refresh setup completed');
    }

    // Setup real-time notification channel
    function setupNotificationChannel() {
      if (!currentUser) return;
      
      console.log('Setting up notification channel...');
      
      notificationChannel = supabase
        .channel(`notifications-${currentUser.id}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${currentUser.id}`
        }, (payload) => {
          console.log('New notification received:', payload);
          handleNewNotification(payload.new);
        })
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${currentUser.id}`
        }, (payload) => {
          console.log('Notification updated:', payload);
          handleNotificationUpdate(payload.new);
        })
        .on('postgres_changes', {
          event: 'DELETE',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${currentUser.id}`
        }, (payload) => {
          console.log('Notification deleted:', payload);
          handleNotificationDelete(payload.old);
        })
        .subscribe();
    }

    // Load notifications from database
    async function loadNotifications() {
      if (!currentUser) return;
      
      try {
        console.log('Loading notifications for user:', currentUser.id);
        
        const { data: notificationData, error } = await supabase
          .from('notifications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) {
          console.error('Error loading notifications:', error);
          // If table doesn't exist, create empty array
          if (error.code === 'PGRST116' || error.message.includes('relation "notifications" does not exist')) {
            console.log('Notifications table does not exist yet. Please run the SQL script first.');
            notifications = [];
            unreadNotificationCount = 0;
            return;
          }
          return;
        }

        notifications = notificationData || [];
        unreadNotificationCount = notifications.filter(n => !n.is_read).length;
        
        console.log('Loaded notifications:', notifications.length, 'Unread:', unreadNotificationCount);
      } catch (error) {
        console.error('Error in loadNotifications:', error);
        // Fallback to empty array
        notifications = [];
        unreadNotificationCount = 0;
      }
    }

    // Handle new notification
    function handleNewNotification(notification) {
      // Add to notifications array
      notifications.unshift(notification);
      
      // Update unread count
      if (!notification.is_read) {
        unreadNotificationCount++;
      }
      
      // Update UI
      updateNotificationBadge();
      
      // Show notification popup
      showNotificationPopup(notification);
      
      // Play notification sound
      playNotificationSound();
    }

    // Handle notification update
    function handleNotificationUpdate(updatedNotification) {
      // Find and update the notification in local array
      const index = notifications.findIndex(n => n.id === updatedNotification.id);
      if (index !== -1) {
        const oldNotification = notifications[index];
        notifications[index] = updatedNotification;
        
        // Update unread count based on read status change
        if (oldNotification.is_read !== updatedNotification.is_read) {
          if (updatedNotification.is_read) {
            unreadNotificationCount = Math.max(0, unreadNotificationCount - 1);
          } else {
            unreadNotificationCount++;
          }
        }
        
        // Update UI immediately
        updateNotificationBadge();
        
        // Refresh dropdown if it's open
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown && dropdown.style.display === 'block') {
          loadNotificationDropdown();
        }
      }
    }

    // Handle notification delete
    function handleNotificationDelete(deletedNotification) {
      // Remove from notifications array
      const index = notifications.findIndex(n => n.id === deletedNotification.id);
      if (index !== -1) {
        const notification = notifications[index];
        notifications.splice(index, 1);
        
        // Update unread count if it was unread
        if (!notification.is_read) {
          unreadNotificationCount = Math.max(0, unreadNotificationCount - 1);
        }
        
        // Update UI immediately
        updateNotificationBadge();
        
        // Refresh dropdown if it's open
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown && dropdown.style.display === 'block') {
          loadNotificationDropdown();
        }
      }
    }

    // Update notification badge
    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;
      
      // Only show notification badge on own profile
      if (!isViewingOwnProfile()) {
        badge.style.display = 'none';
        return;
      }
      
      if (unreadNotificationCount > 0) {
        badge.textContent = unreadNotificationCount > 99 ? '99+' : unreadNotificationCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
      
      // Update notification count in dropdown header - show unread count, not total
      const notificationCount = document.getElementById('notificationCount');
      if (notificationCount) {
        notificationCount.textContent = unreadNotificationCount;
        notificationCount.style.background = unreadNotificationCount > 0 ? '#ef4444' : '#38bdf8';
      }
    }

    // Check if viewing own profile
    function isViewingOwnProfile() {
      const urlParams = new URLSearchParams(window.location.search);
      const viewingUserId = urlParams.get('user');
      const currentUserId = currentUser ? currentUser.id : null;
      return !viewingUserId || viewingUserId === currentUserId;
    }

    // Update notification button visibility
    function updateNotificationButtonVisibility() {
      const notificationButton = document.getElementById('notificationButton');
      if (!notificationButton) return;
      
      if (isViewingOwnProfile()) {
        notificationButton.style.display = 'flex';
      } else {
        notificationButton.style.display = 'none';
      }
    }

    // Toggle notification dropdown
    async function toggleNotificationDropdown() {
      // Only show notifications on own profile
      if (!isViewingOwnProfile()) {
        return;
      }

      let dropdown = document.getElementById('notificationDropdown');
      if (!dropdown) {
        createNotificationDropdown();
        dropdown = document.getElementById('notificationDropdown');
        if (!dropdown) return; // Safety check
      }
      
      if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        dropdown.style.display = 'block';
        // Refresh notifications when opening dropdown
        await loadNotifications();
        await loadNotificationDropdown();
      } else {
        dropdown.style.display = 'none';
      }
    }

    // Create notification dropdown
    function createNotificationDropdown() {
      const dropdown = document.createElement('div');
      dropdown.id = 'notificationDropdown';
      dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        right: 0;
        width: 350px;
        max-height: 400px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
        overflow: hidden;
      `;
      
      dropdown.innerHTML = `
        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #1f2937;">Notifikasi</h3>
            <span id="notificationCount" style="background: #38bdf8; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px; font-weight: 600;">${unreadNotificationCount}</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: #38bdf8; cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">Tandai Semua Dibaca</button>
          </div>
        </div>
        <div id="notificationList" style="max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">🔔</div>
            <p>Memuat notifikasi...</p>
          </div>
        </div>
      `;
      
      // Add to notification button
      const notificationButton = document.getElementById('notificationButton');
      if (notificationButton) {
        notificationButton.style.position = 'relative';
        notificationButton.appendChild(dropdown);
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!notificationButton.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
    }

    // Load notification dropdown content
    async function loadNotificationDropdown() {
      const notificationList = document.getElementById('notificationList');
      if (!notificationList) return;
      
      // Show loading state
      notificationList.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #6b7280;">
          <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
          <p>Memuat notifikasi...</p>
        </div>
      `;
      
      // Load notifications immediately without artificial delay
      if (notifications.length === 0) {
        notificationList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">🔔</div>
            <p>Belum ada notifikasi</p>
            <p style="font-size: 12px;">Anda akan menerima notifikasi untuk DM, komentar, dan balasan</p>
          </div>
        `;
        return;
      }
      
      // Sort notifications by created_at (newest first)
      const sortedNotifications = [...notifications].sort((a, b) => 
        new Date(b.created_at) - new Date(a.created_at)
      );
      
      notificationList.innerHTML = sortedNotifications.map((notification, index) => {
        const timeAgo = getTimeAgo(new Date(notification.created_at));
        const isUnread = !notification.is_read;
        const isNew = index < 3; // Mark first 3 as "new"
        
        return `
          <div class="notification-item" onclick="handleNotificationClick('${notification.id}')" style="
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.3s ease;
            ${isUnread ? 'background: #eff6ff; border-left: 3px solid #38bdf8;' : 'background: white;'}
            animation: ${isNew ? 'slideInRight 0.5s ease-out' : 'none'};
            animation-delay: ${index * 0.1}s;
            animation-fill-mode: both;
          " onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='${isUnread ? '#eff6ff' : 'white'}'">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              ${isNew ? '<div style="position: absolute; top: 8px; left: 8px; width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>' : ''}
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <p style="margin: 0; font-size: 14px; line-height: 1.4; color: #1f2937; font-weight: ${isUnread ? '600' : '400'}; flex: 1;">
                    ${notification.message}
                  </p>
                  ${isNew ? '<span style="background: #10b981; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 600;">BARU</span>' : ''}
                </div>
                <p style="margin: 0; font-size: 12px; color: #6b7280;">
                  ${timeAgo}
                </p>
              </div>
              ${isUnread ? '<div style="width: 8px; height: 8px; background: #38bdf8; border-radius: 50%; flex-shrink: 0; margin-top: 4px;"></div>' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Get notification icon based on type
    function getNotificationIcon(type) {
      switch (type) {
        case 'dm': return '#38bdf8';
        case 'comment': return '#10b981';
        case 'reply': return '#f59e0b';
        case 'like': return '#ef4444';
        case 'follow': return '#8b5cf6';
        case 'repost': return '#06b6d4';
        case 'test': return '#84cc16';
        default: return '#6b7280';
      }
    }


    // Handle notification click
    async function handleNotificationClick(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (!notification) return;
      
      // Mark as read
      await markNotificationAsRead(notificationId);
      
      // Handle notification action based on type
      switch (notification.type) {
        case 'dm':
          // Open DM with the sender
          if (notification.related_user_id) {
            window.location.href = `profile-desktop.html?user=${notification.related_user_id}&action=dm`;
          }
          break;
          
        case 'comment':
        case 'reply':
          // Navigate to the post in timeline
          if (notification.related_post_id) {
            window.location.href = `timeline-desktop.html?highlight=${notification.related_post_id}`;
          } else {
            // Fallback to timeline if no post ID
            window.location.href = 'timeline-desktop.html';
          }
          break;
          
        case 'like':
          // Navigate to the post in timeline
          if (notification.related_post_id) {
            window.location.href = `timeline-desktop.html?highlight=${notification.related_post_id}`;
          } else {
            // Fallback to timeline if no post ID
            window.location.href = 'timeline-desktop.html';
          }
          break;
          
        case 'repost':
          // Navigate to the original post
          if (notification.related_post_id) {
            window.location.href = `timeline-desktop.html?highlight=${notification.related_post_id}`;
          } else {
            // Fallback to timeline if no post ID
            window.location.href = 'timeline-desktop.html';
          }
          break;
          
        case 'follow':
          // Navigate to the follower's profile
          if (notification.related_user_id) {
            window.location.href = `profile-desktop.html?user=${notification.related_user_id}`;
          }
          break;
          
        case 'test':
          // For test notifications, just close dropdown
          break;
          
        default:
          // Default action - go to timeline
          window.location.href = 'timeline-desktop.html';
          break;
      }
      
      // Close dropdown
      const dropdown = document.getElementById('notificationDropdown');
      if (dropdown) {
        dropdown.style.display = 'none';
      }
      
      console.log(`Notification clicked: ${notification.type} - navigating to relevant content`);
    }

    // Mark notification as read
    async function markNotificationAsRead(notificationId) {
      try {
        const { error } = await supabase
          .from('notifications')
          .update({ is_read: true, read_at: new Date().toISOString() })
          .eq('id', notificationId);

        if (error) {
          console.error('Error marking notification as read:', error);
          return;
        }

        // Local data will be updated automatically via realtime listener
        // No need to manually update here as handleNotificationUpdate will handle it
        console.log('Notification marked as read:', notificationId);
      } catch (error) {
        console.error('Error in markNotificationAsRead:', error);
      }
    }

    // Mark all notifications as read
    async function markAllNotificationsRead() {
      try {
        // Mark all unread notifications as read instead of deleting them
        const { error } = await supabase
          .from('notifications')
          .update({ 
            is_read: true, 
            read_at: new Date().toISOString() 
          })
          .eq('user_id', currentUser.id)
          .eq('is_read', false);

        if (error) {
          console.error('Error marking notifications as read:', error);
          return;
        }

        // Manually update local data to ensure counter is updated immediately
        notifications.forEach(notification => {
          if (!notification.is_read) {
            notification.is_read = true;
            notification.read_at = new Date().toISOString();
          }
        });
        
        // Reset unread count to 0
        unreadNotificationCount = 0;
        
        // Update UI immediately
        updateNotificationBadge();
        
        // Refresh dropdown if it's open
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown && dropdown.style.display === 'block') {
          loadNotificationDropdown();
        }
        
        showNotification('Semua notifikasi ditandai sebagai dibaca', 'success');
        console.log('All notifications marked as read successfully');
      } catch (error) {
        console.error('Error in markAllNotificationsRead:', error);
      }
    }

    // Show notification popup
    function showNotificationPopup(notification) {
      // Create popup element
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 320px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        z-index: 2000;
        animation: slideInRight 0.5s ease-out;
        border-left: 4px solid ${getNotificationIcon(notification.type)};
      `;
      
      popup.innerHTML = `
        <div style="padding: 16px; display: flex; align-items: flex-start; gap: 12px;">
          <div style="
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
          "></div>
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <p style="margin: 0; font-size: 14px; line-height: 1.4; color: #1f2937; font-weight: 600; flex: 1;">
                ${notification.message}
              </p>
              <span style="background: #10b981; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 600;">BARU</span>
            </div>
            <p style="margin: 0; font-size: 12px; color: #6b7280;">
              Baru saja
            </p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
          " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">&times;</button>
        </div>
      `;
      
      document.body.appendChild(popup);
      
      // Auto remove after 6 seconds
      setTimeout(() => {
        if (popup.parentNode) {
          popup.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => {
            if (popup.parentNode) {
              popup.remove();
            }
          }, 300);
        }
      }, 6000);
    }

    // Play notification sound
    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Could not play notification sound:', error);
      }
    }

    // Get time ago string
    function getTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'Baru saja';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m yang lalu`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}j yang lalu`;
      if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}h yang lalu`;
      return date.toLocaleDateString('id-ID');
    }

    // =============================
    // NOTIFICATION CREATION FUNCTIONS
    // =============================

    // Create like notification
    async function createLikeNotification(postAuthorId, likerId, postId) {
      if (!postAuthorId || !likerId || !postId) return;
      
      try {
        const { data, error } = await supabase.rpc('create_like_notification', {
          p_post_author_id: postAuthorId,
          p_liker_id: likerId,
          p_post_id: postId
        });
        
        if (error) throw error;
        console.log('Like notification created:', data);
        return data;
      } catch (error) {
        console.error('Error creating like notification:', error);
      }
    }

    // Create comment notification
    async function createCommentNotification(postAuthorId, commenterId, postId, commentPreview) {
      if (!postAuthorId || !commenterId || !postId) return;
      
      try {
        const { data, error } = await supabase.rpc('create_comment_notification', {
          p_post_author_id: postAuthorId,
          p_commenter_id: commenterId,
          p_post_id: postId,
          p_comment_preview: commentPreview
        });
        
        if (error) throw error;
        console.log('Comment notification created:', data);
        return data;
      } catch (error) {
        console.error('Error creating comment notification:', error);
      }
    }

    // Create reply notification
    async function createReplyNotification(commentAuthorId, replierId, postId, commentId, replyPreview) {
      if (!commentAuthorId || !replierId || !postId || !commentId) return;
      
      try {
        const { data, error } = await supabase.rpc('create_reply_notification', {
          p_comment_author_id: commentAuthorId,
          p_replier_id: replierId,
          p_post_id: postId,
          p_comment_id: commentId,
          p_reply_preview: replyPreview
        });
        
        if (error) throw error;
        console.log('Reply notification created:', data);
        return data;
      } catch (error) {
        console.error('Error creating reply notification:', error);
      }
    }

    // Create repost notification
    async function createRepostNotification(originalAuthorId, reposterId, postId) {
      if (!originalAuthorId || !reposterId || !postId) return;
      
      try {
        const { data, error } = await supabase.rpc('create_notification', {
          p_user_id: originalAuthorId,
          p_type: 'repost',
          p_message: 'Seseorang merepost postingan Anda',
          p_related_user_id: reposterId,
          p_related_post_id: postId,
          p_related_comment_id: null
        });
        
        if (error) throw error;
        console.log('Repost notification created:', data);
        return data;
      } catch (error) {
        console.error('Error creating repost notification:', error);
      }
    }

    // Create DM notification
    async function createDMNotification(recipientId, messageContent) {
      if (!currentUser || !recipientId) return;
      
      try {
        console.log('Creating DM notification for:', recipientId);
        
        const { data, error } = await supabase.rpc('create_dm_notification', {
          p_recipient_id: recipientId,
          p_sender_id: currentUser.id,
          p_message_preview: messageContent
        });

        if (error) {
          console.error('Error creating DM notification:', error);
          return;
        }

        console.log('DM notification created:', data);
      } catch (error) {
        console.error('Error in createDMNotification:', error);
      }
    }

    // Create comment notification
    async function createCommentNotification(postAuthorId, postId, commentContent) {
      if (!currentUser || !postAuthorId || !postId) return;
      
      try {
        console.log('Creating comment notification for:', postAuthorId);
        
        const { data, error } = await supabase.rpc('create_comment_notification', {
          p_post_author_id: postAuthorId,
          p_commenter_id: currentUser.id,
          p_post_id: postId,
          p_comment_preview: commentContent
        });

        if (error) {
          console.error('Error creating comment notification:', error);
          return;
        }

        console.log('Comment notification created:', data);
      } catch (error) {
        console.error('Error in createCommentNotification:', error);
      }
    }

    // Create reply notification
    async function createReplyNotification(commentAuthorId, postId, commentId, replyContent) {
      if (!currentUser || !commentAuthorId || !postId || !commentId) return;
      
      try {
        console.log('Creating reply notification for:', commentAuthorId);
        
        const { data, error } = await supabase.rpc('create_reply_notification', {
          p_comment_author_id: commentAuthorId,
          p_replier_id: currentUser.id,
          p_post_id: postId,
          p_comment_id: commentId,
          p_reply_preview: replyContent
        });

        if (error) {
          console.error('Error creating reply notification:', error);
          return;
        }

        console.log('Reply notification created:', data);
      } catch (error) {
        console.error('Error in createReplyNotification:', error);
      }
    }

    // Create like notification
    async function createLikeNotification(postAuthorId, postId) {
      if (!currentUser || !postAuthorId || !postId) return;
      
      try {
        console.log('Creating like notification for:', postAuthorId);
        
        const { data, error } = await supabase.rpc('create_like_notification', {
          p_post_author_id: postAuthorId,
          p_liker_id: currentUser.id,
          p_post_id: postId
        });

        if (error) {
          console.error('Error creating like notification:', error);
          return;
        }

        console.log('Like notification created:', data);
      } catch (error) {
        console.error('Error in createLikeNotification:', error);
      }
    }

    // Create follow notification
    async function createFollowNotification(followedUserId) {
      if (!currentUser || !followedUserId) return;
      
      try {
        console.log('Creating follow notification for:', followedUserId);
        
        const { data, error } = await supabase.rpc('create_follow_notification', {
          p_followed_user_id: followedUserId,
          p_follower_id: currentUser.id
        });

        if (error) {
          console.error('Error creating follow notification:', error);
          return;
        }

        console.log('Follow notification created:', data);
      } catch (error) {
        console.error('Error in createFollowNotification:', error);
      }
    }

    // Test notification function (for debugging)
    async function testNotification() {
      if (!currentUser) {
        showNotification('Silakan login terlebih dahulu', 'error');
        return;
      }
      
      try {
        const { data, error } = await supabase.rpc('create_notification', {
          p_user_id: currentUser.id,
          p_type: 'test',
          p_message: 'Notifikasi test berhasil dibuat!',
          p_related_user_id: null,
          p_related_post_id: null,
          p_related_comment_id: null
        });

        if (error) {
          console.error('Error creating test notification:', error);
          showNotification('Error: ' + error.message, 'error');
          return;
        }

        showNotification('Test notification berhasil dibuat!', 'success');
        console.log('Test notification created:', data);
      } catch (error) {
        console.error('Error in testNotification:', error);
        showNotification('Error: ' + error.message, 'error');
      }
    }

    // Handle Enter key press in DM input
    function handleDMKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendDMMessage();
      } else {
        // Send typing indicator
        handleTypingInput();
      }
    }

    // Handle typing input for typing indicator
    function handleTypingInput() {
      if (!isTyping) {
        isTyping = true;
        sendTypingIndicator(true);
      }

      // Clear existing timeout
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }

      // Set timeout to stop typing indicator
      typingTimeout = setTimeout(() => {
        isTyping = false;
        sendTypingIndicator(false);
      }, 1000);
    }

    // Send DM Message
    async function sendDMMessage() {
      const input = document.getElementById('dmMessageInput');
      const message = input.value.trim();
      
      if (!message) {
        showNotification('Silakan tulis pesan terlebih dahulu!', 'error');
        return;
      }

      if (!window.currentConversation) {
        showNotification('Tidak ada percakapan yang aktif!', 'error');
        return;
      }

      // Stop typing indicator
      if (isTyping) {
        isTyping = false;
        sendTypingIndicator(false);
        if (typingTimeout) {
          clearTimeout(typingTimeout);
        }
      }

      try {
        // Send message to database
        const { data: messageId, error } = await supabase.rpc('send_message', {
          p_sender_id: currentUser.id,
          p_recipient_id: window.currentConversation.otherUserId,
          p_content: message
        });

        if (error) {
          console.error('Error sending message:', error);
          showNotification('Gagal mengirim pesan!', 'error');
          return;
        }

        // Clear input
        input.value = '';
        
        // Create DM notification for recipient
        await createDMNotification(window.currentConversation.otherUserId, message);
        
        // Reload messages to show the new message
        await loadConversationMessages(window.currentConversation.id);
        
        showNotification('Pesan berhasil dikirim! 💬', 'success');
      } catch (error) {
        console.error('Error in sendDMMessage:', error);
        showNotification('Gagal mengirim pesan!', 'error');
      }
    }


    // DM Emoji Picker Functions
    function toggleDMEmojiPicker() {
      const emojiPicker = document.getElementById('dmEmojiPicker');
      if (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') {
        emojiPicker.style.display = 'block';
      } else {
        emojiPicker.style.display = 'none';
      }
    }

    function insertDMEmoji(emoji) {
      const input = document.getElementById('dmMessageInput');
      const currentPos = input.selectionStart;
      const textBefore = input.value.substring(0, currentPos);
      const textAfter = input.value.substring(currentPos);
      
      input.value = textBefore + emoji + textAfter;
      input.focus();
      input.setSelectionRange(currentPos + emoji.length, currentPos + emoji.length);
      
      // Hide emoji picker after selection
      document.getElementById('dmEmojiPicker').style.display = 'none';
    }

    // Show message context menu
    function showMessageContextMenu(event, messageElement) {
      event.preventDefault();
      
      // Remove existing context menu
      const existingMenu = document.querySelector('.message-context-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      // Create context menu
      const contextMenu = document.createElement('div');
      contextMenu.className = 'message-context-menu';
      contextMenu.style.cssText = `
        position: fixed;
        top: ${event.clientY}px;
        left: ${event.clientX}px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        z-index: 3000;
        min-width: 120px;
      `;
      
      contextMenu.innerHTML = `
        <button onclick="deleteMessage('${messageElement.dataset.messageId || ''}')" style="
          width: 100%;
          padding: 8px 12px;
          border: none;
          background: none;
          text-align: left;
          cursor: pointer;
          font-size: 14px;
          color: #ef4444;
          border-radius: 8px;
        " onmouseover="this.style.backgroundColor='#fef2f2'" onmouseout="this.style.backgroundColor='transparent'">
          🗑️ Hapus Pesan
        </button>
      `;
      
      document.body.appendChild(contextMenu);
      
      // Close context menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', () => {
          contextMenu.remove();
        }, { once: true });
      }, 100);
    }
    
    // Delete message function
    async function deleteMessage(messageId) {
      if (!messageId) return;
      
      try {
        const { error } = await supabase
          .from('messages')
          .delete()
          .eq('id', messageId)
          .eq('sender_id', currentUser.id);
        
        if (error) {
          console.error('Error deleting message:', error);
          showNotification('Gagal menghapus pesan!', 'error');
          return;
        }
        
        showNotification('Pesan berhasil dihapus!', 'success');
        
        // Reload messages
        if (window.currentConversation) {
          await loadConversationMessages(window.currentConversation.id);
        }
        
      } catch (error) {
        console.error('Error in deleteMessage:', error);
        showNotification('Gagal menghapus pesan!', 'error');
      }
    }

    // Close DM emoji picker when clicking outside
    document.addEventListener('click', function(event) {
      const emojiPicker = document.getElementById('dmEmojiPicker');
      const emojiBtn = document.querySelector('[onclick="toggleDMEmojiPicker()"]');
      
      if (emojiPicker && emojiPicker.style.display === 'block') {
        if (!emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
          emojiPicker.style.display = 'none';
        }
      }
    });

    // Message Context Menu Functions
    function showMessageContextMenu(event, messageElement) {
      event.preventDefault();
      
      // Remove existing context menu
      const existingMenu = document.querySelector('.message-context-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      // Create context menu
      const contextMenu = document.createElement('div');
      contextMenu.className = 'message-context-menu';
      contextMenu.style.cssText = `
        position: fixed;
        top: ${event.clientY}px;
        left: ${event.clientX}px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        z-index: 10000;
        padding: 8px 0;
        min-width: 120px;
      `;
      
      contextMenu.innerHTML = `
        <button onclick="deleteMessage(this)" style="
          width: 100%;
          padding: 8px 16px;
          background: none;
          border: none;
          text-align: left;
          cursor: pointer;
          color: #ef4444;
          font-size: 14px;
          transition: background-color 0.2s;
        " onmouseover="this.style.backgroundColor='#fef2f2'" onmouseout="this.style.backgroundColor='transparent'">
          🗑️ Hapus Pesan
        </button>
      `;
      
      document.body.appendChild(contextMenu);
      
      // Close context menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeContextMenu() {
          contextMenu.remove();
          document.removeEventListener('click', closeContextMenu);
        });
      }, 100);
    }

    function deleteMessage(button) {
      const contextMenu = button.closest('.message-context-menu');
      const messageElement = document.querySelector('[oncontextmenu*="showMessageContextMenu"]');
      
      if (messageElement && confirm('Apakah Anda yakin ingin menghapus pesan ini?')) {
        messageElement.closest('.message').style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          messageElement.closest('.message').remove();
        }, 300);
        
        showNotification('Pesan berhasil dihapus! 🗑️', 'success');
      }
      
      contextMenu.remove();
    }

    // Share Profile Function
    function shareProfile() {
      if (navigator.share) {
        navigator.share({
          title: 'Profil Dr. Dika - SpeakUp!',
          text: 'Lihat profil Dr. Dika di SpeakUp! - Dokter yang peduli dengan kesehatan mental dan kesejahteraan masyarakat.',
          url: window.location.href
        });
      } else {
        // Fallback untuk browser yang tidak support Web Share API
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          showNotification('Link profil berhasil disalin ke clipboard! 📋', 'success');
        }).catch(() => {
          showNotification('Link profil: ' + url, 'info');
        });
      }
    }

    // Report User Function
    function reportUser() {
      // Hapus modal lama jika ada
      const existingModal = document.querySelector('.report-modal');
      if (existingModal) {
        existingModal.remove();
      }

      // Buat modal laporan
      const modal = document.createElement('div');
      modal.className = 'report-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      `;

      modal.innerHTML = `
        <div class="report-modal-content" style="
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 500px;
          max-height: 80vh;
          overflow: hidden;
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
          animation: slideUp 0.3s ease-out;
        ">
          <div class="report-header" style="
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">Laporkan Pengguna</h3>
            <button onclick="closeReportModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #6b7280;
              padding: 4px;
              border-radius: 4px;
            ">&times;</button>
          </div>
          
          <div class="report-content" style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
              <img src="assets/img/profil picture/Dika - Dokter.jpg" alt="Dr. Dika" style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
              ">
              <div>
                <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #1f2937;">Dr. Dika</h4>
                <p style="margin: 0; font-size: 14px; color: #6b7280;">@dika_doctor</p>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Alasan Pelaporan:</label>
              <select id="reportReason" style="
                width: 100%;
                padding: 12px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                font-size: 14px;
                background: white;
                outline: none;
              ">
                <option value="">Pilih alasan pelaporan...</option>
                <option value="spam">Spam atau konten berulang</option>
                <option value="harassment">Pelecehan atau intimidasi</option>
                <option value="hate_speech">Ujaran kebencian</option>
                <option value="fake_info">Informasi palsu</option>
                <option value="inappropriate">Konten tidak pantas</option>
                <option value="other">Lainnya</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Detail Tambahan (Opsional):</label>
              <textarea id="reportDetails" placeholder="Jelaskan lebih detail tentang pelaporan Anda..." style="
                width: 100%;
                min-height: 100px;
                padding: 12px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                font-size: 14px;
                font-family: inherit;
                resize: vertical;
                outline: none;
              "></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeReportModal()" style="
                background: #f3f4f6;
                color: #374151;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
                Batal
              </button>
              <button onclick="submitReport()" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
                Laporkan
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close modal saat klik di luar
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeReportModal();
        }
      });
    }

    // Close Report Modal
    function closeReportModal() {
      const modal = document.querySelector('.report-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-in';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
          }
        }, 300);
      }
    }

    // Submit Report
    function submitReport() {
      const reason = document.getElementById('reportReason').value;
      const details = document.getElementById('reportDetails').value.trim();
      
      if (!reason) {
        showNotification('Silakan pilih alasan pelaporan!', 'error');
        return;
      }

      // Simulasi pengiriman laporan
      showNotification('Laporan berhasil dikirim! Tim moderasi akan meninjau laporan ini. 🚨', 'success');
      closeReportModal();
    }

    // Notification System
    function showNotification(message, type = 'info') {
      // Unified toast style (bottom-center), consistent across all pages
      const hostId = 'su-toast-host';
      let host = document.getElementById(hostId);
      if (!host) {
        host = document.createElement('div');
        host.id = hostId;
        host.style.cssText = `
          position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
          display: flex; flex-direction: column; gap: 8px; align-items: center;
          z-index: 10000; pointer-events: none;`;
        document.body.appendChild(host);
      }

      const toast = document.createElement('div');
      toast.style.cssText = `
        background: #111827; color: #ffffff !important; border-radius: 9999px;
        padding: 10px 14px; font-size: 13px; font-weight: 500;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.08);
        opacity: 0; transform: translateY(8px); transition: all .25s ease;
        pointer-events: auto; white-space: nowrap; max-width: 90vw; overflow: hidden; text-overflow: ellipsis;`;

      // Accent dot
      const dot = document.createElement('span');
      dot.style.cssText = 'display:inline-block;width:8px;height:8px;border-radius:9999px;margin-right:8px;vertical-align:middle;';
      if (type === 'success') dot.style.background = '#10b981';
      else if (type === 'error') dot.style.background = '#ef4444';
      else if (type === 'warning') dot.style.background = '#f59e0b';
      else dot.style.background = '#60a5fa';

      const text = document.createElement('span');
      text.textContent = message;

      toast.appendChild(dot);
      toast.appendChild(text);
      host.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      });

      // Auto remove
      const lifetimeMs = 2400;
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(8px)';
        setTimeout(() => {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 250);
      }, lifetimeMs);
    }

    // CSS untuk animasi
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Typing indicator animation */
      .typing-dots {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .typing-dots span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #9ca3af;
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
    // Emoji Picker Functions
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      if (emojiPicker.style.display === 'none') {
        emojiPicker.style.display = 'block';
      } else {
        emojiPicker.style.display = 'none';
      }
    }

    function insertEmoji(emoji) {
      const textarea = document.getElementById('contentText');
      if (textarea) {
        const currentPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, currentPos);
        const textAfter = textarea.value.substring(textarea.selectionEnd);
        
        textarea.value = textBefore + emoji + textAfter;
        textarea.focus();
        textarea.setSelectionRange(currentPos + emoji.length, currentPos + emoji.length);
        
        // Hide emoji picker after selection
        document.getElementById('emojiPicker').style.display = 'none';
      }
    }

    function removeMedia() {
      document.getElementById('mediaUpload').value = '';
      document.getElementById('mediaPreview').style.display = 'none';
      document.getElementById('previewImg').style.display = 'none';
      document.getElementById('previewVideo').style.display = 'none';
    }

    // Edit Profile Functions
    async function editProfile() {
      try {
        // Ensure profile data is loaded before redirecting
        if (!userProfile) {
          console.log('Profile data not loaded, loading now...');
          await loadUserProfile();
        }
        
        // Store current profile data in localStorage for edit page
        if (userProfile) {
          localStorage.setItem('speakup_edit_profile_data', JSON.stringify(userProfile));
          console.log('Profile data stored for edit page:', userProfile);
        }
        
        // Redirect to edit page
        window.location.href = './edit-profile-desktop.html';
      } catch (error) {
        console.error('Error preparing edit profile:', error);
        showNotification('Gagal memuat data profil untuk edit', 'error');
      }
    }

    // User Follow System Functions
    async function toggleUserFollow() {
      try {
        // Check if user is viewing their own profile
        const viewingUserId = localStorage.getItem('speakup_viewing_user_id');
        const currentUserId = currentUser ? currentUser.id : null;
        
        if (!currentUserId) {
          showNotification('Silakan login terlebih dahulu!', 'error');
          return;
        }
        
        if (viewingUserId === currentUserId) {
          showNotification('Anda tidak bisa follow diri sendiri!', 'error');
          return;
        }
        
        const targetUserId = viewingUserId || currentUserId;
        
        // Try to use database function first, fallback to manual approach
        try {
          const { data, error } = await supabase.rpc('toggle_follow', {
            target_user_id: targetUserId
          });
          
          if (error) {
            console.warn('Database function not available, using manual approach:', error);
            await toggleFollowManual(targetUserId);
            return;
          }
          
          if (data.success) {
            // Update button state
            updateFollowButtonState(data.is_following);
            
            // Update stats
            await loadUserStats(targetUserId);
            
            // Show notification
            const action = data.action === 'followed' ? 'mengikuti' : 'berhenti mengikuti';
            showNotification(`Anda ${action} user ini!`, 'success');
          } else {
            showNotification(data.error || 'Terjadi kesalahan!', 'error');
          }
          
        } catch (rpcError) {
          console.warn('RPC function failed, using manual approach:', rpcError);
          await toggleFollowManual(targetUserId);
        }
        
      } catch (error) {
        console.error('Error in toggleUserFollow:', error);
        showNotification('Terjadi kesalahan saat follow/unfollow!', 'error');
      }
    }
    
    // Manual follow/unfollow implementation (fallback)
    async function toggleFollowManual(targetUserId) {
      try {
        const currentUserId = currentUser.id;
        
        // Check if currently following
        const { data: existingFollow, error: checkError } = await supabase
          .from('user_follows')
          .select('id')
          .eq('follower_id', currentUserId)
          .eq('following_id', targetUserId)
          .single();
        
        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking follow status:', checkError);
          showNotification('Terjadi kesalahan saat cek status follow!', 'error');
          return;
        }
        
        const isCurrentlyFollowing = !!existingFollow;
        
        if (isCurrentlyFollowing) {
          // Unfollow
          const { error: deleteError } = await supabase
            .from('user_follows')
            .delete()
            .eq('follower_id', currentUserId)
            .eq('following_id', targetUserId);
          
          if (deleteError) {
            console.error('Error unfollowing:', deleteError);
            showNotification('Gagal unfollow user!', 'error');
            return;
          }
          
          updateFollowButtonState(false);
          showNotification('Anda berhenti mengikuti user ini!', 'success');
        } else {
          // Follow
          const { error: insertError } = await supabase
            .from('user_follows')
            .insert({
              follower_id: currentUserId,
              following_id: targetUserId
            });
          
          if (insertError) {
            console.error('Error following:', insertError);
            showNotification('Gagal follow user!', 'error');
            return;
          }
          
          updateFollowButtonState(true);
          showNotification('Anda mengikuti user ini!', 'success');
        }
        
        // Update stats
        await loadUserStats(targetUserId);
        
      } catch (error) {
        console.error('Error in toggleFollowManual:', error);
        showNotification('Terjadi kesalahan saat follow/unfollow!', 'error');
      }
    }
    
    function updateFollowButtonState(isFollowing) {
      const followButton = document.getElementById('followButton');
      const followButtonText = document.getElementById('followButtonText');
      
      if (!followButton || !followButtonText) return;
      
      if (isFollowing) {
        followButtonText.textContent = 'Following';
        followButton.style.backgroundColor = '#10b981';
        followButton.style.color = 'white !important';
        followButtonText.style.color = 'white !important';
        followButton.onmouseover = function() { this.style.backgroundColor = '#059669'; this.style.color = 'white !important'; };
        followButton.onmouseout = function() { this.style.backgroundColor = '#10b981'; this.style.color = 'white !important'; };
        followButton.title = 'Unfollow User';
      } else {
        followButtonText.textContent = 'Follow';
        followButton.style.backgroundColor = '#38bdf8';
        followButton.style.color = 'white !important';
        followButtonText.style.color = 'white !important';
        followButton.onmouseover = function() { this.style.backgroundColor = '#0ea5e9'; this.style.color = 'white !important'; };
        followButton.onmouseout = function() { this.style.backgroundColor = '#38bdf8'; this.style.color = 'white !important'; };
        followButton.title = 'Follow User';
      }
    }
    
    async function loadUserStats(userId) {
      try {
        if (!userId) return;
        
        // Try to use database function first, fallback to manual approach
        try {
          const { data, error } = await supabase.rpc('get_user_stats', {
            user_uuid: userId
          });
          
          if (error) {
            console.warn('Database function not available, using manual approach:', error);
            await loadUserStatsManual(userId);
            return;
          }
          
          if (data && data.length > 0) {
            const stats = data[0];
            updateStatsUI(stats.posts_count || 0, stats.followers_count || 0, stats.following_count || 0);
          }
          
        } catch (rpcError) {
          console.warn('RPC function failed, using manual approach:', rpcError);
          await loadUserStatsManual(userId);
        }
        
      } catch (error) {
        console.error('Error in loadUserStats:', error);
      }
    }
    
    // Manual stats loading (fallback)
    async function loadUserStatsManual(userId) {
      try {
        // Get posts count
        const { count: postsCount } = await supabase
          .from('posts')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', userId);
        
        // Get followers count
        const { count: followersCount } = await supabase
          .from('user_follows')
          .select('*', { count: 'exact', head: true })
          .eq('following_id', userId);
        
        // Get following count
        const { count: followingCount } = await supabase
          .from('user_follows')
          .select('*', { count: 'exact', head: true })
          .eq('follower_id', userId);
        
        updateStatsUI(postsCount || 0, followersCount || 0, followingCount || 0);
        
      } catch (error) {
        console.error('Error in loadUserStatsManual:', error);
      }
    }
    
    function updateStatsUI(postsCount, followersCount, followingCount) {
      const postsCountEl = document.getElementById('postsCount');
      const followersCountEl = document.getElementById('followersCount');
      const followingCountEl = document.getElementById('followingCount');
      
      if (postsCountEl) postsCountEl.textContent = postsCount;
      if (followersCountEl) followersCountEl.textContent = followersCount;
      if (followingCountEl) followingCountEl.textContent = followingCount;
    }
    
    async function checkFollowStatus() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const viewingUserId = urlParams.get('user');
        const currentUserId = currentUser ? currentUser.id : null;
        
        // Handle button visibility based on profile ownership
          const followButton = document.getElementById('followButton');
        const editProfileButton = document.getElementById('editProfileButton');
        const reportButton = document.getElementById('reportButton');
        
        if (!currentUserId || !viewingUserId || viewingUserId === currentUserId) {
          // Viewing own profile - hide follow and report buttons, show edit button
          if (followButton) {
            followButton.style.display = 'none';
          }
          if (editProfileButton) {
            editProfileButton.style.display = 'flex';
          }
          if (reportButton) {
            reportButton.style.display = 'none';
          }
          return;
        } else {
          // Viewing other user's profile - show follow and report buttons, hide edit button
          if (followButton) {
            followButton.style.display = 'flex';
          }
          if (editProfileButton) {
            editProfileButton.style.display = 'none';
          }
          if (reportButton) {
            reportButton.style.display = 'flex';
          }
        }
        
        // Try to use database function first, fallback to manual approach
        try {
          const { data, error } = await supabase.rpc('is_following', {
            follower_uuid: currentUserId,
            following_uuid: viewingUserId
          });
          
          if (error) {
            console.warn('Database function not available, using manual approach:', error);
            await checkFollowStatusManual(currentUserId, viewingUserId);
            return;
          }
          
          // Update button state
          updateFollowButtonState(data);
          
        } catch (rpcError) {
          console.warn('RPC function failed, using manual approach:', rpcError);
          await checkFollowStatusManual(currentUserId, viewingUserId);
        }
        
      } catch (error) {
        console.error('Error in checkFollowStatus:', error);
      }
    }
    
    // Manual follow status check (fallback)
    async function checkFollowStatusManual(currentUserId, viewingUserId) {
      try {
        const { data, error } = await supabase
          .from('user_follows')
          .select('id')
          .eq('follower_id', currentUserId)
          .eq('following_id', viewingUserId)
          .single();
        
        if (error && error.code !== 'PGRST116') {
          console.error('Error checking follow status manually:', error);
          return;
        }
        
        const isFollowing = !!data;
        updateFollowButtonState(isFollowing);
        
      } catch (error) {
        console.error('Error in checkFollowStatusManual:', error);
      }
    }
    
    // Modal functions for followers and following
    function showPostsModal() {
      // For now, just scroll to posts section
      const postsSection = document.querySelector('.posts-section');
      if (postsSection) {
        postsSection.scrollIntoView({ behavior: 'smooth' });
      }
    }
    
    async function showFollowersModal() {
      try {
        const viewingUserId = localStorage.getItem('speakup_viewing_user_id');
        const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
        
        if (!targetUserId) return;
        
        // Get followers list
        const { data: followers, error } = await supabase
          .from('user_follows')
          .select(`
            follower_id,
            created_at,
            profiles!user_follows_follower_id_fkey (
              id,
              username,
              display_name,
              avatar_url
            )
          `)
          .eq('following_id', targetUserId)
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading followers:', error);
          showNotification('Gagal memuat daftar followers!', 'error');
          return;
        }
        
        // Show modal with followers list
        showUserListModal('Followers', followers || []);
        
      } catch (error) {
        console.error('Error in showFollowersModal:', error);
        showNotification('Gagal memuat daftar followers!', 'error');
      }
    }
    
    async function showFollowingModal() {
      try {
        const viewingUserId = localStorage.getItem('speakup_viewing_user_id');
        const targetUserId = viewingUserId || (currentUser ? currentUser.id : null);
        
        if (!targetUserId) return;
        
        // Get following list
        const { data: following, error } = await supabase
          .from('user_follows')
          .select(`
            following_id,
            created_at,
            profiles!user_follows_following_id_fkey (
              id,
              username,
              display_name,
              avatar_url
            )
          `)
          .eq('follower_id', targetUserId)
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading following:', error);
          showNotification('Gagal memuat daftar following!', 'error');
          return;
        }
        
        // Show modal with following list
        showUserListModal('Following', following || []);
        
      } catch (error) {
        console.error('Error in showFollowingModal:', error);
        showNotification('Gagal memuat daftar following!', 'error');
      }
    }
    
    function showUserListModal(title, users) {
      // Create modal HTML
      const modalHTML = `
        <div id="userListModal" class="modal" style="display: flex;">
          <div class="box" style="max-width: 500px; max-height: 600px; overflow-y: auto;">
            <div class="head">
              <strong>${title}</strong>
              <button onclick="closeUserListModal()" class="btn ghost" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
            </div>
            <div id="userListContent" style="padding: 16px 0;">
              ${users.length === 0 ? 
                `<p style="text-align: center; color: #6b7280; padding: 20px;">Belum ada ${title.toLowerCase()}.</p>` :
                users.map(user => {
                  const profile = user.profiles || {};
                  return `
                    <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                      <div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; margin-right: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${profile.avatar_url ? 
                          `<img src="${profile.avatar_url}" alt="${profile.display_name || profile.username}" style="width: 100%; height: 100%; object-fit: cover;">` :
                          `<span style="color: #6b7280; font-weight: 600;">${(profile.display_name || profile.username || 'U').charAt(0).toUpperCase()}</span>`
                        }
                      </div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937;">${profile.display_name || profile.username || 'Unknown User'}</div>
                        <div style="font-size: 14px; color: #6b7280;">@${profile.username || 'unknown'}</div>
                      </div>
                      <button onclick="viewUserProfile('${profile.id}')" style="
                        background: #38bdf8; 
                        color: white !important; 
                        border: none; 
                        padding: 6px 12px; 
                        border-radius: 16px; 
                        font-size: 12px; 
                        cursor: pointer;
                        transition: background-color 0.2s;
                      " onmouseover="this.style.backgroundColor='#0ea5e9'; this.style.color='white !important';" onmouseout="this.style.backgroundColor='#38bdf8'; this.style.color='white !important';">
                        View Profile
                      </button>
                    </div>
                  `;
                }).join('')
              }
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Add click outside to close
      document.getElementById('userListModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeUserListModal();
        }
      });
    }
    
    function closeUserListModal() {
      const modal = document.getElementById('userListModal');
      if (modal) {
        modal.remove();
      }
    }
    
    function viewUserProfile(userId) {
      // Navigate to user profile with URL parameter
      const url = new URL('profile-desktop.html', window.location.origin);
      url.searchParams.set('user', userId);
      
      // Close modal
      closeUserListModal();
      
      // Navigate to user's profile
      window.location.href = url.toString();
    }


    // Removed Speak! button logic on profile page per requirement

    // Toggle custom category input
    function toggleCustomCategory() {
      const categorySelect = document.getElementById('categorySelect');
      const customInput = document.getElementById('customCategoryInput');
      
      if (categorySelect && customInput) {
        if (categorySelect.value === 'other') {
          customInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
          // Clear custom category input when not needed
          const customInputField = customInput.querySelector('input');
          if (customInputField) {
            customInputField.value = '';
          }
        }
      }
    }

    // Listen to save/unsave events from other pages/contexts
    window.addEventListener('postSaveChanged', () => {
      // Check if we're currently on the archive tab
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab && activeTab.textContent.trim() === 'Archive') {
        console.log('postSaveChanged received -> refreshing archive list');
        // Add small delay to prevent rapid successive calls
        setTimeout(() => {
          loadSavedPosts();
        }, 100);
      }
    });
  </script>

  <!-- Create Post Modal -->
  <div id="createModal" class="modal" role="dialog">
    <div class="box">
      <div class="head">
        <strong>Buat Post</strong>
        <button id="closeCreate" class="btn ghost">×</button>
      </div>
      <form id="createForm">
        <div class="mt-12">
          <label>Konten</label>
          <div style="position: relative;">
            <textarea name="content" id="contentText" rows="6" maxlength="5000" required placeholder="Speak! Bagikan pengalamanmu..." style="
              width: 100%;
              min-height: 120px;
              padding: 12px 40px 12px 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              resize: vertical;
              font-family: inherit;
              font-size: 14px;
              outline: none;
              transition: border-color 0.2s;
            " onfocus="this.style.borderColor='#38bdf8'" onblur="this.style.borderColor='#d1d5db'"></textarea>
            <button type="button" onclick="toggleEmojiPicker()" style="
              position: absolute;
              right: 8px;
              bottom: 8px;
              background: none;
              border: none;
              font-size: 18px;
              cursor: pointer;
              padding: 4px;
              border-radius: 4px;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'" title="Pilih Emoji">
              😊
            </button>
            
            <!-- Emoji Picker -->
            <div id="emojiPicker" style="
              position: absolute;
              bottom: 10px;
              left: 10px;
              right: 50px;
              background: #ffffff;
              border: 2px solid #38bdf8;
              border-radius: 8px;
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
              padding: 12px;
              z-index: 10;
              display: none;
            ">
              <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                <button type="button" onclick="insertEmoji('😊')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😊</button>
                <button type="button" onclick="insertEmoji('😢')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😢</button>
                <button type="button" onclick="insertEmoji('😡')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😡</button>
                <button type="button" onclick="insertEmoji('😍')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😍</button>
                <button type="button" onclick="insertEmoji('🤔')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🤔</button>
                <button type="button" onclick="insertEmoji('😮')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😮</button>
                <button type="button" onclick="insertEmoji('😭')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😭</button>
                <button type="button" onclick="insertEmoji('😤')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😤</button>
                <button type="button" onclick="insertEmoji('🙏')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🙏</button>
                <button type="button" onclick="insertEmoji('❤️')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">❤️</button>
                <button type="button" onclick="insertEmoji('👍')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">👍</button>
                <button type="button" onclick="insertEmoji('👎')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">👎</button>
                <button type="button" onclick="insertEmoji('🔥')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🔥</button>
                <button type="button" onclick="insertEmoji('💪')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">💪</button>
                <button type="button" onclick="insertEmoji('🎉')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🎉</button>
                <button type="button" onclick="insertEmoji('✨')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">✨</button>
                <button type="button" onclick="insertEmoji('😀')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😀</button>
                <button type="button" onclick="insertEmoji('😃')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😃</button>
                <button type="button" onclick="insertEmoji('😄')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😄</button>
                <button type="button" onclick="insertEmoji('😁')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😁</button>
                <button type="button" onclick="insertEmoji('😆')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😆</button>
                <button type="button" onclick="insertEmoji('😅')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😅</button>
                <button type="button" onclick="insertEmoji('🤣')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🤣</button>
                <button type="button" onclick="insertEmoji('😂')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😂</button>
                <button type="button" onclick="insertEmoji('🙂')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🙂</button>
                <button type="button" onclick="insertEmoji('🙃')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🙃</button>
                <button type="button" onclick="insertEmoji('😉')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😉</button>
                <button type="button" onclick="insertEmoji('😇')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😇</button>
                <button type="button" onclick="insertEmoji('🥰')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🥰</button>
                <button type="button" onclick="insertEmoji('🤩')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">🤩</button>
                <button type="button" onclick="insertEmoji('😘')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😘</button>
                <button type="button" onclick="insertEmoji('😋')" style="background: none; border: none; font-size: 20px; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">😋</button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-12">
          <label>Upload Gambar/Foto (Opsional)</label>
          <div class="file-upload-container">
            <input type="file" id="imageUpload" name="image" accept="image/*">
            <button type="button" class="btn ghost upload-btn" onclick="document.getElementById('imageUpload').click()">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
              Klik untuk Upload Gambar
            </button>
            <div id="imagePreview" class="image-preview">
              <img id="previewImg">
              <button type="button" onclick="removeImage()" class="btn ghost remove-btn">Hapus Gambar</button>
            </div>
          </div>
        </div>
        <div class="mt-12">
          <label>Kategori (Opsional)</label>
          <select name="category" id="categorySelect" onchange="toggleCustomCategory()">
            <option value="">Pilih kategori...</option>
            <option value="bullying">Bullying</option>
            <option value="mental_health">Mental Health</option>
            <option value="workplace">Workplace</option>
            <option value="petisi">Petisi</option>
            <option value="other">Other</option>
          </select>
          <div id="customCategoryInput" style="display: none; margin-top: 8px;">
            <input type="text" name="custom_category" placeholder="Tuliskan topik Anda..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
          </div>
        </div>
        <div class="mt-12">
          <label><input type="checkbox" name="want_solution" value="true" /> Saya ingin solusi</label>
        </div>
        <div class="actions-row">
          <button type="submit" class="btn primary">Kirim</button>
          <button type="button" id="closeCreate2" class="btn ghost" onclick="document.getElementById('createModal').classList.remove('open')">Batal</button>
        </div>
        
        <!-- Emoji Picker -->
        <div id="emojiPicker" class="emoji-picker" style="display: none;">
          <div class="emoji-grid">
            <button type="button" class="emoji-btn" onclick="insertEmoji('😊')">😊</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😢')">😢</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😡')">😡</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😍')">😍</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🤔')">🤔</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😮')">😮</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😭')">😭</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😤')">😤</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🙏')">🙏</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('❤️')">❤️</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('👍')">👍</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('👎')">👎</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🔥')">🔥</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('💪')">💪</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🎉')">🎉</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('✨')">✨</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/js/app.js"></script>
  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config/supabase-config.js"></script>
  <script src="config/supabase-bootstrap.js"></script>
  
  <script>
    // =============================
    // Helper Functions
    // =============================
    
    // Get current user's name from database
    async function getCurrentUserName() {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          return 'You';
        }
        
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('full_name')
          .eq('id', user.id)
          .single();
        
        if (profileError || !profile) {
          return user.user_metadata?.full_name || 'You';
        }
        
        return profile.full_name || 'You';
      } catch (error) {
        console.warn('Error getting current user name:', error);
        return 'You';
      }
    }
    
    // =============================
    // Reply and Mention System
    // =============================
    
    // Global variables for reply system
    let currentReplyToCommentId = null;
    let currentReplyToUsername = null;
    
    // Function to start replying to a comment
    function startReply(postId, commentId, username) {
      console.log('startReply called with:', postId, commentId, username);
      currentReplyToCommentId = commentId;
      currentReplyToUsername = username;
      
      // Update comment input placeholder
      const commentInput = document.querySelector(`#comments-${postId} input`);
      if (commentInput) {
        commentInput.placeholder = `Balas ke @${username}...`;
        commentInput.focus();
      }
      
      // Show reply indicator
      showReplyIndicator(username);
    }
    
    // Function to cancel reply
    function cancelReply() {
      currentReplyToCommentId = null;
      currentReplyToUsername = null;
      
      // Reset comment input placeholder
      const commentInput = document.querySelector(`#comments-${currentCommentPostId} input`);
      if (commentInput) {
        commentInput.placeholder = 'Tulis komentar...';
      }
      
      // Hide reply indicator
      hideReplyIndicator();
    }
    
    // Function to show reply indicator
    function showReplyIndicator(username) {
      let indicator = document.getElementById('reply-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'reply-indicator';
        indicator.style.cssText = `
          background: #f3f4f6;
          border: 1px solid #d1d5db;
          border-radius: 8px;
          padding: 8px 12px;
          margin-bottom: 8px;
          font-size: 12px;
          color: #374151;
          display: flex;
          align-items: center;
          justify-content: space-between;
        `;
        
        const commentContainer = document.querySelector(`#comments-${currentCommentPostId}`);
        if (commentContainer) {
          const commentForm = commentContainer.querySelector('form');
          if (commentForm) {
            commentForm.parentNode.insertBefore(indicator, commentForm);
          }
        }
      }
      
      indicator.innerHTML = `
        <span>Membalas ke <strong>@${username}</strong></span>
        <button onclick="cancelReply()" style="background: none; border: none; color: #6b7280; cursor: pointer; font-size: 14px;">×</button>
      `;
      indicator.style.display = 'flex';
    }
    
    // Function to hide reply indicator
    function hideReplyIndicator() {
      const indicator = document.getElementById('reply-indicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }
    
    // Function to extract mentions from text
    function extractMentions(text) {
      const mentionRegex = /@([a-zA-Z0-9_]+)/g;
      const mentions = [];
      let match;
      while ((match = mentionRegex.exec(text)) !== null) {
        mentions.push(match[1]);
      }
      return [...new Set(mentions)]; // Remove duplicates
    }
    
    // Function to get user ID from username
    async function getUserIdFromUsername(username) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('id')
          .eq('username', username)
          .single();
        
        if (error || !data) return null;
        return data.id;
      } catch (error) {
        console.warn('Error getting user ID from username:', error);
        return null;
      }
    }
    
    // Function to get username from user ID
    async function getUsernameFromUserId(userId) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('username, full_name')
          .eq('id', userId)
          .single();
        
        if (error || !data) return null;
        return data.username || data.full_name;
      } catch (error) {
        console.warn('Error getting username from user ID:', error);
        return null;
      }
    }
    
    // Function to highlight mentions in comment content
    function highlightMentions(content) {
      return content.replace(/@([a-zA-Z0-9_]+)/g, '<span style="color: #3b82f6; font-weight: 600;">@$1</span>');
    }
    
    // Function to get replies for a comment
    async function getCommentReplies(commentId) {
      try {
        const { data: replies, error } = await supabase
          .from('post_comments')
          .select('id, user_id, content, identity, created_at, mentioned_users')
          .eq('parent_comment_id', commentId)
          .order('created_at', { ascending: true })
          .limit(10);
        
        if (error || !replies || replies.length === 0) {
          return '';
        }
        
        const replyItems = await Promise.all(replies.map(async reply => {
          const when = getTimeAgo(new Date(reply.created_at));
          
          let displayName = 'Pengguna';
          let avatarHtml = '<div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">U</div>';
          let verifiedBadge = '';
          
          if (reply.identity === 'anonymous') {
            displayName = 'Anonim';
            avatarHtml = '<div style="width:20px;height:20px;border-radius:9999px;background:#6b7280;color:white;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">A</div>';
          } else {
            try {
              const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', reply.user_id)
                .single();
              
              if (!error && profile) {
                displayName = profile.full_name || 'Pengguna';
                if (profile.is_verified === true) {
                  verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; margin-left: 4px;" title="Verified Account">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                      <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>`;
                }
                if (profile.avatar_url && profile.avatar_url !== 'NULL') {
                  avatarHtml = `<img src="${profile.avatar_url}" alt="${displayName}" style="width:20px;height:20px;border-radius:9999px;object-fit:cover;">`;
                } else {
                  avatarHtml = `<div style="width:20px;height:20px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">${displayName[0] || 'U'}</div>`;
                }
              }
            } catch (error) {
              console.warn('Error loading profile for reply:', error);
            }
          }
          
          return `<div class="reply-item" style="display:flex;gap:6px;align-items:flex-start;margin:4px 0;">
                    ${avatarHtml}
                    <div class="reply-body" style="flex:1;min-width:0;">
                      <div style="font-size:11px;color:#374151;font-weight:600;display:flex;align-items:center;margin-bottom:2px;">
                        ${reply.identity === 'anonymous' 
                          ? `<span style="color: #374151; cursor: default;">${displayName}</span>`
                          : `<span onclick="navigateToUserProfile('${reply.user_id}')" style="cursor: pointer; color: #374151; text-decoration: none;" onmouseover="this.style.color='#1f2937'; this.style.textDecoration='underline';" onmouseout="this.style.color='#374151'; this.style.textDecoration='none';">${displayName}</span>`
                        }${verifiedBadge} <span style="color:#9ca3af;font-weight:400;">• ${when}</span>
                      </div>
                      <div style="font-size:12px;color:#374151;line-height:1.4;word-wrap:break-word;">${highlightMentions(escapeHtml(reply.content))}</div>
                    </div>
                  </div>`;
        }));
        
        return replyItems.join('');
      } catch (error) {
        console.warn('Error getting comment replies:', error);
        return '';
      }
    }

    // =============================
    // Comment Functions (from timeline)
    // =============================
    
    // Load interaction states (like, save, pin) for current user
    async function loadInteractionStates(postId) {
      try {
        console.log('Loading interaction states for post:', postId);
        
        // Check if user is authenticated
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
          console.log('No authenticated user - skipping interaction states');
          return;
        }
        
        console.log('Loading interaction states for user:', user.id);
        
        // Load like status
        try {
          const { data: likeData, error: likeError } = await supabase
            .from('post_likes')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (!likeError && likeData) {
            console.log('User has liked post:', postId);
            updateLikeButton(postId, true);
          } else {
            console.log('User has not liked post:', postId);
            updateLikeButton(postId, false);
          }
        } catch (likeError) {
          console.warn('Error loading like status:', likeError);
        }
        
        // Load save status
        try {
          const { data: saveData, error: saveError } = await supabase
            .from('post_saves')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (!saveError && saveData) {
            console.log('User has saved post:', postId);
            updateSaveButton(postId, true);
          } else {
            console.log('User has not saved post:', postId);
            updateSaveButton(postId, false);
          }
        } catch (saveError) {
          console.warn('Error loading save status:', saveError);
        }
        
        // Load pin status (check if post is pinned by current user)
        try {
          const { data: pinData, error: pinError } = await supabase
            .from('post_pins')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (!pinError && pinData) {
            console.log('User has pinned post:', postId);
            updateFollowButton(postId, true);
          } else {
            console.log('User has not pinned post:', postId);
            updateFollowButton(postId, false);
          }
        } catch (pinError) {
          console.warn('Error loading pin status:', pinError);
        }
        
      } catch (error) {
        console.error('Error loading interaction states:', error);
      }
    }
    
    // Toggle comments visibility
    function toggleComments(postId) {
      const container = document.getElementById(`comments-${postId}`);
      const btn = document.getElementById(`comments-toggle-${postId}`);
      if (!container || !btn) return;
      
      const isHidden = container.style.display === 'none';
      if (isHidden) {
        container.style.display = 'block';
        btn.textContent = 'Sembunyikan komentar';
        renderCommentsForPost(postId);
      } else {
        container.style.display = 'none';
        btn.textContent = 'Lihat komentar.....';
      }
    }
    
    // Render comments for a post
    async function renderCommentsForPost(postId) {
      const container = document.getElementById(`comments-${postId}`);
      if (!container) return;
      
      try {
        container.innerHTML = '<div style="font-size:12px;color:#6b7280;">Memuat komentar...</div>';
        if (!supabase) { 
          container.innerHTML = '<div style="font-size:12px;color:#ef4444;">Supabase tidak tersedia. Silakan refresh halaman.</div>'; 
          return; 
        }
        
        const { data: rows, error } = await supabase
          .from('post_comments')
          .select('id, user_id, content, identity, created_at, parent_comment_id, mentioned_users')
          .eq('post_id', postId)
          .is('parent_comment_id', null) // Only get top-level comments
          .order('created_at', { ascending: true })
          .limit(20);
          
        if (error) { 
          console.error('Error fetching comments:', error);
          container.innerHTML = '<div style="font-size:12px;color:#ef4444;">Gagal memuat komentar. Silakan coba lagi.</div>'; 
          return; 
        }
        if (!rows || rows.length === 0) { 
          container.innerHTML = '<div style="font-size:12px;color:#6b7280;">Belum ada komentar.</div>'; 
          return; 
        }
        
        // identify permissions
        let currentUserId = null;
        try { const { data: { user } } = await supabase.auth.getUser(); currentUserId = user?.id || null; } catch(_) {}
        const postOwnerId = container.getAttribute('data-owner-id');
        
        const items = await Promise.all(rows.map(async c => {
          const when = getTimeAgo(new Date(c.created_at));
          
          // Handle different identity types for comments
          let displayName = 'Pengguna';
          let username = '';
          let avatarHtml = '<div style="width:24px;height:24px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">U</div>';
          let verifiedBadge = '';
          
          if (c.identity === 'anonymous') {
            // Anonymous comment - hide all identity information
            displayName = 'Anonim';
            avatarHtml = '<div style="width:24px;height:24px;border-radius:9999px;background:#6b7280;color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">A</div>';
          } else {
            // Get user profile for non-anonymous comment author
            try {
              const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', c.user_id)
                .single();
              
              if (!error && profile) {
                displayName = profile.full_name || 'Pengguna';
                username = profile.username || profile.full_name || 'user';
                
                // Check if user is verified
                if (profile.is_verified === true) {
                  verifiedBadge = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; margin-left: 4px;" title="Verified Account">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <!-- Simple blue circle -->
                      <circle cx="12" cy="12" r="10" fill="#38bdf8"/>
                      <!-- White checkmark in center -->
                      <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>`;
                }
                
                // Create avatar based on profile
                if (profile.avatar_url && profile.avatar_url !== 'NULL') {
                  avatarHtml = `<img src="${profile.avatar_url}" alt="${displayName}" style="width:24px;height:24px;border-radius:9999px;object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="width:24px;height:24px;border-radius:9999px;background:#e5e7eb;color:#374151;display:none;align-items:center;justify-content:center;font-size:12px;font-weight:700;">${displayName[0] || 'U'}</div>`;
                } else {
                  avatarHtml = `<div style="width:24px;height:24px;border-radius:9999px;background:#e5e7eb;color:#374151;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">${displayName[0] || 'U'}</div>`;
                }
              }
            } catch (error) {
              console.warn('Could not fetch comment user profile:', error);
            }
          }
          
          const canDelete = (currentUserId && (currentUserId === c.user_id || (postOwnerId && currentUserId === postOwnerId)));
          const delBtn = canDelete ? `<button onclick=\"deleteComment('${c.id}','${postId}')\" style=\"background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer;\">Hapus</button>` : '';
          
          // Get replies for this comment
          const replies = await getCommentReplies(c.id);
          
          // Define replyUsername for the reply button
          const replyUsername = c.identity === 'anonymous' ? 'Anonim' : username;
          
          return `<div class=\"comment-item\" style=\"display:flex;gap:8px;align-items:flex-start;margin:6px 0;\">
                    ${avatarHtml}
                    <div class=\"comment-body\" style=\"flex:1;min-width:0;\">
                      <div style=\"display:flex;justify-content:space-between;gap:8px;align-items:center;\">
                        <div style=\"font-size:12px;color:#374151;font-weight:600;display:flex;align-items:center;\">
                            ${c.identity === 'anonymous' 
                                ? `<span style=\"color: #374151; cursor: default;\" title=\"User anonim - profil tidak dapat diakses\">${displayName}</span>`
                                : `<span onclick=\"navigateToUserProfile('${c.user_id}')\" style=\"cursor: pointer; color: #374151; text-decoration: none;\" onmouseover=\"this.style.color='#1f2937'; this.style.textDecoration='underline';\" onmouseout=\"this.style.color='#374151'; this.style.textDecoration='none';\">${displayName}</span>`
                            }${verifiedBadge} <span style=\"color:#9ca3af;font-weight:400;\">• ${when}</span>
                        </div>
                        ${delBtn}
                      </div>
                      <div style=\"font-size:13px;color:#374151;line-height:1.5;word-wrap:break-word;\">${highlightMentions(escapeHtml(c.content))}</div>
                      <div style=\"margin-top:4px;display:flex;gap:12px;align-items:center;\">
                        <button onclick=\"startReply('${postId}', '${c.id}', '${replyUsername}')\" style=\"background:none;border:none;color:#6b7280;font-size:12px;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;\">
                          <svg width=\"12\" height=\"12\" fill=\"currentColor\" viewBox=\"0 0 20 20\">
                            <path fill-rule=\"evenodd\" d=\"M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z\" clip-rule=\"evenodd\"/>
                          </svg>
                          Balas
                        </button>
                        ${replies.length > 0 ? `<span style=\"color:#6b7280;font-size:12px;\">${replies.split('reply-item').length - 1} balasan</span>` : ''}
                      </div>
                      ${replies.length > 0 ? `<div class=\"replies\" style=\"margin-left:16px;margin-top:8px;border-left:2px solid #e5e7eb;padding-left:12px;\">${replies}</div>` : ''}
                    </div>
                  </div>`;
        }));
        
        // Add comment form
        const commentForm = `
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
            <form onsubmit="submitComment(event, '${postId}')" style="display: flex; gap: 8px; align-items: flex-start;">
              <input type="text" placeholder="Tulis komentar..." required style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 20px; font-size: 14px; outline: none;" onfocus="this.style.borderColor='#38bdf8'" onblur="this.style.borderColor='#d1d5db'">
              <button type="submit" style="padding: 8px 16px; background: #38bdf8; color: white; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; font-weight: 600;">Kirim</button>
            </form>
          </div>
        `;
        
        container.innerHTML = `<div class=\"comments-list\" style=\"background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:8px;\">${items.join('')}</div>${commentForm}`;
      } catch (error) {
        console.error('Error rendering comments:', error);
        container.innerHTML = '<div style="font-size:12px;color:#ef4444;">Gagal memuat komentar. Silakan refresh halaman.</div>';
      }
    }
    
    // Submit comment
    async function submitComment(event, postId) {
      event.preventDefault();
      
      const form = event.target;
      const input = form.querySelector('input');
      const content = input.value.trim();
      
      if (!content) return;
      
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Silakan login terlebih dahulu untuk berkomentar!', 'error');
          return;
        }
        
        // Get user profile to determine identity
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('identity')
          .eq('id', user.id)
          .single();
        
        const identity = profile?.identity || 'public';
        
        // Extract mentions from comment text
        const mentionedUsernames = extractMentions(content);
        const mentionedUserIds = [];
        
        // Get user IDs for mentioned usernames
        for (const username of mentionedUsernames) {
          const userId = await getUserIdFromUsername(username);
          if (userId) {
            mentionedUserIds.push(userId);
          }
        }
        
        const { error } = await supabase
          .from('post_comments')
          .insert({
            post_id: postId,
            user_id: user.id,
            content: content,
            identity: identity,
            parent_comment_id: currentReplyToCommentId || null,
            mentioned_users: mentionedUserIds.length > 0 ? mentionedUserIds : null
          });
        
        if (error) {
          console.error('Error submitting comment:', error);
          showNotification('Gagal mengirim komentar', 'error');
          return;
        }
        
        // Clear input
        input.value = '';
        
        // Reset reply state
        cancelReply();
        
        // Refresh comments
        renderCommentsForPost(postId);
        
        // Update comment count
        updateCommentCount(postId);
        
        showNotification('Komentar berhasil dikirim', 'success');
        
      } catch (error) {
        console.error('Error in submitComment:', error);
        showNotification('Terjadi kesalahan saat mengirim komentar', 'error');
      }
    }
    
    // Delete comment
    async function deleteComment(commentId, postId) {
      if (!confirm('Yakin ingin menghapus komentar ini?')) return;
      
      try {
        const { error } = await supabase
          .from('post_comments')
          .delete()
          .eq('id', commentId);
        
        if (error) {
          console.error('Error deleting comment:', error);
          showNotification('Gagal menghapus komentar', 'error');
          return;
        }
        
        // Refresh comments
        renderCommentsForPost(postId);
        
        // Update comment count
        updateCommentCount(postId);
        
        showNotification('Komentar berhasil dihapus', 'success');
        
      } catch (error) {
        console.error('Error in deleteComment:', error);
        showNotification('Terjadi kesalahan saat menghapus komentar', 'error');
      }
    }
    
    // Update comment count
    async function updateCommentCount(postId) {
      try {
        const { count, error } = await supabase
          .from('post_comments')
          .select('*', { count: 'exact', head: true })
          .eq('post_id', postId);
        
        if (!error) {
          const commentBtn = document.querySelector(`button[onclick="commentPost('${postId}')"] .count`);
          if (commentBtn) {
            commentBtn.textContent = count || 0;
          }
        }
      } catch (error) {
        console.warn('Error updating comment count:', error);
      }
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Get time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'baru saja';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}j`;
      if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}h`;
      if (diffInSeconds < 31536000) return `${Math.floor(diffInSeconds / 2592000)}b`;
      return `${Math.floor(diffInSeconds / 31536000)}t`;
    }
  </script>
  </body>
</html>

